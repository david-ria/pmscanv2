import{j as e}from"./query-BewfWFH7.js";import{r as l}from"./vendor-CRCfYjC_.js";import{c as L,b as k,X as Re,a as F,h as Ie,j as De,k as Ae,m as Oe,d as h,i as G,l as K,T as ee,e as R,w as Y,B as M}from"./index-DnKT6hDb.js";import{w as Pe,G as Te,x as We,y as te,E as Fe,O as se,T as ne,B as ae,b as Ue,P as U,k as _e,af as re}from"./ui-core-CibF-ClQ.js";import{a as qe}from"./utils-EL5wpLGY.js";import{D as _,a as q,b as $,c as A,L as oe,S as $e,d as W}from"./dropdown-menu-BEnxxNd8.js";import{C as Ve,a as ze}from"./card-CRF2Wp6a.js";import{B as I,M as H}from"./badge-D3qJDj1M.js";import{u as Ge}from"./useGroupSettings-DQBWUHal.js";import{u as S}from"./i18n-DZz6YkIP.js";import{U as Ke}from"./users-wub0dhV2.js";import{U as V}from"./user-BOWvM0oD.js";import{S as Ye}from"./switch-DiHL1fOt.js";import{C as He}from"./crown-zbULqoOE.js";import{j as Je}from"./theme-D-6-9UvQ.js";import{u as Xe}from"./useUserRole-B8Vd-TTd.js";import{a as Qe,b as Ze}from"./useAutoContext-RU6mHgIo.js";import{p as et,g as tt,r as J,c as st}from"./useMissionSaver-CXd3xg0u.js";import{u as nt}from"./UnifiedDataProvider-D_wn4Ile.js";import{u as at,a as rt}from"./useLocationEnrichmentSettings-CHsjhA43.js";import{u as ot}from"./useSubscription-DJEgHQrc.js";import{useNavigate as ie}from"./router-D6wdMmGF.js";import{B as it}from"./brain-BnPjMeLS.js";import{B as ct}from"./bluetooth-CRv2GwO8.js";import{C as ce,F as lt}from"./file-x-Cfc0Kpmj.js";import{P as dt,a as ut,b as mt}from"./popover-C65wazzN.js";import{toast as v}from"./notifications-6vUXhpBr.js";import{W as X}from"./wifi-off-flOeYF_3.js";import{L as Q}from"./loader-circle-CMvZ_kLu.js";import{R as Z}from"./rotate-ccw-oD7EDUkY.js";import"./supabase--OITQzG1.js";import"./ui-advanced-6HbTI6G8.js";import"./chevron-right-DkkaQXkL.js";import"./check-BbmLrf-d.js";import"./circle-BxKWKjZR.js";import"./groupConfigs-C_MEEc6R.js";import"./ui-forms-BvHfx7SG.js";import"./client-zGYq1VIw.js";import"./supabaseSafeWrapper-C24d6oy5.js";import"./bluetooth-BEoGU70i.js";import"./timeFormat-CCn9v1Tp.js";import"./useGroups-DlFUXECJ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=L("CloudOff",[["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.307-.193",key:"yfwify"}],["path",{d:"M21.532 16.5A4.5 4.5 0 0 0 17.5 10h-1.79A7.008 7.008 0 0 0 10 5.07",key:"jlfiyv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=L("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=L("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=L("Languages",[["path",{d:"m5 8 6 6",key:"1wu5hv"}],["path",{d:"m4 14 6-6 2-3",key:"1k1g8d"}],["path",{d:"M2 5h12",key:"or177f"}],["path",{d:"M7 2h1",key:"1t2jsx"}],["path",{d:"m22 22-5-10-5 10",key:"don7ne"}],["path",{d:"M14 18h6",key:"1m8k6r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=L("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xt=L("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=L("SunMoon",[["path",{d:"M12 8a2.83 2.83 0 0 0 4 4 4 4 0 1 1-4-4",key:"1fu5g2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.9 4.9 1.4 1.4",key:"b9915j"}],["path",{d:"m17.7 17.7 1.4 1.4",key:"qc3ed3"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.3 17.7-1.4 1.4",key:"5gca6"}],["path",{d:"m19.1 4.9-1.4 1.4",key:"wpu9u6"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=L("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),bt=Pe,vt=Te,wt=We,de=l.forwardRef(({className:n,...a},s)=>e.jsx(se,{className:k("fixed inset-0 z-50 bg-overlay data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",n),...a,ref:s}));de.displayName=se.displayName;const St=qe("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),ue=l.forwardRef(({side:n="right",className:a,children:s,...t},r)=>e.jsxs(wt,{children:[e.jsx(de,{}),e.jsxs(te,{ref:r,className:k(St({side:n}),a),...t,children:[s,e.jsxs(Fe,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));ue.displayName=te.displayName;const jt=l.forwardRef(({className:n,...a},s)=>e.jsx(ne,{ref:s,className:k("text-lg font-semibold text-foreground",n),...a}));jt.displayName=ne.displayName;const Nt=l.forwardRef(({className:n,...a},s)=>e.jsx(ae,{ref:s,className:k("text-sm text-muted-foreground",n),...a}));Nt.displayName=ae.displayName;var z="Avatar",[Ct,Ds]=Ue(z),[Bt,me]=Ct(z),ge=l.forwardRef((n,a)=>{const{__scopeAvatar:s,...t}=n,[r,o]=l.useState("idle");return e.jsx(Bt,{scope:s,imageLoadingStatus:r,onImageLoadingStatusChange:o,children:e.jsx(U.span,{...t,ref:a})})});ge.displayName=z;var fe="AvatarImage",he=l.forwardRef((n,a)=>{const{__scopeAvatar:s,src:t,onLoadingStatusChange:r=()=>{},...o}=n,i=me(fe,s),c=Mt(t,o.referrerPolicy),m=_e(f=>{r(f),i.onImageLoadingStatusChange(f)});return re(()=>{c!=="idle"&&m(c)},[c,m]),c==="loaded"?e.jsx(U.img,{...o,ref:a,src:t}):null});he.displayName=fe;var pe="AvatarFallback",xe=l.forwardRef((n,a)=>{const{__scopeAvatar:s,delayMs:t,...r}=n,o=me(pe,s),[i,c]=l.useState(t===void 0);return l.useEffect(()=>{if(t!==void 0){const m=window.setTimeout(()=>c(!0),t);return()=>window.clearTimeout(m)}},[t]),i&&o.imageLoadingStatus!=="loaded"?e.jsx(U.span,{...r,ref:a}):null});xe.displayName=pe;function Mt(n,a){const[s,t]=l.useState("idle");return re(()=>{if(!n){t("error");return}let r=!0;const o=new window.Image,i=c=>()=>{r&&t(c)};return t("loading"),o.onload=i("loaded"),o.onerror=i("error"),o.src=n,a&&(o.referrerPolicy=a),()=>{r=!1}},[n,a]),s}var ye=ge,ke=he,be=xe;const ve=l.forwardRef(({className:n,...a},s)=>e.jsx(ye,{ref:s,className:k("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",n),...a}));ve.displayName=ye.displayName;const Lt=l.forwardRef(({className:n,...a},s)=>e.jsx(ke,{ref:s,className:k("aspect-square h-full w-full",n),loading:"lazy",...a}));Lt.displayName=ke.displayName;const we=l.forwardRef(({className:n,...a},s)=>e.jsx(be,{ref:s,className:k("flex h-full w-full items-center justify-center rounded-full bg-muted",n),...a}));we.displayName=be.displayName;function Et(){const{user:n}=F(),{t:a}=S(),{isGroupMode:s,activeGroup:t}=Ge();return e.jsx("div",{className:"p-4",children:e.jsx(Ve,{children:e.jsx(ze,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 bg-primary/10 rounded-full flex items-center justify-center",children:s?e.jsx(Ke,{className:"h-5 w-5 text-primary"}):e.jsx(V,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-foreground text-sm",children:n?.email||a("account.user")}),e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:n?.email}),e.jsxs("div",{className:"flex gap-1 mt-1",children:[e.jsx(I,{variant:"secondary",className:"text-xs",children:a("account.connected")}),s&&t&&e.jsx(I,{variant:"outline",className:"text-xs",children:t.name})]})]})]})})})})}function Rt({icon:n,label:a,badge:s,action:t,toggle:r,info:o,isPremiumFeature:i=!1}){const{t:c}=S(),m=()=>{r||t?.()};return e.jsx(Ie,{children:e.jsxs("div",{className:k("flex items-center justify-between px-4 py-4 transition-colors rounded-lg min-h-[48px] touch-manipulation",i?"opacity-50":"hover:bg-accent/50 active:bg-accent/70"),onClick:m,style:{cursor:i?"not-allowed":r?"default":"pointer"},children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(n,{className:k("h-4 w-4 flex-shrink-0",i?"text-muted-foreground/50":"text-muted-foreground")}),e.jsx("span",{className:k("text-sm leading-tight",i?"text-muted-foreground/50":"text-foreground"),children:a}),o&&e.jsxs(De,{children:[e.jsx(Ae,{asChild:!0,children:e.jsx(ht,{className:"h-3 w-3 text-muted-foreground/60 cursor-help"})}),e.jsx(Oe,{children:e.jsx("p",{className:"text-xs",children:o})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s&&!i&&e.jsxs(I,{variant:s==="Premium"?"outline":"secondary",className:k("text-xs flex-shrink-0",s===c("sensors.connected")&&"bg-air-good/10 text-air-good",s==="Premium"&&"text-yellow-700 border-yellow-300 dark:text-yellow-400 dark:border-yellow-600"),children:[s==="Premium"&&e.jsx(He,{className:"h-3 w-3 mr-1"}),s]}),r&&e.jsx(Ye,{checked:r.checked,onCheckedChange:r.onCheckedChange,disabled:i})]})]})})}const Se=()=>{const{i18n:n}=S(),a=l.useCallback(r=>{n.changeLanguage(r)},[n]),s=n.language;return{currentLanguage:s,changeLanguage:a,languages:[{code:"fr",name:"FranÃ§ais"},{code:"en",name:"English"},{code:"de",name:"Deutsch"},{code:"ca",name:"CatalÃ "}],isLanguage:r=>s===r}};function It({label:n,badge:a}){const{t:s}=S(),{currentLanguage:t,changeLanguage:r,languages:o}=Se();return e.jsxs(_,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-4 rounded-lg min-h-[48px]",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(le,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm text-foreground leading-tight",children:n})]}),a&&e.jsx(q,{asChild:!0,children:e.jsx("button",{className:"text-xs ml-2 flex-shrink-0 cursor-pointer hover:bg-secondary/80 transition-colors rounded-md px-2 py-1 bg-secondary text-secondary-foreground",children:a})})]}),e.jsx($,{align:"end",className:"w-48",children:o.map(i=>e.jsxs(A,{onClick:()=>r(i.code),className:k("cursor-pointer",t===i.code&&"bg-accent"),children:[e.jsx("span",{className:"text-sm",children:i.name}),t===i.code&&e.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:"âœ“"})]},i.code))})]})}function Dt({title:n,items:a}){const{t:s}=S();return e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-foreground mb-3",children:n}),e.jsx("div",{className:"space-y-1",children:a.map((t,r)=>t.label===s("settingsMenu.language")?e.jsx(It,{label:t.label,badge:t.badge||""},r):e.jsx(Rt,{icon:t.icon,label:t.label,badge:t.badge,action:t.action,toggle:t.toggle,info:t.info,isPremiumFeature:t.isPremiumFeature},r))})]})}function At(){const{t:n}=S();return e.jsxs("div",{className:"p-6 border-b border-border",children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:n("settings.title")}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:n("settings.subtitle")})]})}function Ot(){const{t:n}=S();return e.jsx("div",{className:"p-4 border-t border-border",children:e.jsxs("div",{className:"text-center text-xs text-muted-foreground space-y-1",children:[e.jsx("p",{children:n("settings.appVersion")}),e.jsx("p",{children:n("settings.dataSync")}),e.jsx("div",{className:"mt-2 pt-2 border-t border-border/50",children:e.jsx("p",{className:"font-mono text-xs text-muted-foreground/80",children:"V1.1"})})]})})}function Pt(){const[n,a]=l.useState(()=>{const u=localStorage.getItem("pmscan-background-enabled");return u?JSON.parse(u):!1}),[s,t]=l.useState(null),[r,o]=l.useState(null),[i,c]=l.useState(!1),[m,f]=l.useState("default"),d=l.useRef(null),g=l.useCallback((u,b)=>{m==="granted"&&new Notification(u,{body:b,icon:"/favicon.ico",badge:"/favicon.ico"})},[m]),y=l.useCallback(u=>{switch(h("ðŸ“¨ Received message from Service Worker:",u.data),u.data.type){case"BACKGROUND_SYNC_RUNNING":h();break;case"BACKGROUND_SYNC_COMPLETE":h(`âœ… Background sync completed. Processed ${u.data.processedCount} data points`);break;case"BACKGROUND_SYNC_ERROR":console.error("âŒ Background sync error:",u.data.error),g("PMScan Error","Background data collection failed. Please check the app.");break;case"SYNC_PENDING_MISSIONS":h();break}},[g]),j=l.useCallback(async()=>{if(G()){K("Service Worker registration");return}if("serviceWorker"in navigator)try{const u=await navigator.serviceWorker.register("/sw.js");o(u),h("ðŸ”§ Service Worker registered successfully"),await navigator.serviceWorker.ready,h("ðŸš€ Service Worker ready")}catch(u){console.error("âŒ Service Worker registration failed:",u)}},[]),p=l.useCallback(()=>{if(G()){K("Background Sync check"),c(!1);return}const u="serviceWorker"in navigator&&"sync"in window.ServiceWorkerRegistration.prototype;c(u),h("ðŸ”„ Background Sync supported:",u)},[]),E=l.useCallback(async()=>{"Notification"in window&&f(Notification.permission)},[]);l.useEffect(()=>(j(),p(),E(),navigator.serviceWorker.addEventListener("message",y),()=>{navigator.serviceWorker.removeEventListener("message",y)}),[j,p,E,y]);const N=l.useCallback(async()=>{if(!("Notification"in window))return console.warn("âš ï¸ Notifications not supported"),!1;if(Notification.permission==="granted")return!0;const u=await Notification.requestPermission();return f(u),u==="granted"},[]),C=l.useCallback(async()=>{if(!("wakeLock"in navigator))return console.warn("âš ï¸ Wake Lock API not supported"),!1;try{const u=await navigator.wakeLock.request("screen");return t(u),u.addEventListener("release",()=>{h("ðŸ”‹ Wake lock was released"),t(null)}),h("ðŸ”‹ Wake lock acquired"),!0}catch(u){return console.error("âŒ Wake lock request failed:",u),!1}},[]),w=l.useCallback(async()=>{if(s)try{await s.release(),t(null),h("ðŸ”‹ Wake lock released")}catch(u){console.error("âŒ Wake lock release failed:",u)}},[s]),x=l.useCallback(async(u={enableWakeLock:!0,enableNotifications:!0,syncInterval:3e4})=>{try{if(u.enableNotifications&&(await N()||console.warn("âš ï¸ Notification permission denied")),u.enableWakeLock&&await C(),i&&r)try{navigator.serviceWorker.controller?.postMessage({type:"SCHEDULE_BACKGROUND_SYNC"}),h("ðŸ”„ Background sync scheduled")}catch(b){console.error("âŒ Failed to schedule background sync:",b)}return d.current&&clearInterval(d.current),d.current=setInterval(()=>{r&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SCHEDULE_BACKGROUND_SYNC"})},u.syncInterval),a(!0),localStorage.setItem("pmscan-background-enabled","true"),h("ðŸŽ¯ Background recording enabled"),g("PMScan Background Active","Data collection will continue in the background"),!0}catch(b){return console.error("âŒ Failed to enable background recording:",b),!1}},[N,C,i,r,g]),D=l.useCallback(async()=>{try{await w(),d.current&&(clearInterval(d.current),d.current=null),a(!1),localStorage.setItem("pmscan-background-enabled","false"),h("ðŸ›‘ Background recording disabled"),g("PMScan Background Stopped","Background data collection has been disabled")}catch(u){console.error("âŒ Failed to disable background recording:",u)}},[w,g]),O=l.useCallback((u,b,P)=>{!r||!n||navigator.serviceWorker.controller?.postMessage({type:"STORE_BACKGROUND_DATA",payload:{pmData:u,location:b,context:P,timestamp:Date.now()}})},[r,n]);return l.useEffect(()=>()=>{d.current&&clearInterval(d.current),w()},[w]),{isBackgroundEnabled:n,backgroundSyncSupported:i,notificationPermission:m,wakeLock:!!s,enableBackgroundRecording:x,disableBackgroundRecording:D,storeDataForBackground:O,requestNotificationPermission:N}}function Tt(){const{isBackgroundEnabled:n,enableBackgroundRecording:a,disableBackgroundRecording:s,storeDataForBackground:t}=Pt(),r=l.useCallback(async c=>{try{await a({enableWakeLock:!0,enableNotifications:!0,syncInterval:et(c)}),h("ðŸŽ¯ Background recording enabled")}catch(m){console.warn("âš ï¸ Background recording failed to enable:",m)}},[a]),o=l.useCallback(async()=>{try{await s(),h("ðŸ›‘ Background recording disabled")}catch(c){console.warn("âš ï¸ Background recording failed to disable:",c)}},[s]),i=l.useCallback((c,m,f,d)=>{n&&t(c,m,{...f,weatherDataId:d})},[n,t]);return{isBackgroundEnabled:n,enableRecordingBackground:r,disableRecordingBackground:o,storeBackgroundData:i}}function Wt({onNavigate:n}){const{signOut:a}=F(),s=ie(),{t}=S(),{currentLanguage:r,languages:o}=Se();Xe();const{theme:i="light",setTheme:c}=Je(),{isEnabled:m,toggleEnabled:f}=Qe(),{isBackgroundEnabled:d,enableRecordingBackground:g,disableRecordingBackground:y}=Tt(),{isEnabled:j,setEnabled:p}=at(),{isEnabled:E,toggleEnabled:N}=rt(),{settings:C,updateSettings:w}=Ze(),{features:x}=ot(),{isConnected:D,requestDevice:O,disconnect:u,locationEnabled:b,requestLocationPermission:P}=nt(),je=()=>{s("/profile"),n()},Ne=async()=>{await a(),s("/auth"),n()},Ce=()=>{s("/custom-thresholds"),n()},Be=()=>{s("/custom-alerts"),n()},Me=()=>{const B=o.find(Ee=>Ee.code===r);return B?B.name:r.toUpperCase()},Le=async B=>{B?await g("30s"):await y()};return[{title:t("account.title"),items:[{icon:V,label:t("account.profile"),badge:null,action:je},{icon:oe,label:t("account.logout"),badge:null,action:Ne}]},{title:t("settingsMenu.title"),items:[{icon:le,label:t("settingsMenu.language"),badge:Me()},{icon:yt,label:t("settingsMenu.darkMode"),badge:null,toggle:{checked:i==="dark",onCheckedChange:B=>c(B?"dark":"light")}},{icon:xt,label:"Background Recording",badge:null,toggle:{checked:d,onCheckedChange:Le},info:"Continue recording PMScan data even when the app is minimized or in the background. Note: This will use more battery."},{icon:$e,label:t("settingsMenu.customThresholds"),isPremiumFeature:!x.hasCustomLists,action:Ce,info:x.hasCustomLists?void 0:"Premium feature"},{icon:ee,label:t("settingsMenu.alertsAlarms"),isPremiumFeature:!x.hasCustomLists,action:Be,info:x.hasCustomLists?void 0:"Premium feature"},{icon:it,label:"Auto Context",isPremiumFeature:!x.canUseAutoContext,toggle:x.canUseAutoContext?{checked:m,onCheckedChange:f}:void 0,info:x.canUseAutoContext?void 0:"Premium feature"}]},{title:t("sensors.title"),items:[{icon:ct,label:t("sensors.pmscan"),badge:D?t("sensors.connected"):null,action:()=>{D?u():O()}},{icon:H,label:"GPS",badge:b?t("sensors.connected"):null,action:()=>{b||P()}},{icon:ce,label:t("sensors.weather"),isPremiumFeature:!x.canUseWeatherData,toggle:x.canUseWeatherData?{checked:j,onCheckedChange:p}:void 0,info:x.canUseWeatherData?void 0:"Premium feature"},{icon:H,label:"Location Enrichment",isPremiumFeature:!x.canUseLocationEnrichment,toggle:x.canUseLocationEnrichment?{checked:E,onCheckedChange:N}:void 0,info:x.canUseLocationEnrichment?"Enhance location context using OpenStreetMap reverse geocoding to automatically detect places like restaurants, schools, etc.":"Premium feature"},{icon:ft,label:"Geohash Encoding",badge:null,toggle:{checked:C.enabled,onCheckedChange:B=>w({enabled:B})},info:"Generate geohash codes for spatial indexing and privacy-preserving location data. Geohashes allow for efficient location-based queries while protecting exact coordinates."}]}]}function Ft({onNavigate:n}){const a=Wt({onNavigate:n});return e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsx(At,{}),e.jsx(Et,{}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx("div",{className:"p-4 space-y-6 pb-safe-area-inset-bottom",children:a.map((s,t)=>e.jsx(Dt,{title:s.title,items:s.items},`section-${t}`))})}),e.jsx(Ot,{})]})}function Ut(){const[n,a]=l.useState({isOnline:navigator.onLine,wasOffline:!1,connectionType:T(),lastOnlineTime:navigator.onLine?new Date:null,syncStatus:"idle"});l.useEffect(()=>{const t=()=>{const i=new Date;a(c=>({...c,isOnline:!0,lastOnlineTime:i,connectionType:T()})),n.wasOffline&&(v.success("Back online! Syncing data...",{duration:3e3,id:"connection-restored"}),s())},r=()=>{a(i=>({...i,isOnline:!1,wasOffline:!0,connectionType:null})),v.warning("You're offline. The app will continue working with cached data.",{duration:5e3,id:"connection-lost"})},o=()=>{a(i=>({...i,connectionType:T()}))};return window.addEventListener("online",t),window.addEventListener("offline",r),"connection"in navigator&&navigator.connection?.addEventListener("change",o),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",r),"connection"in navigator&&navigator.connection?.removeEventListener("change",o)}},[n.wasOffline]);const s=async()=>{a(t=>({...t,syncStatus:"syncing"}));try{if("serviceWorker"in navigator&&"sync"in window.ServiceWorkerRegistration.prototype){const t=await navigator.serviceWorker.ready;await t.sync.register("background-sync-air-quality"),await t.sync.register("background-sync-missions"),a(r=>({...r,syncStatus:"success"})),v.success("Data synced successfully!")}}catch(t){console.error("Background sync failed:",t),a(r=>({...r,syncStatus:"failed"})),v.error("Sync failed. Will retry automatically.")}};return{...n,triggerSync:s}}function T(){if("connection"in navigator){const n=navigator.connection;return n?.effectiveType||n?.type||null}return null}class _t{DB_NAME="pmscan-offline";DB_VERSION=1;STORES=["air-quality","missions","settings"];async openDB(){return new Promise((a,s)=>{const t=indexedDB.open(this.DB_NAME,this.DB_VERSION);t.onerror=()=>s(t.error),t.onsuccess=()=>a(t.result),t.onupgradeneeded=r=>{const o=r.target.result;this.STORES.forEach(i=>{if(!o.objectStoreNames.contains(i)){const c=o.createObjectStore(i,{keyPath:"id"});c.createIndex("timestamp","timestamp",{unique:!1}),c.createIndex("synced","synced",{unique:!1})}})}})}async storeAirQualityData(a,s,t){try{const i=(await this.openDB()).transaction(["air-quality"],"readwrite").objectStore("air-quality"),c={id:`aq_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"air-quality",data:{pmData:a,location:s,context:t},timestamp:Date.now(),synced:!1,retryCount:0};await i.add(c),h("ðŸ—„ï¸ Air quality data stored offline",{id:c.id})}catch(r){R("Failed to store air quality data offline",r)}}async storeMissionData(a){try{const r=(await this.openDB()).transaction(["missions"],"readwrite").objectStore("missions"),o={id:`mission_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"mission",data:a,timestamp:Date.now(),synced:!1,retryCount:0};await r.add(o),h("ðŸ—„ï¸ Mission data stored offline",{id:o.id})}catch(s){R("Failed to store mission data offline",s)}}async getUnsyncedData(a){try{const s=await this.openDB(),t=a?[a]:this.STORES,r=[];for(const o of t)try{const c=s.transaction([o],"readonly").objectStore(o);if(!c.indexNames.contains("synced")){Y(`Index 'synced' not found in store '${o}', skipping`);continue}const f=c.index("synced").getAll(IDBKeyRange.only(!1)),d=await new Promise((g,y)=>{f.onsuccess=()=>g(f.result),f.onerror=()=>y(f.error)});r.push(...d)}catch(i){Y(`Failed to access store '${o}':`,i);continue}return r.sort((o,i)=>o.timestamp-i.timestamp)}catch(s){return R("Failed to get unsynced data",s),[]}}async markAsSynced(a,s){try{const o=(await this.openDB()).transaction([s],"readwrite").objectStore(s),i=o.get(a),c=await new Promise((m,f)=>{i.onsuccess=()=>m(i.result),i.onerror=()=>f(i.error)});c&&(c.synced=!0,await o.put(c),h("âœ… Data marked as synced",{id:a}))}catch(t){R("Failed to mark data as synced",t)}}async incrementRetryCount(a,s){try{const o=(await this.openDB()).transaction([s],"readwrite").objectStore(s),i=o.get(a),c=await new Promise((m,f)=>{i.onsuccess=()=>m(i.result),i.onerror=()=>f(i.error)});c&&(c.retryCount=(c.retryCount||0)+1,await o.put(c))}catch(t){R("Failed to increment retry count",t)}}async clearSyncedData(a=24){try{const s=await this.openDB(),t=Date.now()-a*60*60*1e3;for(const r of this.STORES){const c=s.transaction([r],"readwrite").objectStore(r).index("timestamp"),m=IDBKeyRange.upperBound(t),f=c.openCursor(m);f.onsuccess=d=>{const g=d.target.result;g&&(g.value.synced&&g.delete(),g.continue())}}h("ðŸ§¹ Cleaned up old synced data")}catch(s){R("Failed to clean up synced data",s)}}async getStorageStats(){try{const a=await this.openDB();let s=0,t=0;for(const o of this.STORES){const c=a.transaction([o],"readonly").objectStore(o),m=c.count(),f=await new Promise(g=>{m.onsuccess=()=>g(m.result)});let d=0;if(c.indexNames.contains("synced")){const y=c.index("synced").getAll(IDBKeyRange.only(!1));d=await new Promise((j,p)=>{y.onsuccess=()=>j(y.result.length),y.onerror=()=>j(0)})}s+=f,t+=d}const r=await this.estimateStorageSize();return{totalItems:s,unsyncedItems:t,storageSize:r}}catch(a){return R("Failed to get storage stats",a),{totalItems:0,unsyncedItems:0,storageSize:0}}}async estimateStorageSize(){if("storage"in navigator&&"estimate"in navigator.storage)try{return(await navigator.storage.estimate()).usage||0}catch{return 0}return 0}}const qt=new _t;function $t(){const{isOnline:n,connectionType:a,lastOnlineTime:s,syncStatus:t,triggerSync:r}=Ut(),[o,i]=l.useState({totalItems:0,unsyncedItems:0,storageSize:0}),[c,m]=l.useState(!1);l.useEffect(()=>{const p=async()=>{const N=await qt.getStorageStats();i(N)};p();const E=setInterval(p,3e4);return()=>clearInterval(E)},[t]);const f=p=>p<1024?`${p} B`:p<1024*1024?`${(p/1024).toFixed(1)} KB`:`${(p/(1024*1024)).toFixed(1)} MB`,d=p=>{if(!p)return"Unknown";const N=new Date().getTime()-p.getTime(),C=Math.floor(N/(1e3*60));if(C<1)return"Just now";if(C<60)return`${C}m ago`;const w=Math.floor(C/60);return w<24?`${w}h ago`:`${Math.floor(w/24)}d ago`},g=()=>n?o.unsyncedItems>0?"secondary":"default":"destructive",y=()=>t==="syncing"?e.jsx(Q,{className:"w-3 h-3 animate-spin"}):n?o.unsyncedItems>0?e.jsx(gt,{className:"w-3 h-3"}):e.jsx(ce,{className:"w-3 h-3"}):e.jsx(X,{className:"w-3 h-3"}),j=()=>t==="syncing"?"Syncing...":n?o.unsyncedItems>0?`${o.unsyncedItems} pending`:"Online":"Offline";return e.jsxs(dt,{open:c,onOpenChange:m,children:[e.jsx(ut,{asChild:!0,children:e.jsxs(M,{variant:"ghost",size:"sm",className:k("h-8 px-2 gap-1.5 transition-colors",!n&&"text-destructive hover:text-destructive",o.unsyncedItems>0&&n&&"text-orange-600 hover:text-orange-700"),children:[y(),e.jsx("span",{className:"text-xs font-medium hidden sm:inline",children:j()})]})}),e.jsx(mt,{className:"w-80",align:"end",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold",children:"Connection Status"}),e.jsx(I,{variant:g(),children:n?e.jsxs(e.Fragment,{children:[e.jsx(kt,{className:"w-3 h-3 mr-1"})," Online"]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-3 h-3 mr-1"})," Offline"]})})]}),a&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Connection: ",a.toUpperCase()]}),!n&&s&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Last online: ",d(s)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold",children:"Data Sync"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:o.unsyncedItems}),e.jsx("p",{className:"text-muted-foreground",children:"Pending items"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:o.totalItems}),e.jsx("p",{className:"text-muted-foreground",children:"Total stored"})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Storage used: ",f(o.storageSize)]})]}),n&&o.unsyncedItems>0&&e.jsx(M,{onClick:r,disabled:t==="syncing",className:"w-full",size:"sm",children:t==="syncing"?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4 mr-2 animate-spin"}),"Syncing..."]}):"Sync Now"}),!n&&e.jsx("div",{className:"bg-muted/50 p-3 rounded-lg",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You're offline. The app will continue working with cached data and sync automatically when you're back online."})})]})})]})}function Vt(){const[n,a]=l.useState([]),[s,t]=l.useState(!1),{t:r}=S(),o=()=>{const d=tt();a(d)};l.useEffect(()=>{o();const d=setInterval(o,3e4);return()=>clearInterval(d)},[]);const i=async d=>{t(!0);try{await J(d)?(v.success(r("sync.csvSyncSuccess","CSV synced successfully")),o()):v.error(r("sync.csvSyncFailed","Failed to sync CSV"))}catch{v.error(r("sync.csvSyncError","Error syncing CSV"))}finally{t(!1)}},c=async()=>{t(!0);try{let d=0;for(const g of n)await J(g.filename)&&d++;d>0?(v.success(r("sync.csvBatchSuccess",`Synced ${d}/${n.length} CSV files`)),o()):v.error(r("sync.csvBatchFailed","Failed to sync CSV files"))}catch{v.error(r("sync.csvBatchError","Error syncing CSV files"))}finally{t(!1)}},m=()=>{st(),a([]),v.info(r("sync.csvCleared","Pending CSV files cleared"))};if(n.length===0)return null;const f=()=>n.some(g=>(g.retryCount||0)>3)?"destructive":"secondary";return e.jsxs(_,{children:[e.jsx(q,{asChild:!0,children:e.jsxs(M,{variant:"ghost",size:"sm",className:"flex items-center gap-2 relative",disabled:s,children:[s?e.jsx(Z,{className:"h-4 w-4 animate-spin"}):e.jsx(lt,{className:"h-4 w-4"}),e.jsx(I,{variant:f(),className:"h-5 px-1.5 text-xs",children:n.length})]})}),e.jsxs($,{align:"end",className:"w-80",children:[e.jsxs("div",{className:"px-3 py-2 border-b",children:[e.jsx("h4",{className:"font-medium text-sm",children:r("sync.pendingCSVTitle","Pending CSV Files")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("sync.pendingCSVDesc","These files are waiting to be synced")})]}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:n.map(d=>e.jsxs(A,{className:"flex-col items-start p-3",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:"text-sm font-medium truncate max-w-48",children:d.filename}),(d.retryCount||0)>0&&e.jsxs(I,{variant:"outline",className:"text-xs",children:[d.retryCount," ",r("sync.retries","retries")]})]}),e.jsxs("div",{className:"flex items-center justify-between w-full mt-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:d.timestamp.toLocaleString()}),e.jsx(M,{size:"sm",variant:"ghost",onClick:g=>{g.stopPropagation(),i(d.filename)},disabled:s,className:"h-6 px-2 text-xs",children:r("sync.retry","Retry")})]})]},d.filename))}),e.jsx(W,{}),e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs(M,{size:"sm",variant:"outline",onClick:c,disabled:s||!navigator.onLine,className:"w-full justify-start text-xs",children:[e.jsx(Z,{className:"h-3 w-3 mr-2"}),r("sync.retryAll","Retry All")]}),e.jsxs(M,{size:"sm",variant:"ghost",onClick:m,disabled:s,className:"w-full justify-start text-xs text-muted-foreground",children:[e.jsx(ee,{className:"h-3 w-3 mr-2"}),r("sync.clearAll","Clear All")]})]})]})]})}function As(){const[n,a]=l.useState(!1),{user:s,signOut:t}=F(),r=ie(),{t:o}=S(),i=async()=>{await t(),r("/auth")},c=()=>s?.email?s.email.charAt(0).toUpperCase():"U";return e.jsx("header",{className:"fixed top-0 left-0 right-0 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border z-50",children:e.jsxs("div",{className:"flex items-center justify-between h-14 px-4 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(bt,{open:n,onOpenChange:a,children:[e.jsx(vt,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"icon",className:"h-9 w-9 hover:bg-accent","aria-label":"Menu principal",children:e.jsx(pt,{className:"h-5 w-5"})})}),e.jsx(ue,{side:"left",className:"w-full sm:w-80 p-0",children:e.jsx(Ft,{onNavigate:()=>a(!1)})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h1",{className:"text-lg font-bold text-foreground",children:o("header.title")})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Vt,{}),e.jsx($t,{}),s&&e.jsxs(_,{children:[e.jsx(q,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"icon",className:"h-9 w-9",children:e.jsx(ve,{className:"h-8 w-8",children:e.jsx(we,{className:"text-xs",children:c()})})})}),e.jsxs($,{align:"end",className:"w-56",children:[e.jsx("div",{className:"px-2 py-1.5",children:e.jsx("p",{className:"text-sm font-medium",children:s.email})}),e.jsx(W,{}),e.jsxs(A,{onClick:()=>r("/profile"),children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),o("account.profile")]}),e.jsx(W,{}),e.jsxs(A,{onClick:i,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),o("auth.signOut")]})]})]})]})]})})}export{As as Header};
