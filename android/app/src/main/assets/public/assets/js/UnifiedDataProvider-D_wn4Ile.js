const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/useMissionSaver-CXd3xg0u.js","assets/js/vendor-CRCfYjC_.js","assets/js/client-zGYq1VIw.js","assets/js/supabase--OITQzG1.js","assets/js/timeFormat-CCn9v1Tp.js","assets/js/index-DnKT6hDb.js","assets/js/query-BewfWFH7.js","assets/js/router-D6wdMmGF.js","assets/js/theme-D-6-9UvQ.js","assets/js/ui-core-CibF-ClQ.js","assets/js/utils-EL5wpLGY.js","assets/js/notifications-6vUXhpBr.js","assets/js/i18n-DZz6YkIP.js","assets/index-BOVYw4lO.css","assets/js/supabaseSafeWrapper-C24d6oy5.js"])))=>i.map(i=>d[i]);
import{j as et}from"./query-BewfWFH7.js";import{r as c}from"./vendor-CRCfYjC_.js";import{c as at}from"./timeFormat-CCn9v1Tp.js";import{d as i,e as X}from"./index-DnKT6hDb.js";import{_ as nt}from"./supabase--OITQzG1.js";import{p as it,a as st}from"./useMissionSaver-CXd3xg0u.js";function x(r,t){const n=new Uint8Array(r.buffer);(n[3]&255)<<24|(n[2]&255)<<16|(n[1]&255)<<8|n[0]&255;const e={pm1:((n[9]&255)<<8|n[8]&255)/10,pm25:((n[11]&255)<<8|n[10]&255)/10,pm10:((n[13]&255)<<8|n[12]&255)/10,temp:((n[15]&255)<<8|n[14]&255)/10,humidity:((n[17]&255)<<8|n[16]&255)/10,battery:t.battery,charging:t.charging===1,timestamp:at(),location:"PMScan Device"};return n.length>137&&(e.particles_02_05=(n[129]&255)<<8|n[128]&255,e.particles_05_10=(n[131]&255)<<8|n[130]&255,e.particles_10_25=(n[133]&255)<<8|n[132]&255,e.particles_25_50=(n[135]&255)<<8|n[134]&255,e.particles_50_100=(n[137]&255)<<8|n[136]&255),n.length>146&&(e.external_temperature=(n[145]&255)/100,e.external_humidity=(n[146]&255)/100),e}function z(r,t,n,e,a){n().then(o=>e(o)).catch(o=>{if(r===0)return a();i(),setTimeout(()=>{z(--r,Math.floor(5+t),n,e,a)},t*1e3)})}class rt{state={name:"PMScanXXXXXX",version:0,mode:0,interval:0,display:new Uint8Array(10),battery:0,charging:0,dataLogger:!1,externalMemory:0};updateBattery(t){this.state.battery=t}updateCharging(t){this.state.charging=t}updateVersion(t){this.state.version=t}updateMode(t){this.state.mode=t}updateInterval(t){this.state.interval=t}updateDisplay(t){this.state.display=new Uint8Array(t.buffer)}updateName(t){this.state.name=t}}const H="f3641900-00b0-4240-ba50-05ca45bf8abc",K="f3641901-00b0-4240-ba50-05ca45bf8abc",Q="f3641902-00b0-4240-ba50-05ca45bf8abc",ot="f3641903-00b0-4240-ba50-05ca45bf8abc",J="f3641904-00b0-4240-ba50-05ca45bf8abc",j="f3641905-00b0-4240-ba50-05ca45bf8abc",ct="f3641906-00b0-4240-ba50-05ca45bf8abc",lt="f3641907-00b0-4240-ba50-05ca45bf8abc",Y="f3641908-00b0-4240-ba50-05ca45bf8abc",dt="f364190a-00b0-4240-ba50-05ca45bf8abc",ut=946684800;class ht{constructor(t){this.deviceState=t}async initializeDevice(t,n,e,a,o,v){i(),i();const l=await t.getPrimaryService(H),m=await l.getCharacteristic(J),f=(await m.readValue()).getUint8(0);i(),this.deviceState.updateBattery(f);const p=await l.getCharacteristic(K);await p.startNotifications(),p.addEventListener("characteristicvaluechanged",e);const D=await l.getCharacteristic(Q);await D.startNotifications(),D.addEventListener("characteristicvaluechanged",a),await m.startNotifications(),m.addEventListener("characteristicvaluechanged",o);const S=await l.getCharacteristic(j);await S.startNotifications(),S.addEventListener("characteristicvaluechanged",v),await this.syncDeviceTime(l);const b=(await S.readValue()).getUint8(0);i(),this.deviceState.updateCharging(b);const I=(await(await l.getCharacteristic(ot)).readValue()).getUint8(0)>>2;i(),this.deviceState.updateVersion(I);const d=(await(await l.getCharacteristic(lt)).readValue()).getUint8(0);i(),this.deviceState.updateInterval(d);const M=(await(await l.getCharacteristic(Y)).readValue()).getUint8(0);i(),this.deviceState.updateMode(M);const E=await(await l.getCharacteristic(dt)).readValue();return i(`ðŸ–¥ï¸ Display: ${E.getUint8(0)}`),this.deviceState.updateDisplay(new Uint8Array(E.buffer)),i(),{deviceInfo:{name:n?.name||"PMScan Device",version:I,mode:M,interval:d,battery:f,charging:b===1,connected:!0},service:l}}async syncDeviceTime(t){const n=await t.getCharacteristic(ct),a=(await n.readValue()).getUint32(0);if(i(),a===0){i();const o=Math.floor(new Date().getTime()/1e3-ut),v=new Uint8Array(4);v[0]=o&255,v[1]=o>>8&255,v[2]=o>>16&255,v[3]=o>>24&255,await n.writeValueWithResponse(v)}else i()}}class gt{constructor(t){this.deviceState=t}async reestablishEventListeners(t,n,e,a,o,v){try{const l=await t.getCharacteristic(K),m=await t.getCharacteristic(Q),u=await t.getCharacteristic(J),f=await t.getCharacteristic(j);return l.removeEventListener("characteristicvaluechanged",e),m.removeEventListener("characteristicvaluechanged",a),u.removeEventListener("characteristicvaluechanged",o),f.removeEventListener("characteristicvaluechanged",v),await l.startNotifications(),l.addEventListener("characteristicvaluechanged",e),await m.startNotifications(),m.addEventListener("characteristicvaluechanged",a),await u.startNotifications(),u.addEventListener("characteristicvaluechanged",o),await f.startNotifications(),f.addEventListener("characteristicvaluechanged",v),i("ðŸ”„ Event listeners re-established and notifications started"),{name:n?.name||"PMScan Device",version:this.deviceState.state.version,mode:this.deviceState.state.mode,interval:this.deviceState.state.interval,battery:this.deviceState.state.battery,charging:this.deviceState.state.charging===1,connected:!0}}catch(l){return console.error("âŒ Failed to re-establish event listeners:",l),null}}}class k{static async requestBluetoothDevice(){if(!navigator.bluetooth)throw new Error("Bluetooth not available in this browser");i();const t=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"PMScan"}],optionalServices:[H]});return i("ðŸ“± Requested "+t.name),t}static async connectToDevice(t){return i(),await t.gatt.connect()}static async sendDisconnectCommand(t,n){try{i("ðŸ”Œ Requesting disconnect...");const e=await t.getCharacteristic(Y),a=new Uint8Array(1);a[0]=n|64,await e.writeValueWithResponse(a)}catch(e){throw console.error("âŒ Failed to send disconnect command:",e),e}}}class vt{device=null;server=null;service=null;isInited=!1;shouldConnect=!1;deviceState;deviceInitializer;eventManager;constructor(){this.deviceState=new rt,this.deviceInitializer=new ht(this.deviceState),this.eventManager=new gt(this.deviceState)}get state(){return this.deviceState.state}isConnected(){return this.device?.gatt?.connected&&this.isInited||!1}shouldAutoConnect(){return this.shouldConnect}async requestDevice(){const t=await k.requestBluetoothDevice();return this.device=t,this.isInited=!1,this.shouldConnect=!0,t}async connect(){if(!this.device||!this.shouldConnect)throw new Error("No device available or should not connect");const t=await k.connectToDevice(this.device);return this.server=t,t}async initializeDevice(t,n,e,a){if(!this.server||!this.device)throw new Error("No server connection available");this.isInited=!1;const{deviceInfo:o,service:v}=await this.deviceInitializer.initializeDevice(this.server,this.device,t,n,e,a);return this.service=v,this.isInited=!0,o}async disconnect(t=!1){if((q()||W())&&!t)return i(),!1;if(this.shouldConnect=!1,this.device?.gatt?.connected&&this.service)try{await k.sendDisconnectCommand(this.service,this.deviceState.state.mode),this.device.gatt.disconnect()}catch(e){console.error("âŒ Failed to send disconnect command:",e)}return this.isInited=!1,!0}onDisconnected(){i(),this.isInited=!1,q()||W()?(i(),this.isInited=!1):this.shouldConnect=!1,this.device=null,this.server=null,this.service=null}async reestablishEventListeners(t,n,e,a){return!this.isConnected()||!this.service||!this.device?null:await this.eventManager.reestablishEventListeners(this.service,this.device,t,n,e,a)}updateBattery(t){this.deviceState.updateBattery(t)}updateCharging(t){this.deviceState.updateCharging(t)}}const O=new vt;let _=!1,U=!1,T=null;const F=r=>{_=r,i("ðŸŽ¯ Global recording state set to:",r),r||U?$():!r&&!U&&Z()},q=()=>_,B=r=>{U=r,i("ðŸŒ™ Background recording state set to:",r),r||_?$():!r&&!_&&Z()},W=()=>U,$=()=>{T||(i(),T=setInterval(async()=>{if(!(!U&&!_)&&!O.isConnected()){i();try{O.shouldAutoConnect()&&(await O.connect(),i("âœ… PMScan auto-reconnection successful"))}catch(r){console.warn("âš ï¸ PMScan auto-reconnection failed:",r)}}},1e4))},Z=()=>{T&&(clearInterval(T),T=null,i())};function mt(){const[r,t]=c.useState(!1),[n,e]=c.useState(!1),[a,o]=c.useState(null),[v,l]=c.useState(null),[m,u]=c.useState(null),f=O,p=c.useCallback(s=>{const d=s.target;if(d.value){const g=x(d.value,f.state);l(h=>!h||Math.abs(h.pm25-g.pm25)>=.1||Math.abs(h.pm1-g.pm1)>=.1||Math.abs(h.pm10-g.pm10)>=.1||g.timestamp.getTime()-h.timestamp.getTime()>=1e3?(console.log("ðŸ“¡ NEW PMScan data received and set as currentData:",{pm1:g.pm1,pm25:g.pm25,pm10:g.pm10,timestamp:g.timestamp.toISOString(),previousData:h?{pm25:h.pm25,timestamp:h.timestamp.toISOString()}:null}),g):h)}},[]),D=c.useCallback(s=>{const d=s.target;d.value&&x(d.value,f.state)},[]),S=c.useCallback(s=>{const d=s.target;if(d.value){const g=d.value.getUint8(0);f.updateBattery(g),o(h=>h?{...h,battery:g}:null)}},[]),A=c.useCallback(s=>{const d=s.target;if(d.value){const g=d.value.getUint8(0);f.updateCharging(g),o(h=>h?{...h,charging:g===1}:null)}},[]),b=c.useCallback(async s=>{try{const g=await f.initializeDevice(p,D,S,A);o(g),t(!0),e(!1),u(null)}catch(d){console.error("âŒ Error initializing device:",d),u("Failed to initialize device"),e(!1)}},[p,D,S,A]),P=c.useCallback(()=>{f.onDisconnected(),t(!1),o(s=>s?{...s,connected:!1}:null)},[]),w=c.useCallback(()=>{const s=f;i("ðŸ”„ connect() called, shouldConnect:",s.shouldAutoConnect()),s.shouldAutoConnect()&&z(10,1.2,()=>s.connect(),d=>b(d),()=>{i(),u("Failed to reconnect"),e(!1)})},[b]),I=c.useCallback(async()=>{try{u(null),e(!0),(await f.requestDevice()).addEventListener("gattserverdisconnected",()=>{i("ðŸ”Œ PMScan Device disconnected"),P(),w()}),w()}catch(s){console.error("âŒ Error requesting device:",s),u(s instanceof Error?s.message:"Failed to connect to device"),e(!1)}},[w,P]),L=c.useCallback(async()=>{await f.disconnect()?(t(!1),o(null),l(null)):(u("Cannot disconnect while recording is active. Stop recording first."),setTimeout(()=>u(null),3e3))},[]);return c.useEffect(()=>{let s=!0;const d=f;return(window.requestIdleCallback||(h=>setTimeout(h,0)))(()=>{s&&(d.isConnected()?(t(!0),d.reestablishEventListeners(p,D,S,A).then(h=>{s&&h&&(o(h),i())}).catch(h=>{s&&(console.error("âŒ Failed to restore connection:",h),u("Failed to restore connection"))})):s&&(t(!1),o(null),l(null)))}),()=>{s=!1}},[p,D,S,A]),{isConnected:r,isConnecting:n,device:a,currentData:v,error:m,requestDevice:I,disconnect:L}}class R{static instance;listeners=new Set;state={recordingData:[],isRecording:!1,recordingFrequency:"10s",missionContext:{location:"",activity:""},recordingStartTime:null};static getInstance(){return R.instance||(R.instance=new R),R.instance}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t({...this.state}))}getState(){return{...this.state}}startRecording(t="10s"){i(),i("ðŸŽ¬ Input frequency:",t),i("ðŸŽ¬ Current state before update:",JSON.stringify(this.state,null,2)),this.state={...this.state,isRecording:!0,recordingFrequency:t,recordingStartTime:new Date,recordingData:[]},i("ðŸŽ¬ New state after update:",JSON.stringify(this.state,null,2)),F(!0),B(!0),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(navigator.serviceWorker.controller.postMessage({type:"START_BACKGROUND_RECORDING",frequency:t}),i()),i("ðŸŽ¬ About to notify listeners:",this.listeners.size,"listeners"),this.notify(),i("âœ… Recording started! Final isRecording state:",this.state.isRecording)}stopRecording(){console.log("ðŸš¨ðŸ›‘ === RECORDING SERVICE STOP CALLED ==="),console.log("ðŸ›‘ Recording service stop - current state:",{isRecording:this.state.isRecording,recordingDataLength:this.state.recordingData.length,hasRecordingStartTime:!!this.state.recordingStartTime,recordingStartTime:this.state.recordingStartTime}),i(),this.state={...this.state,isRecording:!1},F(!1),B(!1),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"STOP_BACKGROUND_RECORDING"}),this.notify(),console.log("ðŸš¨ðŸ›‘ === RECORDING SERVICE STOP COMPLETE ==="),i()}addDataPoint(t,n,e,a,o,v){if(!this.state.isRecording){i();return}const l={pmData:t,location:n,context:e||this.state.missionContext,automaticContext:a,enrichedLocation:o,geohash:v,timestamp:t.timestamp};this.state={...this.state,recordingData:[...this.state.recordingData,l]},this.autoSaveProgress(),this.notify(),console.log("ðŸš¨âœ… === UNIFIED RECORDING SYSTEM ==="),i("ðŸ“Š Data point added to UNIFIED RecordingService. Total entries:",this.state.recordingData.length)}lastAutoSave=null;AUTO_SAVE_INTERVAL=3e4;AUTO_SAVE_DATA_POINTS=5;autoSaveProgress(){const t=Date.now(),n=!this.lastAutoSave||t-this.lastAutoSave>=this.AUTO_SAVE_INTERVAL,e=this.state.recordingData.length%this.AUTO_SAVE_DATA_POINTS===0;if(n||e)try{nt(async()=>{const{saveRecordingProgressToStorage:a}=await import("./useMissionSaver-CXd3xg0u.js").then(o=>o.b);return{saveRecordingProgressToStorage:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14])).then(({saveRecordingProgressToStorage:a})=>{a({recordingData:this.state.recordingData,recordingStartTime:this.state.recordingStartTime,frequency:this.state.recordingFrequency,missionContext:this.state.missionContext,timestamp:new Date}),this.lastAutoSave=t,i("ðŸ’¾ Auto-saved recording progress:",this.state.recordingData.length,"entries")})}catch(a){X("âŒ Failed to auto-save recording progress:",a)}}updateMissionContext(t,n){this.state={...this.state,missionContext:{location:t,activity:n}},this.notify(),i("ðŸ·ï¸ Mission context updated:",{location:t,activity:n})}clearRecordingData(){this.state={...this.state,recordingData:[],recordingStartTime:null},this.notify(),i()}getRecordingDuration(){return this.state.recordingStartTime?Date.now()-this.state.recordingStartTime.getTime():0}getDataPointCount(){return this.state.recordingData.length}getLatestDataPoint(){const t=this.state.recordingData;return t.length>0?t[t.length-1]:null}getAverageValues(){if(this.state.recordingData.length===0)return null;const t=this.state.recordingData.reduce((e,a)=>({pm1:e.pm1+a.pmData.pm1,pm25:e.pm25+a.pmData.pm25,pm10:e.pm10+a.pmData.pm10}),{pm1:0,pm25:0,pm10:0}),n=this.state.recordingData.length;return{pm1:t.pm1/n,pm25:t.pm25/n,pm10:t.pm10/n}}exportData(){return[...this.state.recordingData]}}const y=R.getInstance();function ft(){const[r,t]=c.useState(()=>{const l=y.getState();return i("ðŸŽ¯ useRecordingService initial state:",l),l});c.useEffect(()=>(i(),y.subscribe(m=>{i("ðŸŽ¯ useRecordingService received state update:",m),t(m)})),[]);const n=c.useCallback(l=>{i("ðŸš¨ useRecordingService.startRecording called with frequency:",l),y.startRecording(l)},[]),e=c.useCallback(()=>{y.stopRecording()},[]),a=c.useCallback((l,m,u,f,p,D)=>{y.addDataPoint(l,m,u,f,p,D)},[]),o=c.useCallback((l,m)=>{y.updateMissionContext(l,m)},[]),v=c.useCallback(()=>{y.clearRecordingData()},[]);return{...r,startRecording:n,stopRecording:e,addDataPoint:a,updateMissionContext:o,clearRecordingData:v}}const N={GPS_ACCURACY_MAX:20,EMA_ALPHA:.25,MIN_DT:.5,MAX_JUMP:100,ACC_PEAK_THR:.8,ACC_REFRAC_MS:300,ACC_WIN_SEC:6,ACC_CADENCE_MIN:70,ACC_CADENCE_MAX:180,ACC_CV_MAX:.3,ACC_RMS_MIN:.5,ACC_RMS_MAX:3.5,ACC_HOLD_ENTER:10,ACC_HOLD_EXIT:30,ACC_TIMEOUT_MS:5e3};function Mt(r,t){return r==="good"&&t?"good":r==="good"||t?"partial":"poor"}function pt(r,t,n,e){const o=f=>f*Math.PI/180,v=o(n-r),l=o(e-t),m=Math.sin(v/2)**2+Math.cos(o(r))*Math.cos(o(n))*Math.sin(l/2)**2;return 6371e3*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)))}class Ct{prev;vEma=0;alpha=N.EMA_ALPHA;maxAcc=N.GPS_ACCURACY_MAX;maxJump=N.MAX_JUMP;minDt=N.MIN_DT;update(t){const n=t.acc??null;let e=n!==null&&n>this.maxAcc?"poor":"good";if(!this.prev)return this.prev=t,{speedKmh:this.vEma,gpsQuality:e};const a=(t.t-this.prev.t)/1e3;if(!isFinite(a)||a<=this.minDt)return this.prev=t,{speedKmh:this.vEma,gpsQuality:e};((this.prev.acc??0)>this.maxAcc||(t.acc??0)>this.maxAcc)&&(e="poor");let l=pt(this.prev.lat,this.prev.lon,t.lat,t.lon)/a*3.6;return l>this.maxJump&&(l=this.maxJump,e="poor"),this.vEma===0?this.vEma=l:this.vEma=this.alpha*l+(1-this.alpha)*this.vEma,this.prev=t,{speedKmh:this.vEma,gpsQuality:e}}reset(){this.prev=void 0,this.vEma=0}getCurrentSpeed(){return this.vEma}}function Dt(r=!0,t=!1,n){const[e,a]=c.useState(!1),[o,v]=c.useState(null),[l,m]=c.useState(null),u=c.useRef(null),[f,p]=c.useState(null),D=c.useRef(0),S=c.useRef(new Ct),[A,b]=c.useState(0),[P,w]=c.useState("good");c.useCallback(()=>{u.current!==null&&(navigator.geolocation.clearWatch(u.current),u.current=null,m(null))},[]);const I=c.useCallback(()=>{if(!r)return;if(u.current!==null&&(navigator.geolocation.clearWatch(u.current),u.current=null,m(null)),!navigator.geolocation){console.error("ðŸ§­ GPS: Geolocation is not supported by this browser"),p("Geolocation is not supported by this browser");return}let s=6e4;if(n){const C=it(n);s=Math.max(C,3e4)}const d={enableHighAccuracy:t,timeout:6e4,maximumAge:s},g=C=>{const E={latitude:C.coords.latitude,longitude:C.coords.longitude,accuracy:C.coords.accuracy,altitude:C.coords.altitude||void 0,timestamp:new Date},{speedKmh:V,gpsQuality:G}=S.current.update({lat:C.coords.latitude,lon:C.coords.longitude,t:C.timestamp,acc:C.coords.accuracy});b(V),w(G),console.log("ðŸ§­ === GPS LOCATION UPDATED ===",{latitude:E.latitude,longitude:E.longitude,accuracy:E.accuracy,speedKmh:V,gpsQuality:G,timestamp:E.timestamp.toISOString()}),v(E),p(null),a(!0)},h=C=>{const E=Date.now();if(!(E-D.current<1e4))switch(D.current=E,X("ðŸ§­ GPS: Error occurred:",new Error(C.message),{code:C.code,message:C.message,PERMISSION_DENIED:C.PERMISSION_DENIED,POSITION_UNAVAILABLE:C.POSITION_UNAVAILABLE,TIMEOUT:C.TIMEOUT}),C.code){case C.PERMISSION_DENIED:console.error("ðŸ§­ GPS: Permission denied"),p("Location access denied"),a(!1);break;case C.POSITION_UNAVAILABLE:console.error("ðŸ§­ GPS: Position unavailable"),p("Location information unavailable");break;case C.TIMEOUT:console.warn("ðŸ§­ GPS: Timeout occurred");break;default:console.error("ðŸ§­ GPS: Unknown error"),p("Unknown GPS error");break}},M=navigator.geolocation.watchPosition(g,h,d);u.current=M,m(M)},[r,t,n]),L=c.useCallback(async()=>{i();try{if("permissions"in navigator){i("ðŸ§­ GPS: Using permissions API");const s=await navigator.permissions.query({name:"geolocation"});return i("ðŸ§­ GPS: Current permission state:",s.state),s.state==="granted"?(a(!0),!0):s.state==="prompt"?new Promise(d=>{navigator.geolocation.getCurrentPosition(g=>{a(!0),d(!0)},g=>{console.error("Permission denied:",g),a(!1),p("Location permission denied"),d(!1)})}):(p("Location permission permanently denied"),!1)}else return new Promise(s=>{navigator.geolocation.getCurrentPosition(d=>{a(!0),s(!0)},d=>{console.error("Permission denied:",d),a(!1),p("Location permission denied"),s(!1)})})}catch(s){return console.error("Error requesting location permission:",s),p("Failed to request location permission"),!1}},[]);return c.useEffect(()=>{let s=!0,d=null,g=null;return"permissions"in navigator&&navigator.permissions.query({name:"geolocation"}).then(h=>{s&&(d=h,h.state==="granted"&&a(!0),g=()=>{h.state==="granted"?a(!0):(a(!1),v(null))},h.addEventListener("change",g))}),()=>{s=!1,d&&g&&d.removeEventListener("change",g)}},[]),c.useEffect(()=>{r||(u.current!==null&&(navigator.geolocation.clearWatch(u.current),u.current=null,m(null)),a(!1),v(null),p(null),S.current.reset(),b(0),w("good"))},[r]),c.useEffect(()=>{if(r&&e){const s=setTimeout(()=>{I()},100);return()=>clearTimeout(s)}},[r,e,t,n]),c.useEffect(()=>()=>{u.current!==null&&navigator.geolocation.clearWatch(u.current)},[]),{locationEnabled:e,latestLocation:o,speedKmh:A,gpsQuality:P,error:f,requestLocationPermission:L}}const tt=c.createContext(void 0);function St(){const r=c.useContext(tt);if(!r)throw new Error("useUnifiedData must be used within UnifiedDataProvider");return r}function Et({children:r}){const[t,n]=c.useState(!0),e=mt(),a=ft(),{latestLocation:o,locationEnabled:v,requestLocationPermission:l,speedKmh:m,gpsQuality:u}=Dt(!0,!0,a.recordingFrequency),{saveMission:f}=st();c.useEffect(()=>{console.log("ðŸ”„ UNIFIED DATA - RECORDING STATE CHANGED:",{isRecording:a.isRecording,hasAddDataPoint:!!a.addDataPoint,timestamp:new Date().toISOString()})},[a.isRecording,a.addDataPoint]),c.useEffect(()=>{console.log("ðŸ”„ UNIFIED DATA - BLUETOOTH STATE CHANGED:",{hasCurrentData:!!e.currentData,isConnected:e.isConnected,pm25:e.currentData?.pm25,timestamp:new Date().toISOString()})},[e.currentData,e.isConnected]),c.useEffect(()=>{console.log("ðŸ”„ UNIFIED DATA COMPLETE STATE:",{hasCurrentData:!!e.currentData,currentDataPM25:e.currentData?.pm25,isConnected:e.isConnected,isRecording:a.isRecording,recordingDataLength:a.recordingData.length,hasLocation:!!o,hasAddDataPoint:!!a.addDataPoint,timestamp:new Date().toISOString(),willProceedCheck:a.isRecording&&!!e.currentData&&!!a.addDataPoint})},[e.currentData,e.isConnected,a.isRecording,a.recordingData.length,o,a.addDataPoint]),console.log("ðŸ”„ UNIFIED DATA - GPS STATE:",{hasLocation:!!o,latitude:o?.latitude,longitude:o?.longitude,accuracy:o?.accuracy,speedKmh:m,gpsQuality:u,locationEnabled:v});const p={currentData:e.currentData,isConnected:e.isConnected,isConnecting:e.isConnecting,device:e.device,error:e.error,isRecording:a.isRecording,recordingData:a.recordingData,recordingFrequency:a.recordingFrequency,missionContext:a.missionContext,recordingStartTime:a.recordingStartTime,latestLocation:o,speedKmh:m,gpsQuality:u,locationEnabled:v,requestDevice:e.requestDevice,disconnect:e.disconnect,requestLocationPermission:l,startRecording:a.startRecording,stopRecording:a.stopRecording,updateMissionContext:a.updateMissionContext,addDataPoint:a.addDataPoint,clearRecordingData:a.clearRecordingData,saveMission:async(D,S,A,b,P,w)=>{const I=w||a.recordingData;return f(I,a.recordingStartTime,D,S,A,b,P,void 0,e.device?.name)}};return et.jsx(tt.Provider,{value:p,children:r})}const Rt=Object.freeze(Object.defineProperty({__proto__:null,UnifiedDataProvider:Et,useUnifiedData:St},Symbol.toStringTag,{value:"Module"}));export{N as A,Rt as U,Dt as a,Mt as c,St as u};
