class l{taskQueue=[];isProcessing=!1;async scheduleTask(s,i={priority:"background"}){return new Promise((r,e)=>{this.taskQueue.push({task:s,resolve:r,reject:e,options:i}),this.isProcessing||this.processTasks()})}async processTasks(){if(!(this.isProcessing||this.taskQueue.length===0)){for(this.isProcessing=!0;this.taskQueue.length>0;){const{task:s,resolve:i,reject:r,options:e}=this.taskQueue.shift();try{if(e.signal?.aborted){r(new Error("Task aborted"));continue}const t=await this.executeWithScheduling(s,e);i(t)}catch(t){r(t)}await this.yieldToMain()}this.isProcessing=!1}}async executeWithScheduling(s,i){return new Promise((r,e)=>{const t=async()=>{try{const n=await s();r(n)}catch(n){e(n)}};if("scheduler"in window&&"postTask"in window.scheduler)window.scheduler.postTask(t,{priority:i.priority,signal:i.signal});else if(i.priority==="background"&&"requestIdleCallback"in window)requestIdleCallback(t,{timeout:i.timeout||5e3});else{const n=i.priority==="user-blocking"?0:i.priority==="user-visible"?16:100;setTimeout(t,n)}})}async yieldToMain(){return new Promise(s=>{"scheduler"in window&&"postTask"in window.scheduler?window.scheduler.postTask(s,{priority:"user-blocking"}):setTimeout(s,0)})}async processArrayInChunks(s,i,r=100,e={priority:"background"}){const t=[];for(let n=0;n<s.length;n+=r){const a=s.slice(n,n+r),u=await this.scheduleTask(()=>i(a),e);t.push(...u)}return t}async deferScript(s){return this.scheduleTask(()=>new Promise((i,r)=>{const e=document.createElement("script");e.src=s,e.onload=()=>i(),e.onerror=()=>r(new Error(`Failed to load script: ${s}`)),"fetchPriority"in e&&(e.fetchPriority="low"),document.head.appendChild(e)}),{priority:"background",timeout:1e4})}clearTasks(){this.taskQueue.length=0}}const o=new l;async function d(c){return o.scheduleTask(c,{priority:"background"})}async function h(c){return o.scheduleTask(c,{priority:"user-visible"})}async function k(c){return o.scheduleTask(c,{priority:"user-blocking"})}async function y(c,s={}){const{maxExecutionTime:i=5,priority:r="background"}=s;return o.scheduleTask(async()=>{const e=performance.now();let t=c();return performance.now()-e>i&&await o.yieldToMain(),t},{priority:r})}console.debug("[PERF] ðŸš€ Main Thread Optimizer initialized");export{o as mainThreadOptimizer,y as optimizeComputation,d as scheduleBackgroundTask,k as scheduleUrgentTask,h as scheduleUserTask};
