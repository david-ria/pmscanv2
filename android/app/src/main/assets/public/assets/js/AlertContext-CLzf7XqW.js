import{j as M}from"./query-BewfWFH7.js";import{r as s}from"./vendor-CRCfYjC_.js";import{u as j}from"./useGroupSettings-DQBWUHal.js";import{d as U}from"./index-DnKT6hDb.js";import"./router-D6wdMmGF.js";import"./groupConfigs-C_MEEc6R.js";import"./useSubscription-DJEgHQrc.js";import"./client-zGYq1VIw.js";import"./supabase--OITQzG1.js";import"./useGroups-DlFUXECJ.js";import"./useUserRole-B8Vd-TTd.js";import"./ui-forms-BvHfx7SG.js";import"./ui-core-CibF-ClQ.js";import"./supabaseSafeWrapper-C24d6oy5.js";import"./theme-D-6-9UvQ.js";import"./utils-EL5wpLGY.js";import"./notifications-6vUXhpBr.js";import"./i18n-DZz6YkIP.js";const S={pm1:{enabled:!1,threshold:null,duration:30},pm25:{enabled:!1,threshold:null,duration:30},pm10:{enabled:!1,threshold:null,duration:30}},v=s.createContext(void 0);function tt({children:d}){const[c,p]=s.useState(S),[u,f]=s.useState(!0),[T,E]=s.useState({pm1:{isAboveThreshold:!1,startTime:null,currentDuration:0},pm25:{isAboveThreshold:!1,startTime:null,currentDuration:0},pm10:{isAboveThreshold:!1,startTime:null,currentDuration:0}}),{getCurrentAlarms:_,getCurrentSettings:w,isGroupMode:x}=j(),g=()=>{if(x){const e=_(),r=w();if(e.length>0&&r)return{pm1:{enabled:r.alarm_enabled&&e.some(t=>t.enabled&&t.pm1_threshold!==void 0),threshold:e.find(t=>t.enabled&&t.pm1_threshold!==void 0)?.pm1_threshold||null,duration:30},pm25:{enabled:r.alarm_enabled&&e.some(t=>t.enabled&&t.pm25_threshold!==void 0),threshold:e.find(t=>t.enabled&&t.pm25_threshold!==void 0)?.pm25_threshold||null,duration:30},pm10:{enabled:r.alarm_enabled&&e.some(t=>t.enabled&&t.pm10_threshold!==void 0),threshold:e.find(t=>t.enabled&&t.pm10_threshold!==void 0)?.pm10_threshold||null,duration:30}}}return c};s.useEffect(()=>{const e=localStorage.getItem("alertSettings"),r=localStorage.getItem("globalAlertsEnabled");if(e)try{const o=JSON.parse(e);p(o)}catch(o){console.error("Failed to parse saved alert settings:",o)}r!==null&&f(r==="true"),"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().then(o=>{U("Notification permission:",o)})},[]),s.useEffect(()=>{localStorage.setItem("alertSettings",JSON.stringify(c))},[c]),s.useEffect(()=>{localStorage.setItem("globalAlertsEnabled",u.toString())},[u]);const D=e=>{p(e)},N=()=>{p(S)},C=(e,r,o)=>{"Notification"in window&&Notification.permission==="granted"&&new Notification(`PM${e==="pm25"?"2.5":e.toUpperCase()} Alert`,{body:`Pollution level ${r} Î¼g/mÂ³ detected for ${o} minutes`,icon:"/favicon.ico"}),console.warn(`ðŸš¨ Alert triggered: ${e.toUpperCase()} at ${r} Î¼g/mÂ³ for ${o} minutes`)},P=(e,r,o)=>{if(!u)return;const t=g(),b=new Date,G=[{key:"pm1",value:e},{key:"pm25",value:r},{key:"pm10",value:o}];E(I=>{const i={...I};return G.forEach(({key:n,value:A})=>{const l=t[n],a=i[n];if(!l.enabled||l.threshold===null){i[n]={isAboveThreshold:!1,startTime:null,currentDuration:0};return}const h=A>l.threshold;if(h&&!a.isAboveThreshold)i[n]={isAboveThreshold:!0,startTime:b,currentDuration:0};else if(h&&a.isAboveThreshold&&a.startTime){const m=Math.floor((b.getTime()-a.startTime.getTime())/6e4);i[n]={...a,currentDuration:m},m>=l.duration&&m%l.duration===0&&C(n,A,m)}else h||(i[n]={isAboveThreshold:!1,startTime:null,currentDuration:0})}),i})},$=()=>T;return M.jsx(v.Provider,{value:{alertSettings:g(),updateAlertSettings:D,resetToDefaults:N,globalAlertsEnabled:u,setGlobalAlertsEnabled:f,checkAlerts:P,getExposureState:$},children:d})}function et(){const d=s.useContext(v);if(d===void 0)throw new Error("useAlerts must be used within an AlertProvider");return d}export{tt as AlertProvider,et as useAlerts};
