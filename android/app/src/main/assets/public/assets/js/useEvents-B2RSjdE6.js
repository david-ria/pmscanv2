import{r as u}from"./vendor-CRCfYjC_.js";import{supabase as d}from"./client-zGYq1VIw.js";import{u as S,a as b}from"./index-DnKT6hDb.js";function i(t){let o;return t.timestamp instanceof Date?o=t.timestamp:typeof t.timestamp=="string"?o=new Date(t.timestamp):o=new Date,{id:t.id||crypto.randomUUID(),missionId:t.mission_id||t.missionId,eventType:t.event_type||t.eventType,comment:t.comment,photoUrl:t.photo_url||t.photoUrl,latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,createdBy:t.created_by||t.createdBy,timestamp:o}}function I(t){return{id:t.id,mission_id:t.missionId,event_type:t.eventType,comment:t.comment,photo_url:t.photoUrl,latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,created_by:t.createdBy,timestamp:t.timestamp.toISOString()}}function p(t){return t.sort((o,a)=>o.timestamp.getTime()-a.timestamp.getTime())}function $(){const[t,o]=u.useState(!1),{toast:a}=S(),{user:c}=b(),g=async r=>{o(!0);try{if(!c)throw console.error("No user found when trying to create event"),new Error("User must be logged in to create events");console.log("Creating event with user:",c.id),console.log("Event data:",r);const e=i({...r,createdBy:c.id,timestamp:r.timestamp||new Date}),s=JSON.parse(localStorage.getItem("pending_events")||"[]");return s.push(I(e)),localStorage.setItem("pending_events",JSON.stringify(s)),console.log("Event stored locally:",e),a({title:"Event Recorded",description:"Event has been recorded and will be saved with the mission."}),e}catch(e){throw console.error("Error creating event - full error:",e),a({title:"Error",description:`Failed to save event: ${e instanceof Error?e.message:"Unknown error"}`,variant:"destructive"}),e}finally{o(!1)}},f=async(r,e)=>{const s=`${e}/${Date.now()}-${r.name}`,{data:n,error:l}=await d.storage.from("event-photos").upload(s,r,{cacheControl:"3600",upsert:!1});if(l)throw l;const{data:{publicUrl:m}}=d.storage.from("event-photos").getPublicUrl(n.path);return m},E=u.useCallback(async r=>{o(!0);try{const{data:e,error:s}=await d.from("events").select("*").eq("mission_id",r).order("timestamp",{ascending:!0});let n=[];!s&&e&&(n=e.map(i));const m=JSON.parse(localStorage.getItem(`mission_events_${r}`)||"[]").map(i),y=[...n,...m].filter((h,v,w)=>v===w.findIndex(_=>_.id===h.id));return p(y)}catch(e){console.error("Error fetching events:",e);try{const n=JSON.parse(localStorage.getItem(`mission_events_${r}`)||"[]").map(i);return p(n)}catch(s){return console.error("Error fetching local events:",s),a({title:"Error",description:"Failed to load events.",variant:"destructive"}),[]}}finally{o(!1)}},[a]);return{createEvent:g,uploadEventPhoto:f,getEventsByMission:E,isLoading:t}}export{$ as u};
