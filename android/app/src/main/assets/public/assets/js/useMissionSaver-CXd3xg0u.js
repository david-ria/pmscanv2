const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/notifications-6vUXhpBr.js","assets/js/vendor-CRCfYjC_.js"])))=>i.map(i=>d[i]);
import{r as $}from"./vendor-CRCfYjC_.js";import{supabase as C}from"./client-zGYq1VIw.js";import{_ as Q}from"./supabase--OITQzG1.js";import{t as x,c as H}from"./timeFormat-CCn9v1Tp.js";import{d as i,w as j,e as S}from"./index-DnKT6hDb.js";import{o as U}from"./supabaseSafeWrapper-C24d6oy5.js";const D="pmscan_recording_recovery",J="pmscan_unsent_csv";function X(e){try{localStorage.setItem(D,JSON.stringify(e))}catch(t){console.error("Failed to save recording progress:",t)}}function z(){const{saveMission:e}=ye();$.useEffect(()=>{(async()=>{try{const s=localStorage.getItem(D);if(s){const c=JSON.parse(s);if(Date.now()-new Date(c.timestamp).getTime()>24*60*60*1e3){i("ğŸ§¹ Clearing old crash recovery data (>24h)"),localStorage.removeItem(D);return}}if(navigator.onLine&&i("ğŸ§¹ Online - but skipping storage clear to prevent sync loops"),s){const c=JSON.parse(s),l=c.recordingData.map(u=>({...u,pmData:{...u.pmData,timestamp:new Date(u.pmData.timestamp)}})),g=Date.now()-new Date(c.timestamp).getTime()<24*60*60*1e3,p=l.length>0;if(g&&p){i("ğŸ”„ Found crash recovery data, auto-saving mission...");const u=await e(c.recordingData,c.recordingStartTime,`Recovered-${new Date().toISOString().slice(0,16)}`,c.missionContext.location,c.missionContext.activity,c.frequency),_=`recovered_${u.id}_${Date.now()}.csv`;await k(_,`Mission ID: ${u.id}, Data Points: ${c.recordingData.length}`),Q(async()=>{const{toast:f}=await import("./notifications-6vUXhpBr.js");return{toast:f}},__vite__mapDeps([0,1])).then(({toast:f})=>{f.success("Mission recovered successfully",{description:`Recovered ${c.recordingData.length} data points from interrupted session`,duration:5e3})}),console.log("âœ… Successfully recovered mission:",u.id),n()}localStorage.removeItem(D)}const a=P();if(a.length>0){i(`ğŸ“¤ Found ${a.length} unsent CSV files, attempting to sync...`);for(const c of a)try{await B(c),b(c.filename),i(`âœ… Successfully synced CSV: ${c.filename}`)}catch(l){console.error(`Failed to sync CSV ${c.filename}:`,l)}}i("ğŸš« Skipping auto-sync during crash recovery to prevent loops")}catch(s){console.error("Error during crash recovery:",s)}})()},[e]);const t=$.useCallback((o,s,a,c)=>{if(!s||o.length===0){localStorage.removeItem(D);return}const l={recordingData:o,recordingStartTime:s,frequency:a,missionContext:c,timestamp:new Date};try{localStorage.setItem(D,JSON.stringify(l))}catch(g){console.warn("Failed to save recording progress for crash recovery:",g)}},[]),n=$.useCallback(()=>{localStorage.removeItem(D)},[]);return{saveRecordingProgress:t,clearRecoveryData:n}}function P(){try{return Object.keys(localStorage).filter(t=>t.startsWith(`${J}_`)).map(t=>{const n=localStorage.getItem(t);if(n){const o=JSON.parse(n);return{...o,timestamp:new Date(o.timestamp)}}return null}).filter(Boolean)}catch{return[]}}function Y(e,t,n=0){try{const o={filename:e,content:t,timestamp:new Date,retryCount:n};localStorage.setItem(`${J}_${e}`,JSON.stringify(o))}catch(o){console.error("Failed to save unsent CSV:",o)}}function b(e){try{localStorage.removeItem(`${J}_${e}`)}catch(t){console.error("Failed to remove unsent CSV:",t)}}async function B(e){try{i(`ğŸ“¡ Attempting to sync CSV: ${e.filename}`),await new Promise(n=>setTimeout(n,1e3));const t=Math.random()>.2;return t?i(`âœ… Successfully synced CSV: ${e.filename}`):j(`âš ï¸ Failed to sync CSV: ${e.filename}`),t}catch(t){return S(`âŒ Error syncing CSV ${e.filename}:`,t),!1}}const k=(e,t)=>new Promise(n=>{Y(e,t),n()});function Z(e){return new Promise(async t=>{try{const n=P().find(s=>s.filename===e);if(!n){t(!1);return}await B(n)?(b(e),t(!0)):(Y(e,n.content,(n.retryCount||0)+1),t(!1))}catch(n){console.error("Error retrying CSV sync:",n),t(!1)}})}function ee(){P().forEach(t=>b(t.filename))}const Ce=Object.freeze(Object.defineProperty({__proto__:null,clearAllUnsentCSVs:ee,getUnsentCSVs:P,retryCSVSync:Z,saveRecordingProgressToStorage:X,storeCSVForSync:k,useCrashRecovery:z},Symbol.toStringTag,{value:"Module"}));async function te(e){i(),i("ğŸ“Š Mission data:",{id:e.id,name:e.name,measurementsCount:e.measurements?.length||0,startTime:e.startTime,endTime:e.endTime});const n=(r=>{try{return JSON.parse(localStorage.getItem(`mission_events_${r}`)||"[]").sort((m,v)=>new Date(m.timestamp||0).getTime()-new Date(v.timestamp||0).getTime())}catch(d){return i("Error fetching local events for export:",d),[]}})(e.id),o=["Timestamp","PM1 (Âµg/mÂ³)","PM2.5 (Âµg/mÂ³)","PM10 (Âµg/mÂ³)","Temperature (Â°C)","Humidity (%)","Latitude","Longitude","GPS Accuracy (m)","Location Context","Activity Context","Auto Context","Enriched Location (Nominatim)","Geohash","Event Type","Event Comment"],s=new Map;n.forEach(r=>{const d=new Date(r.timestamp||0);let m=null,v=1/0;e.measurements.forEach((V,G)=>{const K=V.timestamp instanceof Date?V.timestamp:new Date(V.timestamp),N=Math.abs(d.getTime()-K.getTime());N<v&&N<=3e4&&(v=N,m=G)}),m!==null&&s.set(m.toString(),r)});const a=e.measurements.map((r,d)=>{const m=r.timestamp instanceof Date?r.timestamp:new Date(r.timestamp),v=s.get(d.toString());return[x(m),r.pm1.toFixed(1),r.pm25.toFixed(1),r.pm10.toFixed(1),r.temperature?.toFixed(1)||"",r.humidity?.toFixed(1)||"",r.latitude?.toFixed(6)||"",r.longitude?.toFixed(6)||"",r.accuracy?.toFixed(0)||"",r.locationContext||e.locationContext||"",r.activityContext||e.activityContext||"",r.automaticContext||"",r.enrichedLocation||"",r.geohash||"",v?.event_type||"",v?.comment||""]}),g="\uFEFF"+[o,...a].map(r=>r.map(d=>`"${d}"`).join(",")).join(`
`),p=new Blob([g],{type:"text/csv;charset=utf-8"}),u=document.createElement("a"),_=URL.createObjectURL(p),f=e.startTime,y=e.deviceName||"PMScan",w=f.getFullYear().toString()+(f.getMonth()+1).toString().padStart(2,"0")+f.getDate().toString().padStart(2,"0"),M=f.getHours().toString().padStart(2,"0")+f.getMinutes().toString().padStart(2,"0")+f.getSeconds().toString().padStart(2,"0"),h=`${y}_${w}_${M}.csv`;k(h,g),u.setAttribute("href",_),u.setAttribute("download",h),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u),i("âœ… CSV export completed successfully:",{filename:h,rowCount:a.length,csvSize:g.length})}const E="pmscan_missions",T="pmscan_pending_sync";function O(){try{const e=localStorage.getItem(E);return e?JSON.parse(e).map(n=>({...n,startTime:new Date(n.startTime),endTime:new Date(n.endTime),measurements:n.measurements.map(o=>({...o,timestamp:new Date(o.timestamp)}))})):[]}catch(e){return console.error("Error reading local missions:",e),[]}}function W(e){i(),i("ğŸ’¾ Number of missions to save:",e.length),i("ğŸ’¾ Mission names:",e.map(t=>t.name));try{localStorage.setItem(E,JSON.stringify(e)),i("âœ… Missions saved to localStorage successfully")}catch(t){if(t instanceof DOMException&&t.name==="QuotaExceededError")console.warn("LocalStorage quota exceeded, cleaning up old missions..."),se(e),localStorage.setItem(E,JSON.stringify(e));else throw t}}function ne(e){return{id:e.id,name:e.name,startTime:new Date(e.start_time),endTime:new Date(e.end_time),durationMinutes:e.duration_minutes,actualRecordingMinutes:e.actual_recording_minutes,recordingCoveragePercentage:e.recording_coverage_percentage,gapDetected:e.gap_detected,avgPm1:e.avg_pm1,avgPm25:e.avg_pm25,avgPm10:e.avg_pm10,maxPm25:e.max_pm25,measurementsCount:e.measurements_count,locationContext:e.location_context,activityContext:e.activity_context,recordingFrequency:e.recording_frequency,shared:e.shared,deviceName:e.device_name,weatherDataId:e.weather_data_id,airQualityDataId:e.air_quality_data_id,measurements:e.measurements?.map(t=>({id:t.id,timestamp:new Date(t.timestamp),pm1:t.pm1,pm25:t.pm25,pm10:t.pm10,temperature:t.temperature,humidity:t.humidity,latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,locationContext:t.location_context,activityContext:t.activity_context,automaticContext:t.automatic_context,enrichedLocation:t.enriched_location,geohash:t.geohash}))||[],synced:!0}}function F(){try{const e=localStorage.getItem(T);return e?JSON.parse(e):[]}catch{return[]}}function ae(e){const t=F();t.includes(e)||(t.push(e),localStorage.setItem(T,JSON.stringify(t)))}function I(e){const t=F().filter(n=>n!==e);localStorage.setItem(T,JSON.stringify(t))}function oe(){localStorage.removeItem(E),localStorage.removeItem(T),i()}function se(e){const n=e.sort((a,c)=>c.endTime.getTime()-a.endTime.getTime()).slice(0,10);i(`Cleaning up old missions, keeping ${n.length} most recent ones`),localStorage.setItem(E,JSON.stringify(n));const o=n.map(a=>a.id),s=F().filter(a=>o.includes(a));localStorage.setItem(T,JSON.stringify(s))}const re=e=>{const t=parseInt(e);return e.includes("s")?t*1e3:e.includes("m")?t*60*1e3:1e4};function ie(e,t,n,o,s,a,c,l,g,p){const u=e.map((m,v)=>({id:crypto.randomUUID(),timestamp:m.pmData.timestamp instanceof Date?m.pmData.timestamp:new Date(m.pmData.timestamp),pm1:m.pmData.pm1,pm25:m.pmData.pm25,pm10:m.pmData.pm10,temperature:m.pmData.temp,humidity:m.pmData.humidity,latitude:m.location?.latitude,longitude:m.location?.longitude,accuracy:m.location?.accuracy,locationContext:m.context?.location,activityContext:m.context?.activity,automaticContext:m.automaticContext,enrichedLocation:m.enrichedLocation,geohash:m.geohash})),_=e.find(m=>m.weatherDataId)?.weatherDataId,f=u.map(m=>m.pm25),y=u.reduce((m,v)=>m+v.pm1,0)/u.length,w=u.reduce((m,v)=>m+v.pm25,0)/u.length,M=u.reduce((m,v)=>m+v.pm10,0)/u.length,h=Math.max(...f),r=ce(u,n,o,c||"30s");return{id:g||crypto.randomUUID(),name:t,startTime:n,endTime:o,durationMinutes:Math.round((o.getTime()-n.getTime())/(1e3*60)),actualRecordingMinutes:r.actualMinutes,recordingCoveragePercentage:r.coveragePercentage,gapDetected:r.gapDetected,avgPm1:y,avgPm25:w,avgPm10:M,maxPm25:h,measurementsCount:u.length,locationContext:s,activityContext:a,recordingFrequency:c||"30s",shared:l||!1,deviceName:p,measurements:u,synced:!1,weatherDataId:_,airQualityDataId:void 0}}function ce(e,t,n,o){if(e.length===0)return{actualMinutes:0,coveragePercentage:0,gapDetected:!0};const a=re(o)/(1e3*60),c=(n.getTime()-t.getTime())/(1e3*60),l=[...e].sort((y,w)=>new Date(y.timestamp).getTime()-new Date(w.timestamp).getTime());let g=0,p=0;const u=a*3;if(l.length===1)g=a;else{for(let y=1;y<l.length;y++){const w=new Date(l[y-1].timestamp).getTime();(new Date(l[y].timestamp).getTime()-w)/(1e3*60)<=u?g+=a:(g+=a,p++)}g+=a}const _=c>0?Math.min(100,g/c*100):0,f=p>0||_<80;return{actualMinutes:Math.round(g*100)/100,coveragePercentage:Math.round(_*100)/100,gapDetected:f}}function A(e){i(),i("ğŸ’¾ Mission to save:",{id:e.id,name:e.name,measurementsCount:e.measurementsCount,startTime:e.startTime,endTime:e.endTime});const t=O();i("ğŸ’¾ Existing missions count:",t.length);try{const n=t,o=n.findIndex(s=>s.id===e.id);o>=0?n[o]=e:n.push(e),W(n),i("âœ… Mission saved locally successfully. Total missions now:",n.length),le(e.id),e.synced||ae(e.id)}catch(n){throw console.error("Failed to save mission locally:",n),new Error("Impossible de sauvegarder la mission localement. MÃ©moire insuffisante.")}}function le(e){try{const t=JSON.parse(localStorage.getItem("pending_events")||"[]"),n=t.filter(o=>o.mission_id===e||o.mission_id==="current-recording");if(n.length>0){const o=n.map(l=>({...l,mission_id:e})),a=[...JSON.parse(localStorage.getItem(`mission_events_${e}`)||"[]"),...o];localStorage.setItem(`mission_events_${e}`,JSON.stringify(a));const c=t.filter(l=>l.mission_id!==e&&l.mission_id!=="current-recording");localStorage.setItem("pending_events",JSON.stringify(c)),console.log(`Saved ${n.length} events for mission ${e}`)}}catch(t){console.error("Failed to save pending events for mission:",t)}}async function me(e){const t=O().filter(n=>n.id!==e);if(W(t),I(e),!U.isOffline()){const n=await U.query(C.from("missions").delete().eq("id",e));n.error&&!n.isOffline&&console.error("Failed to delete mission from database:",n.error)}}async function ue(e){try{const t=e.measurements.find(s=>s.latitude&&s.longitude);if(!t?.latitude||!t?.longitude)return i("âŒ Cannot fetch weather for mission: no location data"),null;const{data:n,error:o}=await C.functions.invoke("fetch-weather",{body:{latitude:t.latitude,longitude:t.longitude,timestamp:x(e.startTime)}});return o?(S("âŒ Error fetching weather data for mission:",o),null):n?.weatherData?(i("âœ… Weather data fetched for mission:",e.id),n.weatherData.id):null}catch(t){return S("âŒ Error in weather fetch for mission:",t),null}}async function de(e){try{const t=JSON.parse(localStorage.getItem(`mission_events_${e}`)||"[]");if(t.length===0)return!0;const n=await C.auth.getUser();if(!n.data.user)return!1;const o=t.map(a=>({id:a.id,mission_id:e,event_type:a.event_type,comment:a.comment,photo_url:a.photo_url,latitude:a.latitude,longitude:a.longitude,accuracy:a.accuracy,created_by:n.data.user.id,timestamp:a.timestamp})),{error:s}=await C.from("events").upsert(o);return s?(S(`âŒ Error syncing events for mission ${e}:`,s),!1):(localStorage.removeItem(`mission_events_${e}`),i(`âœ… Synced ${t.length} events for mission ${e}`),!0)}catch(t){return S(`âŒ Error in syncEventsForMission for ${e}:`,t),!1}}async function q(e,t){try{const{count:n,error:o}=await C.from("measurements").select("*",{count:"exact",head:!0}).eq("mission_id",e);if(o)return S(`âŒ Error validating sync for mission ${e}:`,o),!1;const s=n===t;return s?i(`âœ… Sync validation passed for mission ${e}: ${n} measurements`):S(`âŒ Sync validation failed for mission ${e}: expected ${t}, got ${n}`),s}catch(n){return S(`âŒ Error in validateMissionSync for ${e}:`,n),!1}}async function ge(){if(!navigator.onLine)return;const e=F(),t=O(),n=e.filter(s=>t.some(a=>a.id===s));e.filter(s=>!n.includes(s)).forEach(s=>I(s));for(const s of n){const a=t.find(p=>p.id===s);if(!a)continue;let c=!1,l=0;const g=3;for(;!c&&l<g;)try{l++,i(`ğŸ”„ Syncing mission ${a.name} (attempt ${l}/${g})`);let p=a.weatherDataId;p||(p=await ue(a));const u=null,{data:_}=await C.from("missions").select("id").eq("id",a.id).maybeSingle();if(_)if(await q(a.id,a.measurementsCount)){i(`âœ… Mission ${a.name} already properly synced`),a.synced=!0,A(a),I(a.id),c=!0;continue}else i(`ğŸ”„ Mission ${a.name} exists but sync incomplete, re-syncing measurements`);const{data:f,error:y}=await C.from("missions").upsert({id:a.id,user_id:(await C.auth.getUser()).data.user?.id,name:a.name,start_time:x(a.startTime),end_time:x(a.endTime),duration_minutes:a.durationMinutes,avg_pm1:a.avgPm1,avg_pm25:a.avgPm25,avg_pm10:a.avgPm10,max_pm25:a.maxPm25,measurements_count:a.measurementsCount,location_context:a.locationContext,activity_context:a.activityContext,recording_frequency:a.recordingFrequency,shared:a.shared,device_name:a.deviceName,weather_data_id:p,air_quality_data_id:u}).select().single();if(y)throw y;const w=a.measurements.map(d=>({id:d.id,mission_id:a.id,timestamp:x(d.timestamp),pm1:d.pm1,pm25:d.pm25,pm10:d.pm10,temperature:d.temperature,humidity:d.humidity,latitude:d.latitude,longitude:d.longitude,accuracy:d.accuracy,location_context:d.locationContext,activity_context:d.activityContext,automatic_context:d.automaticContext,enriched_location:d.enrichedLocation,geohash:d.geohash})),{error:M}=await C.from("measurements").upsert(w);if(M)throw M;if(!await de(a.id))throw new Error("Failed to sync events");if(!await q(a.id,a.measurementsCount))throw new Error("Sync validation failed");a.synced=!0,A(a),I(a.id),c=!0,i(`âœ… Mission ${a.name} synced successfully`)}catch(p){S(`âŒ Failed to sync mission ${a.name} (attempt ${l}):`,p),l>=g?S(`âŒ Mission ${a.name} failed to sync after ${g} attempts`):await new Promise(u=>setTimeout(u,1e3*l))}}}let L=null;const pe=5e3;class fe{async getAllMissions(){const t=O();try{const{data:n,error:o}=await C.from("missions").select(`
          *,
          measurements (
            id,
            timestamp,
            pm1,
            pm25,
            pm10,
            temperature,
            humidity,
            latitude,
            longitude,
            accuracy,
            location_context,
            activity_context,
            automatic_context,
            enriched_location,
            geohash
          )
        `).order("created_at",{ascending:!1});if(!o&&n){const a=n.map(ne).filter(l=>{const g=l.measurements&&l.measurements.length>0;return!g&&l.measurementsCount>0&&j(`âš ï¸ Mission ${l.name} has ${l.measurementsCount} measurements in metadata but 0 actual measurements - likely orphaned`),g});return[...t.filter(l=>!l.synced),...a]}}catch(n){i("Database not available, using local data only:",n)}return t}exportMissionToCSV=te;clearLocalStorage=oe;createMissionFromRecording=ie;saveMissionLocally=A;deleteMission=me;async syncPendingMissions(){if(L&&clearTimeout(L),this.isSyncing){i();return}return new Promise(t=>{L=setTimeout(async()=>{try{this.isSyncing=!0,await ge(),i("âœ… Sync completed")}catch(n){S("âŒ Sync failed:",n)}finally{this.isSyncing=!1,t()}},pe)})}isSyncing=!1}const R=new fe;function ye(){return{saveMission:$.useCallback(async(t,n,o,s,a,c,l,g,p)=>{if(console.log("ğŸš¨ğŸ’¾ === MISSION SAVER CALLED ==="),console.log("ğŸ’¾ useMissionSaver.saveMission called with:",{recordingDataLength:t?.length||0,recordingStartTime:n,missionName:o,locationContext:s,activityContext:a,recordingFrequency:c,shared:l,deviceName:p,hasRecordingData:!!t,sampleDataPoints:t?.slice(0,2).map(r=>({pm25:r.pmData.pm25,timestamp:r.timestamp,context:r.context}))}),i("ğŸ’¾ useMissionSaver.saveMission called with:",{recordingDataLength:t?.length||0,recordingStartTime:n,missionName:o,locationContext:s,activityContext:a,recordingFrequency:c,shared:l}),!n)throw S("âŒ No recording start time provided"),new Error("Aucun enregistrement en cours Ã  sauvegarder");if(t.length===0)throw S("âŒ No recording data provided"),new Error("Aucune donnÃ©e enregistrÃ©e pour crÃ©er la mission");const u=t[t.length-1],_=t[0],f=n<u.timestamp?n:u.timestamp;let y=_.timestamp;const w=y.getTime()-f.getTime(),M=Math.round(w/(1e3*60));M<1&&(y=H(),i("ğŸ“ Adjusting mission end time due to minimal data duration:",{originalDuration:M,adjustedEndTime:y,recordingStartTime:f})),console.log("ğŸ” Mission saving - context analysis:",{totalEntries:t.length,missionContext:{locationContext:s,activityContext:a},contextDistribution:t.reduce((r,d)=>{const m=`${d.context?.location||"unknown"}-${d.context?.activity||"unknown"}`;return r[m]=(r[m]||0)+1,r},{}),sampleEntries:t.slice(0,3).map(r=>({context:r.context,automaticContext:r.automaticContext}))}),i();const h=R.createMissionFromRecording(t,o,f,y,s,a,c,l,g,p);i("ğŸ’¾ Mission created:",{id:h.id,name:h.name,measurementsCount:h.measurementsCount}),i(),R.saveMissionLocally(h),i(),console.log("ğŸš¨ğŸ’¾ === ABOUT TO EXPORT CSV ==="),console.log("ğŸ’¾ Mission data for CSV export:",{missionId:h.id,measurementsCount:h.measurementsCount,missionName:h.name});try{await R.exportMissionToCSV(h),console.log("ğŸš¨ğŸ’¾ === CSV EXPORT SUCCESS ===")}catch(r){throw console.error("ğŸš¨ğŸ’¾ === CSV EXPORT FAILED ===",r),r}return i(),console.log("ğŸš¨ğŸ’¾ === MISSION SAVE COMPLETE ==="),h},[])}}export{ye as a,Ce as b,ee as c,R as d,P as g,re as p,Z as r,z as u};
