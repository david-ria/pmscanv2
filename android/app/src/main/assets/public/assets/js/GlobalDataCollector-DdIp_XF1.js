import{_ as W}from"./supabase--OITQzG1.js";import{r as l}from"./vendor-CRCfYjC_.js";import{a as B,u as J}from"./UnifiedDataProvider-D_wn4Ile.js";import{u as K,a as Y}from"./useWeatherData-Bov5wL1Q.js";import{d as p,r as T,u as X,S as $,b as j}from"./useAutoContext-RU6mHgIo.js";import{a as V,u as Z}from"./useLocationEnrichmentSettings-CHsjhA43.js";import{supabase as tt}from"./client-zGYq1VIw.js";import"./query-BewfWFH7.js";import"./timeFormat-CCn9v1Tp.js";import"./index-DnKT6hDb.js";import"./router-D6wdMmGF.js";import"./theme-D-6-9UvQ.js";import"./ui-core-CibF-ClQ.js";import"./utils-EL5wpLGY.js";import"./notifications-6vUXhpBr.js";import"./i18n-DZz6YkIP.js";import"./useMissionSaver-CXd3xg0u.js";import"./supabaseSafeWrapper-C24d6oy5.js";import"./useSubscription-DJEgHQrc.js";import"./useGroups-DlFUXECJ.js";import"./useUserRole-B8Vd-TTd.js";import"./ui-forms-BvHfx7SG.js";import"./bluetooth-BEoGU70i.js";function D(e,t,a,n){const d=(a-e)*Math.PI/180,o=(n-t)*Math.PI/180,s=Math.sin(d/2)*Math.sin(d/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2);return 6371e3*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function et(e,t){const a=D(e.latitude,e.longitude,t.latitude,t.longitude),n=(new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())/1e3;return n>0?a/n:0}function nt(e){if(e.length<2)return"stationary";const t=[];for(let n=1;n<e.length;n++)t.push(et(e[n-1],e[n]));const a=t.reduce((n,c)=>n+c,0)/t.length;return a<.5?"stationary":a<5?"walking":"transport"}function q(e,t){return{stationary:{high:50,medium:100,low:200},walking:{high:100,medium:200,low:400},transport:{high:500,medium:1e3,low:2e3}}[e]?.[t]||200}function ot(e){const t={"Indoor restaurant":144e5,"Indoor hospital":864e5,"Indoor school":288e5,"Indoor gym":216e5,"Outdoor transport":18e5,"Outdoor at home":432e5,"Outdoor at work":288e5,Outdoor:72e5};return t[e]||t.Outdoor}function at(e,t,a){const n=nt([...t,e]);if(n==="stationary"){const s=a.find(m=>{const f=D(e.latitude,e.longitude,m.location.latitude,m.location.longitude),S=q(n,m.quality);return f<=S&&m.expiresAt>Date.now()});if(s)return s.hitCount++,s.lastUsed=Date.now(),!1}const c=q(n,"medium"),d=n==="transport"?15*60*1e3:60*60*1e3;return!a.find(s=>{const m=D(e.latitude,e.longitude,s.location.latitude,s.location.longitude),f=Date.now()-s.lastUsed<d;return m<=c&&s.expiresAt>Date.now()&&f})}function it(e,t){return e.sort((a,n)=>{const c=t.filter(o=>o.locations.some(s=>D(a.latitude,a.longitude,s.latitude,s.longitude)<100)).length,d=t.filter(o=>o.locations.some(s=>D(n.latitude,n.longitude,s.latitude,s.longitude)<100)).length;return c!==d?d-c:new Date(n.timestamp).getTime()-new Date(a.timestamp).getTime()})}function k(e){const t=Date.now();return e.filter(a=>a.expiresAt>t)}function U(){if(!navigator.onLine)return"offline";const e=navigator.connection;return e?e.effectiveType==="4g"||e.effectiveType==="5g"||e.effectiveType==="3g"?"fast":"slow":"fast"}async function rt(){try{return(await navigator.getBattery?.())?.level||1}catch{return 1}}async function ct(){const e=U(),t=await rt();return e==="offline"||t<.2&&e==="slow"}const F="locationEnrichmentCache",N="locationMovementPatterns",G=100,st=50;function ut(){const[e,t]=l.useState(!1),[a,n]=l.useState(null),[c,d]=l.useState([]),[o,s]=l.useState([]),[m,f]=l.useState([]),S=l.useRef([]),R=l.useRef(!1);l.useEffect(()=>{const r=localStorage.getItem(F),i=localStorage.getItem(N);if(r)try{const u=JSON.parse(r);d(k(u))}catch(u){console.error("Failed to parse location cache:",u)}if(i)try{f(JSON.parse(i))}catch(u){console.error("Failed to parse movement patterns:",u)}},[]),l.useEffect(()=>{localStorage.setItem(F,JSON.stringify(c))},[c]),l.useEffect(()=>{localStorage.setItem(N,JSON.stringify(m))},[m]),l.useEffect(()=>{const i=setInterval(async()=>{if(!(R.current||S.current.length===0)){R.current=!0;try{if(await ct()){p.debug("Throttling location enrichment due to device state");return}const y=U(),w=y==="fast"?3:1,E=it(S.current,m),h=E.splice(0,w);for(const g of h)await b(g),await new Promise(v=>setTimeout(v,y==="fast"?500:1500));S.current=E}finally{R.current=!1}}},2e3);return()=>clearInterval(i)},[m]);const M=l.useCallback((r,i,u,y="medium")=>{const w=Date.now()+ot(i);d(E=>{const h=[...E,{location:r,context:i,displayName:u,quality:y,expiresAt:w,hitCount:1,lastUsed:Date.now()}];return h.length>G?h.sort((g,v)=>v.hitCount*v.lastUsed-g.hitCount*g.lastUsed).slice(0,G):h})},[]),I=l.useCallback(r=>{const i=k(c);return i.length!==c.length&&d(i),i.find(u=>D(r.latitude,r.longitude,u.location.latitude,u.location.longitude)<=100&&u.expiresAt>Date.now())||null},[c]),b=l.useCallback(async r=>{try{p.debug("API enriching location",`${r.latitude}, ${r.longitude}`);const{data:i,error:u}=await tt.functions.invoke("enhance-location-context",{body:{latitude:r.latitude,longitude:r.longitude,timestamp:r.timestamp,useSmartCaching:!0}});if(u)throw new Error(u.message);return i?.enhanced_context&&M(r,i.enhanced_context,i.display_name||"","high"),{...i,source:"nominatim",confidence:.9}}catch(i){const u=i instanceof Error?i.message:"Failed to enrich location";return console.error("API location enrichment error:",u),n(u),null}},[M]),C=l.useCallback(async(r,i,u)=>{if(!r||!i)return n("Invalid coordinates"),null;const y={latitude:r,longitude:i,timestamp:u||new Date().toISOString()};t(!0),n(null);try{s(h=>[...h,y].slice(-st));const w=I(y);if(w)return p.debug("Using local cache for location enrichment"),w.hitCount++,w.lastUsed=Date.now(),{enhanced_context:w.context,display_name:w.displayName,source:"local-cache",confidence:Math.min(.8+w.hitCount*.05,.95)};if(!at(y,o,c)){S.current.push(y),p.debug("Added location to enrichment queue");const h=c.filter(g=>D(r,i,g.location.latitude,g.location.longitude)<=500).sort((g,v)=>{const O=D(r,i,g.location.latitude,g.location.longitude),P=D(r,i,v.location.latitude,v.location.longitude);return O-P})[0];if(h)return{enhanced_context:h.context,display_name:h.displayName,source:"local-cache",confidence:.6}}return await b(y)}finally{t(!1)}},[I,o,c,b]),_=l.useCallback(async()=>{p.debug("Starting predictive enrichment for frequent locations");const r=m.filter(i=>i.frequency>3).flatMap(i=>i.locations).filter(i=>!I(i));S.current.push(...r)},[m,I]),A=l.useCallback(r=>{const i=new Date(r.timestamp).getHours(),u=new Date(r.timestamp).getDay(),y=i<6?"night":i<12?"morning":i<18?"afternoon":"evening";f(w=>{const E=w.find(h=>h.timeOfDay===y&&h.dayOfWeek===u&&h.locations.some(g=>D(r.latitude,r.longitude,g.latitude,g.longitude)<200));return E?(E.frequency++,[...w]):[...w,{locations:[r],frequency:1,timeOfDay:y,dayOfWeek:u}]})},[]);return l.useEffect(()=>{if(o.length>0){const r=o[o.length-1];A(r)}},[o,A]),T("smart-location-enrichment-state",15e3,"üîß SmartLocationEnrichment state:",{hasEnrichLocation:!!C,loading:e,error:!!a,cacheSize:c.length,queueSize:S.current.length}),{enrichLocation:C,preEnrichFrequentLocations:_,loading:e,error:a,cacheSize:c.length,queueSize:S.current.length}}function lt(){const{isEnabled:e}=V(),{enrichLocation:t,preEnrichFrequentLocations:a}=ut(),{latestLocation:n}=B(!0,!0);return e&&T("location-enrichment-integration-state",1e4,"üîß LocationEnrichmentIntegration state:",{isEnabled:e,hasEnrichFunction:!!t,hasLocation:!!n}),l.useEffect(()=>{if(e&&n){const c=setTimeout(()=>{t(n.latitude,n.longitude,new Date().toISOString()).catch(d=>{console.error("Location enrichment error:",d)})},2e3);return()=>clearTimeout(c)}},[e,n?.latitude,n?.longitude,t]),l.useEffect(()=>{if(!e)return;const c=setInterval(()=>{a().catch(d=>{p.debug("Predictive enrichment error:",d)})},10*60*1e3);return()=>clearInterval(c)},[e,a]),e&&p.debug("LocationEnrichmentIntegration returning",{hasEnrichFunction:!!t,isEnabled:e}),{enrichLocation:e?t:null}}const dt="0123456789bcdefghjkmnpqrstuvwxyz";function Q(e,t,a=8){if(e<-90||e>90)throw new Error("Latitude must be between -90 and 90");if(t<-180||t>180)throw new Error("Longitude must be between -180 and 180");if(a<1||a>12)throw new Error("Precision must be between 1 and 12");let n=[-90,90],c=[-180,180],d="",o=0,s=0,m=!0;for(;d.length<a;){if(m){const f=(c[0]+c[1])/2;t>=f?(s=s<<1|1,c[0]=f):(s=s<<1,c[1]=f)}else{const f=(n[0]+n[1])/2;e>=f?(s=s<<1|1,n[0]=f):(s=s<<1,n[1]=f)}m=!m,o++,o===5&&(d+=dt[s],o=0,s=0)}return d}function qt(){const e=J(),{currentData:t,isRecording:a,addDataPoint:n,recordingFrequency:c,missionContext:d,latestLocation:o,speedKmh:s,gpsQuality:m,isConnected:f}=e;T("global-data-collector-state",5e3,"üîç GlobalDataCollector STATE:",{isRecording:a,hasCurrentData:!!t,isConnected:f,hasAddDataPoint:!!n,willProceed:a&&!!t&&!!n});const{getWeatherForMeasurement:S}=K(),{isEnabled:R}=Z(),{settings:M}=X($.AUTO_CONTEXT_SETTINGS,{enabled:!1}),{updateContextIfNeeded:I}=Y({recordingFrequency:c,isRecording:a&&M.enabled}),{enrichLocation:b}=lt(),{settings:C}=j();p.debug("Location enrichment state",{hasEnrichLocation:!!b,enrichLocationType:typeof b}),T("geohash-state",1e4,"üó∫Ô∏è GEOHASH STATE:",{enabled:C.enabled,hasLocation:!!o,isRecording:a,willGenerate:C.enabled&&!!o&&a&&!!t});const _=l.useRef(null),A=l.useRef(null),r=localStorage.getItem("recording-location")||d.location||"",i=localStorage.getItem("recording-activity")||d.activity||"";return l.useEffect(()=>{r!==d.location||d.activity},[r,i,d]),l.useEffect(()=>{p.info(`Recording state changed: ${a?"STARTED":"STOPPED"}`)},[a]),l.useEffect(()=>{T("current-data-availability",3e3,"üìä Data availability:",{hasData:!!t,pm25:t?.pm25})},[t]),l.useEffect(()=>{p.debug("Recording service availability",{hasAddDataPoint:!!n})},[n]),l.useEffect(()=>{if(a&&T("data-collection-trigger",2e3,"üîç Data collection triggered:",{hasCurrentData:!!t,isConnected:f,willProceed:!!t&&!!n}),!n){p.debug("Recording service not ready, skipping data collection");return}if(a&&t){const y=(h=>{const g=parseInt(h);return h.includes("s")?g*1e3:h.includes("m")?g*60*1e3:1e4})(c),w=t.timestamp.getTime(),E=!A.current||w-A.current.getTime()>=y;if(T("frequency-check",5e3,"üîç Frequency check:",{frequency:c,shouldRecord:E,pm25:t.pm25}),E){p.debug("Recording data point",{pm25:t.pm25});const h=t.timestamp.getTime();_.current&&_.current.pm25===t.pm25&&Math.abs(h-_.current.timestamp)<500||(p.info("Adding data point",{pm25:t.pm25,frequency:c}),(async()=>{const O=s,P=O>2;let x="";if(T("enrichment-check",3e3,"üîç Location enrichment check:",{hasFunction:!!b,hasLocation:!!(o?.latitude&&o?.longitude),willProceed:E&&!!b&&!!(o?.latitude&&o?.longitude)}),E&&b&&o?.latitude&&o?.longitude)try{p.debug("Enriching location during recording",{lat:o.latitude,lng:o.longitude});const L=await b(o.latitude,o.longitude,t.timestamp.toISOString());L?.display_name&&(x=L.display_name,p.info("Location enriched successfully",{display_name:L.display_name,source:L.source}))}catch(L){console.warn("Failed to enrich location during recording:",L)}const z=M.enabled?await I(t,o||void 0,O,P):"";A.current=t.timestamp;let H=null;if(R&&o?.latitude&&o?.longitude)try{H=await S(o.latitude,o.longitude,t.timestamp)}catch(L){p.debug("Failed to fetch weather data for measurement:",L)}n(t,o||void 0,{location:r,activity:i},z,x,C.enabled&&o?.latitude&&o?.longitude?Q(o.latitude,o.longitude,C.precision):void 0)})(),_.current={pm25:t.pm25,timestamp:h},A.current=t.timestamp)}}},[a,t,f,o,n,r,i,I,c,S,R,b,C,Q]),l.useEffect(()=>{a&&W(async()=>{const{clearLocationHistory:u}=await import("./speedCalculator-DnWD_VUK.js");return{clearLocationHistory:u}},[]).then(({clearLocationHistory:u})=>{u(),p.debug("Cleared location history for new recording session")})},[a]),null}export{qt as GlobalDataCollector,qt as default};
