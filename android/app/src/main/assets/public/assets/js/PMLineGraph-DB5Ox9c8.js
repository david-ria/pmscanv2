import{j as o}from"./query-BewfWFH7.js";import{b as p}from"./vendor-CRCfYjC_.js";import{f as h}from"./timeFormat-CCn9v1Tp.js";import{ResponsiveContainer as L,LineChart as $,CartesianGrid as N,XAxis as E,YAxis as I,Tooltip as z,Legend as F,Line as v,ReferenceArea as R,ReferenceLine as b}from"./charts-Do_EPC5m.js";import"./utils-EL5wpLGY.js";function q({data:u,events:x=[],className:y,hideTitle:M=!1,highlightContextType:m,missionContext:g}){const r=p.useMemo(()=>!u||!Array.isArray(u)||u.length===0?[]:u.sort((t,e)=>t.pmData.timestamp.getTime()-e.pmData.timestamp.getTime()).map((t,e)=>({time:t.pmData.timestamp.getTime(),sequentialIndex:e+1,timestamp:h(t.pmData.timestamp),fullTimestamp:t.pmData.timestamp,PM1:t.pmData.pm1,PM25:t.pmData.pm25,PM10:t.pmData.pm10,temp:t.pmData.temp,humidity:t.pmData.humidity,context:t.context})),[u]),A=p.useMemo(()=>!Array.isArray(x)||!x.length||!Array.isArray(r)||!r.length?[]:(console.log("Processing events for chart:",x.length,"events, ",r.length,"data points"),x.map(t=>{const e=t.timestamp instanceof Date?t.timestamp:new Date(t.timestamp),n=e.getTime();let s=-1,a=1/0;return r.forEach((c,l)=>{const d=c.fullTimestamp.getTime(),i=Math.abs(d-n);i<a&&(a=i,s=l)}),s>=0&&a<6e4?(console.log("Event matched to chart:",t.event_type,"at position",r[s].time),{...t,chartPosition:r[s].time,timeString:h(e)}):(console.log("Event not matched:",t.event_type,"time diff:",a),null)}).filter(Boolean)),[x,r]),D=p.useCallback((t,e)=>t==="activity"?{indoor:"#8b5cf6",outdoor:"#22c55e",transport:"#ef4444",walking:"#3b82f6",cycling:"#f59e0b",driving:"#dc2626",train:"#7c3aed",bus:"#ea580c",metro:"#9333ea",undergroundTransport:"#6366f1",sport:"#059669",rest:"#64748b",work:"#0891b2",meeting:"#e11d48",shopping:"#db2777",cooking:"#84cc16",cleaning:"#06b6d4",studying:"#8b5cf6",jogging:"#10b981"}[e.toLowerCase()]||"#6b7280":t==="location"?{home:"#22c55e",office:"#3b82f6",school:"#f59e0b",indoor:"#8b5cf6",outdoor:"#10b981",transport:"#ef4444",underground:"#6366f1",park:"#84cc16",mainstreet:"#64748b"}[e.toLowerCase()]||"#6b7280":"#3b82f6",[]),w=p.useMemo(()=>{if(!m||!r.length)return[];const t=[];let e=r[0].time,n="",s="";if(r.forEach((a,c)=>{const{context:l}=a,d=a.time,i=m==="location"?l?.locationContext||g?.locationContext:m==="activity"?l?.activityContext||g?.activityContext:m==="autocontext"?l?.automaticContext:void 0;let f="",P="";if(i&&i!=="unknown"&&(f=i,P=D(m,i)),c<3&&console.log(`Processing entry ${c}:`,{measurementContext:l,missionContext:g,selectedContextType:m,resolvedValue:i,finalLabel:f}),n!==f){if(n!==""&&e<d){const C=r.findIndex(j=>j.time>=e),k=r.slice(C,c),S=k.length>0?k.reduce((j,T)=>j+T.PM25,0)/k.length:0;t.push({start:e,end:d,label:n,color:s,pm25Average:S})}f!==""?(e=d,n=f,s=P):(n="",s="")}}),n!==""&&r.length>0){const a=r[r.length-1].time,c=r.findIndex(i=>i.time>=e),l=r.slice(c),d=l.length>0?l.reduce((i,f)=>i+f.PM25,0)/l.length:0;t.push({start:e,end:a+(a-r[Math.max(0,r.length-2)].time),label:n,color:s,pm25Average:d})}return console.log("Generated context periods:",t),console.log("Periods details:",t.map(a=>({label:a.label,start:a.start,end:a.end,duration:a.end-a.start,dataPoints:a.end-a.start,pm25Average:a.pm25Average.toFixed(1)}))),t},[r,m,g,D]),W=(t,e)=>e==="PM1"||e==="PM25"||e==="PM10"?[`${t} Âµg/mÂ³`,e]:e==="temp"?[`${t}Â°C`,"TempÃ©rature"]:e==="humidity"?[`${t}%`,"HumiditÃ©"]:[t,e];return r.length===0?o.jsx("div",{className:`flex items-center justify-center h-full bg-card border border-border rounded-lg ${y}`,children:o.jsxs("div",{className:"text-center text-muted-foreground",children:[o.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“Š"}),o.jsx("p",{className:"text-lg font-medium",children:"Aucune donnÃ©e disponible"}),o.jsx("p",{className:"text-sm mt-2",children:"DÃ©marrez un enregistrement pour voir le graphique en temps rÃ©el"})]})}):o.jsxs("div",{className:`bg-card border border-border rounded-lg p-4 ${y}`,children:[!M&&o.jsxs("div",{className:"mb-4",children:[o.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Ã‰volution des particules fines (Âµg/mÂ³)"}),o.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.length," points de donnÃ©es â€¢ DerniÃ¨re mesure:"," ",r[r.length-1]?.timestamp]})]}),o.jsx(L,{width:"100%",height:"100%",children:o.jsxs($,{data:r,margin:{top:80,right:5,left:0,bottom:80},children:[o.jsx(N,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),o.jsx(E,{dataKey:"time",type:"number",scale:"time",domain:["dataMin","dataMax"],tick:{fontSize:10},angle:-45,textAnchor:"end",height:60,tickFormatter:t=>h(new Date(t))}),o.jsx(I,{tick:{fontSize:12},width:30,domain:[0,"dataMax + 5"],allowDataOverflow:!1}),o.jsx(z,{formatter:W,labelFormatter:t=>`Temps: ${h(new Date(t))}`,contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"6px",color:"hsl(var(--foreground))"}}),o.jsx(F,{}),o.jsx(v,{type:"monotone",dataKey:"PM1",stroke:"#22c55e",strokeWidth:2,dot:!1,activeDot:{r:5,stroke:"#22c55e"}}),o.jsx(v,{type:"monotone",dataKey:"PM25",stroke:"#ef4444",strokeWidth:2,dot:!1,activeDot:{r:5,stroke:"#ef4444"}}),o.jsx(v,{type:"monotone",dataKey:"PM10",stroke:"#3b82f6",strokeWidth:2,dot:!1,activeDot:{r:5,stroke:"#3b82f6"}}),w.map((t,e)=>{const n=t.end-t.start,s=t.start+n/2;return o.jsxs(p.Fragment,{children:[o.jsx(R,{x1:t.start,x2:t.end,fill:t.color,fillOpacity:.15,stroke:t.color,strokeOpacity:.4,strokeWidth:1}),o.jsx(b,{x:s,stroke:"transparent",strokeWidth:0,label:{value:`${t.pm25Average.toFixed(1)} Âµg/mÂ³`,position:"top",fontSize:12,fill:"#ef4444",textAnchor:"middle",fontWeight:"bold",offset:25,style:{textShadow:"1px 1px 2px rgba(255,255,255,0.9)",fontWeight:"bold"}}}),o.jsx(b,{x:s,stroke:"transparent",strokeWidth:0,label:{value:t.label,position:"top",fontSize:14,fill:t.color,textAnchor:"middle",fontWeight:"bold",offset:65,style:{textShadow:"1px 1px 2px rgba(255,255,255,0.8)",fontWeight:"bold"}}})]},`period-${e}`)}),A.map((t,e)=>{const n=t.event_type||t._type||"Event",s=n==="undefined"?"Event":n;return o.jsxs(p.Fragment,{children:[o.jsx(b,{x:t.chartPosition,stroke:"#f97316",strokeWidth:3,strokeDasharray:"3 3"}),o.jsx(b,{x:t.chartPosition,stroke:"transparent",strokeWidth:0,label:{value:s,position:"top",fontSize:12,fill:"#f97316",textAnchor:"start",fontWeight:"bold",offset:100+e*20,style:{textShadow:"1px 1px 2px rgba(255,255,255,0.9)",fontWeight:"bold",transform:"rotate(-90deg)",transformOrigin:"center"}}})]},t.id)})]})})]})}export{q as PMLineGraph};
