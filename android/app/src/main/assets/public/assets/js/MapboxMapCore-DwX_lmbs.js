const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/mapInitializer-BPty4L8F.js","assets/js/index-DnKT6hDb.js","assets/js/supabase--OITQzG1.js","assets/js/vendor-CRCfYjC_.js","assets/js/query-BewfWFH7.js","assets/js/router-D6wdMmGF.js","assets/js/theme-D-6-9UvQ.js","assets/js/ui-core-CibF-ClQ.js","assets/js/utils-EL5wpLGY.js","assets/js/notifications-6vUXhpBr.js","assets/js/i18n-DZz6YkIP.js","assets/index-BOVYw4lO.css","assets/js/mapLayers-C3VFlJvJ.js","assets/js/mapStyles-CsZyDteM.js","assets/js/mapEventHandlers-CHIiS9qu.js","assets/js/mapMarker-Dhfw_6YF.js","assets/js/mapStyleToggle-97Afa0f9.js","assets/js/MapboxMapControls-DfUXW-Eh.js","assets/js/eventTypes-ynSrOkd7.js","assets/js/satellite-BoAS3NdR.js","assets/js/badge-D3qJDj1M.js"])))=>i.map(i=>d[i]);
import{_ as n}from"./supabase--OITQzG1.js";import{j as e}from"./query-BewfWFH7.js";import{r as l,b as A}from"./vendor-CRCfYjC_.js";import{C as L}from"./card-CRF2Wp6a.js";import{B as w}from"./badge-D3qJDj1M.js";import{T as q,B as S}from"./index-DnKT6hDb.js";import{useThresholds as B}from"./ThresholdContext-1SyiABzf.js";import{L as T}from"./loader-circle-CMvZ_kLu.js";import{M as N}from"./eventTypes-ynSrOkd7.js";const Z=({currentLocation:s,pmData:u,trackPoints:i=[],isRecording:d=!1,className:x,autoLoadOnRecording:g=!1})=>{const _=l.useRef(null),a=l.useRef(null),M=l.useRef(null),[r,I]=l.useState(!1),[c,p]=l.useState(!1),[E,h]=l.useState(null),[b,R]=l.useState(!1),[v,C]=l.useState(!1),{thresholds:f,getAirQualityLevel:j}=B(),P=async()=>{const[{initializeMap:t},{createLocationMarker:o},{updateTrackData:y,updateLayerStyles:F},{toggleMapStyle:O},V]=await Promise.all([n(()=>import("./mapInitializer-BPty4L8F.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14])),n(()=>import("./mapMarker-Dhfw_6YF.js"),__vite__mapDeps([15,13])),n(()=>import("./mapLayers-C3VFlJvJ.js"),__vite__mapDeps([12,13])),n(()=>import("./mapStyleToggle-97Afa0f9.js"),__vite__mapDeps([16,13,14])),n(()=>import("./MapboxMapControls-DfUXW-Eh.js"),__vite__mapDeps([17,4,3,1,2,5,6,7,8,9,10,11,18,19,20])).then(z=>z.MapboxMapControls)]);return{initializeMap:t,createLocationMarker:o,updateTrackData:y,updateLayerStyles:F,toggleMapStyle:O,MapboxMapControls:V}},m=async()=>{if(!(!_.current||a.current||c)){p(!0),h(null),C(!0);try{console.debug("[PERF] ðŸ—ºï¸ User requested map - loading Mapbox GL...");const o=await(await P()).initializeMap(_.current,s,f,()=>{p(!1),I(!0),console.debug("[PERF] âœ… Mapbox GL fully loaded and initialized")},y=>{h(y),p(!1)});a.current=o}catch(t){const o=t instanceof Error?t.message:"Failed to load map";h(o),p(!1),console.error("[PERF] âŒ Failed to load Mapbox GL:",t)}}};l.useEffect(()=>{const t=localStorage.getItem("recording-confirmed")==="true";if(console.debug("[PERF] ðŸ—ºï¸ Map auto-load check:",{autoLoadOnRecording:g,isRecording:d,recordingConfirmed:t,trackPointsLength:i.length,mapboxLoaded:r,loading:c,userRequested:v}),g&&d&&t&&!r&&!c){console.debug("[PERF] ðŸŽ¬ Recording confirmed after frequency selection - auto-loading map..."),m(),localStorage.removeItem("recording-confirmed");return}if(i.length>0&&!d&&!r&&!c){console.debug("[PERF] ðŸ“Š Historical data detected - auto-loading map for",i.length,"points..."),m();return}(localStorage.getItem("mapbox-user-preference")==="enabled"||d)&&!r&&!c&&(console.debug("[PERF] ðŸ”„ Auto-loading map for recording or returning user..."),m())},[g,d,i.length,r,v,c]),l.useEffect(()=>()=>{if(a.current)try{a.current.getContainer()&&a.current.remove()}catch(t){console.warn("Error removing map:",t)}finally{a.current=null}},[]),l.useEffect(()=>{if(console.log("ðŸ—ºï¸ === MAP LOCATION UPDATE ===",{hasMap:!!a.current,hasCurrentLocation:!!s,mapboxLoaded:r,currentLocation:s?{lat:s.latitude,lng:s.longitude,accuracy:s.accuracy}:null}),!a.current||!s||!r){console.log("ðŸ—ºï¸ Skipping marker update - missing requirements");return}(async()=>{console.log("ðŸ—ºï¸ Creating location marker for:",{lat:s.latitude,lng:s.longitude,pm25:u?.pm25});const{createLocationMarker:t}=await n(async()=>{const{createLocationMarker:o}=await import("./mapMarker-Dhfw_6YF.js");return{createLocationMarker:o}},__vite__mapDeps([15,13]));M.current=t(a.current,s,u,j,M.current),console.log("ðŸ—ºï¸ Location marker created successfully")})()},[s,u,j,r]),l.useEffect(()=>{!a.current||!r||(async()=>{const{updateTrackData:t}=await n(async()=>{const{updateTrackData:o}=await import("./mapLayers-C3VFlJvJ.js");return{updateTrackData:o}},__vite__mapDeps([12,13]));t(a.current,i,d)})()},[i,d,r]),l.useEffect(()=>{!a.current||!r||(async()=>{const{updateLayerStyles:t}=await n(async()=>{const{updateLayerStyles:o}=await import("./mapLayers-C3VFlJvJ.js");return{updateLayerStyles:o}},__vite__mapDeps([12,13]));t(a.current,f)})()},[f,r]);const k=async()=>{if(!a.current||!r)return;const{toggleMapStyle:t}=await n(async()=>{const{toggleMapStyle:o}=await import("./mapStyleToggle-97Afa0f9.js");return{toggleMapStyle:o}},__vite__mapDeps([16,13,14]));t(a.current,b,i,f,R)},D=()=>{localStorage.setItem("mapbox-user-preference","enabled"),m()};return E?e.jsx(L,{className:`p-6 ${x||""}`,children:e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[e.jsx(q,{className:"h-8 w-8 text-destructive mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:E}),e.jsx(S,{variant:"outline",onClick:m,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4 mr-2 animate-spin"}),"Retrying..."]}):"Retry Map Load"})]})}):!r&&!d&&i.length===0?e.jsx(L,{className:`p-6 ${x||""}`,children:e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center space-y-4",children:[e.jsx("div",{className:"p-4 rounded-full bg-primary/10",children:e.jsx(N,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Interactive Map"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Load the map to visualize air quality data and track your location"}),e.jsx(w,{variant:"secondary",className:"text-xs mb-4",children:"~2MB â€¢ Loads on demand"})]}),e.jsxs(S,{onClick:D,children:[e.jsx(N,{className:"h-4 w-4 mr-2"}),"Load Map"]})]})}):e.jsxs("div",{className:`relative ${x||""}`,children:[c&&e.jsx("div",{className:"absolute inset-0 bg-background/80 backdrop-blur-sm z-10 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(T,{className:"h-6 w-6 animate-spin text-primary"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading interactive map..."}),e.jsx(w,{variant:"secondary",className:"text-xs",children:"Loading Mapbox GL (~2MB)"})]})}),e.jsx("div",{ref:_,className:"w-full h-full rounded-lg overflow-hidden"}),r&&e.jsx(A.Suspense,{fallback:e.jsx("div",{children:"Loading controls..."}),children:e.jsx(G,{isSatellite:b,onToggleMapStyle:k,currentLocation:s})})]})},G=A.lazy(async()=>{const{MapboxMapControls:s}=await n(async()=>{const{MapboxMapControls:u}=await import("./MapboxMapControls-DfUXW-Eh.js");return{MapboxMapControls:u}},__vite__mapDeps([17,4,3,1,2,5,6,7,8,9,10,11,18,19,20]));return{default:s}});export{Z as M};
