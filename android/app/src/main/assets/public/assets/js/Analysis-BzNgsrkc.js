import{j as t}from"./query-BewfWFH7.js";import{r as $}from"./vendor-CRCfYjC_.js";import{R as qe,a as oe,D as Ye}from"./DateFilter-D9eU-HB0.js";import{c as Ke,u as he,B as Q,R as ie,d as U}from"./index-DnKT6hDb.js";import{C as Te,b as Re,c as Ae,a as Oe}from"./card-CRF2Wp6a.js";import{D as Je,a as Xe,b as Ze,c as et,e as tt,f as st}from"./dialog-DfKWiEIF.js";import{I as at}from"./input-CGNY8--s.js";import{L as se}from"./label-Dli8bNIx.js";import{T as nt,a as ot,b as Ee,c as Ne}from"./tabs-D4ABolrV.js";import{u as q}from"./i18n-DZz6YkIP.js";import{D as J}from"./download-DC3Z7BQM.js";import{M as it}from"./mail-R-xk0620.js";import{a as rt}from"./useDialog-D4PBCj81.js";import{E as lt}from"./pdf-RpjoWNzX.js";import{b as ct}from"./timeFormat-CCn9v1Tp.js";import{h as V,s as ce,e as ue,a as de,b as me,c as pe,d as xe,f as ge,g as ye,i as Ie}from"./date-CHE04W6Q.js";import{f as fe}from"./fr-CdMURzWB.js";import{C as ut}from"./chart-column-BZUAHE40.js";import{ResponsiveContainer as dt,PieChart as mt,Pie as pt,Cell as xt,Tooltip as gt,Legend as yt}from"./charts-Do_EPC5m.js";import{d as ht}from"./useMissionSaver-CXd3xg0u.js";import{u as ft}from"./useEvents-B2RSjdE6.js";import"./ui-forms-BvHfx7SG.js";import"./ui-core-CibF-ClQ.js";import"./circle-BxKWKjZR.js";import"./chevron-right-DkkaQXkL.js";import"./popover-C65wazzN.js";import"./calendar-p0zw62Sr.js";import"./supabase--OITQzG1.js";import"./router-D6wdMmGF.js";import"./theme-D-6-9UvQ.js";import"./utils-EL5wpLGY.js";import"./notifications-6vUXhpBr.js";import"./client-zGYq1VIw.js";import"./supabaseSafeWrapper-C24d6oy5.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=Ke("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),vt=({open:n,onOpenChange:s,onExport:e,loading:o})=>{const{t:a}=q(),{toast:y}=he(),[D,u]=$.useState(""),[c,v]=$.useState("download"),E=async()=>{try{if(c==="email"){if(!D.trim()){y({title:a("analysis.emailRequired"),description:a("analysis.emailRequiredDescription"),variant:"destructive"});return}if(!D.includes("@")){y({title:a("analysis.invalidEmail"),description:a("analysis.invalidEmailDescription"),variant:"destructive"});return}await e("email",D)}else await e("download");s(!1),u("")}catch(h){console.error("Export failed:",h),y({title:a("analysis.exportFailed"),description:a("analysis.exportFailedDescription"),variant:"destructive"})}};return t.jsx(Je,{open:n,onOpenChange:s,children:t.jsxs(Xe,{className:"sm:max-w-[425px]",children:[t.jsxs(Ze,{children:[t.jsxs(et,{className:"flex items-center gap-2",children:[t.jsx(J,{className:"h-5 w-5"}),a("analysis.exportReport")]}),t.jsx(tt,{children:a("analysis.exportReportDescription")})]}),t.jsxs(nt,{value:c,onValueChange:v,children:[t.jsxs(ot,{className:"grid w-full grid-cols-2",children:[t.jsxs(Ee,{value:"download",className:"flex items-center gap-2",children:[t.jsx(J,{className:"h-4 w-4"}),a("analysis.download")]}),t.jsxs(Ee,{value:"email",className:"flex items-center gap-2",children:[t.jsx(it,{className:"h-4 w-4"}),a("analysis.sendByEmail")]})]}),t.jsx(Ne,{value:"download",className:"space-y-4",children:t.jsxs("div",{className:"text-center py-4",children:[t.jsx(J,{className:"h-12 w-12 mx-auto text-primary mb-2"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:a("analysis.downloadDescription")})]})}),t.jsx(Ne,{value:"email",className:"space-y-4",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx(se,{htmlFor:"email",children:a("analysis.emailAddress")}),t.jsx(at,{id:"email",type:"email",placeholder:a("analysis.enterEmailAddress"),value:D,onChange:h=>u(h.target.value),disabled:o})]})})]}),t.jsxs(st,{children:[t.jsx(Q,{variant:"outline",onClick:()=>s(!1),disabled:o,children:a("common.cancel")}),t.jsx(Q,{onClick:E,disabled:o,children:o?t.jsxs(t.Fragment,{children:[t.jsx(ke,{className:"h-4 w-4 mr-2 animate-spin"}),a(c==="email"?"analysis.sending":"analysis.generating")]}):t.jsxs(t.Fragment,{children:[c==="email"?t.jsx(ke,{className:"h-4 w-4 mr-2"}):t.jsx(J,{className:"h-4 w-4 mr-2"}),a(c==="email"?"analysis.sendEmail":"analysis.downloadPDF")]})})]})]})})},Mt=()=>{const{toast:n}=he(),s=(l,x)=>{n({title:l,description:x,variant:"default"})},e=(l,x)=>{n({title:l,description:x,variant:"destructive"})},o=(l,x)=>{n({title:l,description:x,variant:"destructive"})},a=(l,x)=>{n({title:l,description:x,variant:"default"})},y=l=>{s(`${l} successful`,`The ${l.toLowerCase()} was completed successfully.`)};return{notifySuccess:s,notifyError:e,notifyWarning:o,notifyInfo:a,notifyOperationSuccess:y,notifyOperationError:(l,x)=>{e(`${l} failed`,x||`An error occurred while ${l.toLowerCase()}. Please try again.`)},notifyDataSaved:()=>y("Save"),notifyDataDeleted:()=>y("Delete"),notifyDataCreated:()=>y("Create"),notifyDataUpdated:()=>y("Update"),notifyValidationError:l=>{e("Validation Error",l?`Please check the ${l} field.`:"Please check all required fields.")},notifyNetworkError:()=>{e("Network Error","Please check your internet connection and try again.")}}},wt=async n=>{const s=new lt,e=s.internal.pageSize.getWidth(),o=s.internal.pageSize.getHeight();let a=20;s.setFontSize(20),s.setFont("helvetica","bold"),s.text("Rapport d'Analyse de la QualitÃ© de l'Air",e/2,a,{align:"center"}),a+=20,s.setFontSize(12),s.setFont("helvetica","normal");const y=$t(n.selectedPeriod,n.selectedDate);return s.text(`PÃ©riode: ${y}`,e/2,a,{align:"center"}),a+=15,s.setFontSize(10),s.text(`GÃ©nÃ©rÃ© le: ${V(new Date,"dd/MM/yyyy Ã  HH:mm",{locale:fe})}`,e/2,a,{align:"center"}),a+=20,s.setFontSize(14),s.setFont("helvetica","bold"),s.text("RÃ©partition de la Pollution",20,a),a+=10,s.setFontSize(10),s.setFont("helvetica","normal"),s.text(`Type de particules: PM${n.pmType.replace("pm","")}`,20,a),a+=5,s.text(`RÃ©partition par: ${Pt(n.breakdownType)}`,20,a),a+=15,n.breakdownData.length>0&&(s.setFont("helvetica","bold"),s.text("CatÃ©gorie",20,a),s.text("Pourcentage",80,a),s.text("PM Moyen (Î¼g/mÂ³)",130,a),s.text("Exposition (min)",170,a),a+=8,s.setFont("helvetica","normal"),n.breakdownData.forEach(u=>{s.text(u.name,20,a),s.text(`${u.percentage.toFixed(1)}%`,80,a),s.text(`${Math.round(u.avgPM)}`,130,a),s.text(ct(u.exposure),170,a),a+=6}),a+=15),a>o-60&&(s.addPage(),a=20),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Analyse Statistique",20,a),a+=15,s.setFontSize(10),s.setFont("helvetica","normal"),s.splitTextToSize(n.statisticalAnalysis,e-40).forEach(u=>{a>o-20&&(s.addPage(),a=20),s.text(u,20,a),a+=5}),s.output("blob")},$t=(n,s)=>{const e={locale:fe};switch(n){case"day":return V(s,"dd MMMM yyyy",e);case"week":const o=new Date(s);o.setDate(s.getDate()-s.getDay()+1);const a=new Date(o);return a.setDate(o.getDate()+6),`Semaine du ${V(o,"dd MMM",e)} au ${V(a,"dd MMM yyyy",e)}`;case"month":return V(s,"MMMM yyyy",e);case"year":return V(s,"yyyy",e);default:return V(s,"dd/MM/yyyy",e)}},Pt=n=>{switch(n){case"location":return"Localisation";case"activity":return"ActivitÃ©";case"autocontext":return"Contexte automatique";default:return n}},jt=(n,s)=>{const e=URL.createObjectURL(n),o=document.createElement("a");o.href=e,o.download=s,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(e)},Dt=({statisticalAnalysis:n,loading:s,onRegenerate:e,selectedPeriod:o,selectedDate:a,breakdownData:y,pmType:D,breakdownType:u})=>{const{t:c}=q(),v=rt(),{notifyInfo:E}=Mt(),[h,f]=$.useState(!1),l=async(x,M)=>{f(!0);try{const T=await wt({selectedPeriod:o,selectedDate:a,statisticalAnalysis:n,breakdownData:y,pmType:D,breakdownType:u});if(x==="download"){const z=`rapport-analyse-${V(a,"yyyy-MM-dd",{locale:fe})}.pdf`;jt(T,z)}else x==="email"&&M&&E("Email functionality is coming soon!")}finally{f(!1)}};return n?t.jsxs(Te,{className:"mb-6",children:[t.jsx(Re,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(Ae,{className:"flex items-center gap-2",children:[t.jsx(ut,{className:"h-5 w-5 text-primary"}),c("analysis.statisticalAnalysis")]}),t.jsxs(Q,{variant:"outline",size:"sm",onClick:e,disabled:s,children:[s?t.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}):t.jsx(ie,{className:"h-4 w-4 mr-2"}),c(s?"analysis.analyzing":"analysis.refresh")]})]})}),t.jsx(Oe,{children:s?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(ie,{className:"h-8 w-8 mx-auto text-primary animate-spin mb-4"}),t.jsx("p",{className:"text-muted-foreground",children:c("analysis.analysisInProgress")})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"bg-muted/20 p-4 rounded-lg border-l-4 border-primary/30 mb-6",children:t.jsxs("div",{className:"text-sm space-y-2",children:[t.jsxs("div",{className:"font-medium text-foreground flex items-center gap-2",children:["ðŸ’¡ ",c("analysis.doseCalculation.title")]}),t.jsxs("div",{className:"text-muted-foreground",children:[t.jsxs("strong",{children:[c("analysis.doseCalculation.formula"),":"]})," ",c("analysis.doseCalculation.formulaText")]}),t.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[t.jsxs("div",{children:["â€¢ ",t.jsxs("strong",{children:[c("analysis.doseCalculation.concentration"),":"]})," ",c("analysis.doseCalculation.concentrationDesc")]}),t.jsxs("div",{children:["â€¢ ",t.jsxs("strong",{children:[c("analysis.doseCalculation.time"),":"]})," ",c("analysis.doseCalculation.timeDesc")]}),t.jsxs("div",{children:["â€¢ ",t.jsxs("strong",{children:[c("analysis.doseCalculation.respiratoryRate"),":"]})," ",c("analysis.doseCalculation.respiratoryRateDesc")]})]}),t.jsx("div",{className:"text-xs text-muted-foreground/80 italic",children:c("analysis.doseCalculation.explanation")})]})}),t.jsx("div",{className:"whitespace-pre-line text-sm text-foreground leading-relaxed font-mono",children:n}),t.jsx("div",{className:"flex gap-2 mt-4",children:t.jsxs(Q,{variant:"outline",size:"sm",className:"flex-1",onClick:v.openDialog,disabled:h,children:[t.jsx(J,{className:"h-3 w-3 mr-2"}),c("analysis.exportReport")]})}),t.jsx(vt,{open:v.open,onOpenChange:v.onOpenChange,onExport:l,loading:h})]})})]}):null},bt=({pmType:n,onPMTypeChange:s})=>t.jsxs("div",{className:"flex justify-center gap-2 py-4 my-4",children:[t.jsx(Q,{variant:n==="pm1"?"default":"outline",size:"sm",onClick:()=>s("pm1"),className:"min-w-12 px-2",children:"PM1"}),t.jsx(Q,{variant:n==="pm25"?"default":"outline",size:"sm",onClick:()=>s("pm25"),className:"min-w-12 px-2",children:"PM2.5"}),t.jsx(Q,{variant:n==="pm10"?"default":"outline",size:"sm",onClick:()=>s("pm10"),className:"min-w-12 px-2",children:"PM10"})]}),Et=({breakdownType:n,onBreakdownTypeChange:s})=>{const{t:e}=q();return t.jsxs(qe,{value:n,onValueChange:o=>s(o),className:"flex flex-row justify-center gap-2 sm:gap-4",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(oe,{value:"location",id:"location"}),t.jsx(se,{htmlFor:"location",className:"cursor-pointer text-sm",children:e("analysis.location")})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(oe,{value:"activity",id:"activity"}),t.jsx(se,{htmlFor:"activity",className:"cursor-pointer text-sm",children:e("analysis.activity")})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(oe,{value:"autocontext",id:"autocontext"}),t.jsx(se,{htmlFor:"autocontext",className:"cursor-pointer text-sm",children:e("analysis.autocontext")})]})]})},Ce=({breakdownData:n,pmType:s})=>{const{t:e}=q(),o=({active:u,payload:c})=>{if(u&&c&&c.length){const v=c[0].payload;return t.jsxs("div",{className:"bg-background border border-border rounded-md p-2 text-sm shadow-md",children:[t.jsx("p",{className:"text-foreground font-medium",children:v.name}),t.jsxs("p",{className:"text-foreground",children:[c[0].value.toFixed(1),"%"]}),t.jsxs("p",{className:"text-foreground",children:["PM",s.replace("pm",""),": ",Math.round(v.avgPM)," Î¼g/mÂ³"]})]})}return null};if(n.length===0)return t.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e("analysis.noDataForPeriod")});const a=u=>window.innerWidth<400||u.percentage<5?null:`${u.percentage.toFixed(0)}%`,y=window.innerWidth<640,D=window.innerWidth<400;return t.jsx("div",{className:"w-full h-full min-h-[200px]",children:t.jsx(dt,{width:"100%",height:"100%",children:t.jsxs(mt,{children:[t.jsx(pt,{data:n,cx:"50%",cy:"50%",outerRadius:y?"60%":"70%",innerRadius:D?"20%":"0%",fill:"#8884d8",dataKey:"percentage",label:a,labelLine:!1,children:n.map((u,c)=>t.jsx(xt,{fill:u.color},`cell-${c}`))}),t.jsx(gt,{content:t.jsx(o,{})}),!D&&t.jsx(yt,{wrapperStyle:{fontSize:y?"11px":"12px",paddingTop:"10px"}})]})})})},Se=({breakdownData:n,pmType:s,whoThreshold:e})=>{const{t:o}=q();return n.length===0?t.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:o("analysis.noDataAvailable")}):t.jsx("div",{className:"space-y-2",children:n.map(a=>{const y=e.value&&a.avgPM>e.value;return t.jsxs("div",{className:"flex items-start gap-3 p-3 bg-muted/30 rounded-lg",children:[t.jsx("div",{className:"w-4 h-4 rounded-full mt-0.5 flex-shrink-0",style:{backgroundColor:a.color}}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"font-medium text-sm mb-1",children:a.name}),t.jsxs("div",{className:"text-xs text-muted-foreground mb-1",children:[Math.round(a.exposure)," ",o("analysis.minutes")," â€¢ PM",s.replace("pm",""),": ",Math.round(a.avgPM)," Î¼g/mÂ³",e.value&&t.jsxs("span",{className:`ml-2 ${y?"text-red-600":"text-green-600"}`,children:["(",o(y?"analysis.exceeds":"analysis.complies")," ",o("analysis.whoThreshold"),": ",e.value," Î¼g/mÂ³)"]})]}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:[o("analysis.cumulativeDose"),": ",a.cumulativeDose.toFixed(1)," Î¼g"]})]}),t.jsxs("div",{className:"text-right flex-shrink-0",children:[t.jsxs("div",{className:"font-medium text-sm",children:[a.percentage.toFixed(0),"%"]}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:[(a.exposure/60).toFixed(1),"h"]})]})]},a.name)})})},Fe=n=>{const s=["#10b981","#3b82f6","#f59e0b","#f97316","#ef4444","#8b5cf6","#ec4899"],e=n.split("").reduce((o,a)=>o+a.charCodeAt(0),0);return s[e%s.length]},Nt=(n,s,e)=>{if(n==="pm1")return{value:null,label:e("analysis.noWHOThreshold")};const o=s==="day"||s==="week";return n==="pm25"?o?{value:15,label:e("analysis.whoThresholdDaily",{value:15})}:{value:5,label:e("analysis.whoThresholdAnnual",{value:5})}:n==="pm10"?o?{value:45,label:e("analysis.whoThresholdDaily",{value:45})}:{value:15,label:e("analysis.whoThresholdAnnual",{value:15})}:{value:null,label:""}},W={rest:.5,sleeping:.4,sitting:.5,reading:.5,watching_tv:.5,computer_work:.5,office_work:.5,light_housework:.8,cooking:.8,eating:.6,standing:.6,driving:.6,light_office:.7,walking:1.2,walking_slow:1,walking_moderate:1.2,shopping:1.1,cleaning:1.3,gardening:1.4,moderate_housework:1.3,walking_fast:1.8,jogging:2.5,running:3,cycling:2.2,cycling_moderate:2,cycling_intense:2.8,sports:2.5,exercise:2.3,gym:2.3,dancing:2,running_fast:3.5,intense_sports:3.2,intense_exercise:3,home:.6,work:.7,office:.7,outdoor:1.2,indoor:.6,transport:.6,car:.6,public_transport:.6,school:.7,restaurant:.6,shop:1,gym_location:2.3},kt=.8;function B(n,s,e){if(n){const o=re(n);if(W[o]!==void 0)return W[o];const a=le(o,W);if(a!==null)return a}if(e){const o=re(e);if(W[o]!==void 0)return W[o];const a=le(o,W);if(a!==null)return a}if(s){const o=re(s);if(W[o]!==void 0)return W[o];const a=le(o,W);if(a!==null)return a}return kt}function re(n){return n.toLowerCase().trim().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"")}function le(n,s){for(const[e,o]of Object.entries(s))if(n.includes(e)||e.includes(n))return o;return n.includes("walk")?s.walking:n.includes("run")?s.running:n.includes("cycl")||n.includes("bike")?s.cycling:n.includes("sport")?s.sports:n.includes("exerc")?s.exercise:n.includes("work")&&n.includes("house")?s.light_housework:n.includes("driv")?s.driving:n.includes("sit")?s.sitting:n.includes("stand")?s.standing:null}const Ct=(n,s,e,o,a)=>$.useMemo(()=>{const y=()=>{let u,c;switch(s){case"day":u=ge(e),c=ye(e);break;case"week":u=pe(e,{weekStartsOn:1}),c=xe(e,{weekStartsOn:1});break;case"month":u=de(e),c=me(e);break;case"year":u=ce(e),c=ue(e);break;default:return n}return n.filter(v=>{const E=new Date(v.startTime);return Ie(E,{start:u,end:c})})};return(()=>{const u=y();if(console.log("Pollution breakdown - Total missions:",n.length,"Filtered missions:",u.length,"Breakdown type:",o),u.length===0)return[];const c=new Map;u.forEach(h=>{if(o==="autocontext"){const f=new Map;h.measurements.forEach(l=>{const x=l.automaticContext||"Inconnu",M=a==="pm1"?l.pm1:a==="pm25"?l.pm25:l.pm10,F=f.get(x)||{totalExposure:0,weightedPM:0,cumulativeDose:0},T=h.durationMinutes/h.measurements.length,z=T/60,P=B(l.activityContext,l.locationContext,l.automaticContext);F.totalExposure+=T,F.weightedPM+=M*T,F.cumulativeDose+=M*z*P,f.set(x,F)}),f.forEach((l,x)=>{const M=c.get(x)||{totalExposure:0,weightedPM:0,cumulativeDose:0,color:Fe(x)};M.totalExposure+=l.totalExposure,M.weightedPM+=l.weightedPM,M.cumulativeDose+=l.cumulativeDose,c.set(x,M)})}else{const f=new Map;h.measurements.forEach(l=>{let x="";switch(o){case"location":x=l.locationContext||"Inconnue";break;case"activity":x=l.activityContext||"Inconnue";break}const M=a==="pm1"?l.pm1:a==="pm25"?l.pm25:l.pm10,F=f.get(x)||{totalExposure:0,weightedPM:0,cumulativeDose:0},T=h.durationMinutes/h.measurements.length,z=T/60,P=B(l.activityContext,l.locationContext,l.automaticContext);F.totalExposure+=T,F.weightedPM+=M*T,F.cumulativeDose+=M*z*P,f.set(x,F)}),f.forEach((l,x)=>{const M=c.get(x)||{totalExposure:0,weightedPM:0,cumulativeDose:0,color:Fe(x)};M.totalExposure+=l.totalExposure,M.weightedPM+=l.weightedPM,M.cumulativeDose+=l.cumulativeDose,c.set(x,M)})}});const v=Array.from(c.entries()).map(([h,f])=>{const l=f.totalExposure>0?f.weightedPM/f.totalExposure:0;return{name:h,avgPM:l,color:f.color,exposure:f.totalExposure,cumulativeDose:f.cumulativeDose}}).filter(h=>h.avgPM>0).sort((h,f)=>f.avgPM-h.avgPM).slice(0,5),E=v.reduce((h,f)=>h+f.exposure,0);return v.map(h=>({...h,percentage:E>0?h.exposure/E*100:0}))})()},[n,s,e,o,a]),St=({missions:n,selectedPeriod:s,selectedDate:e,onBreakdownDataChange:o})=>{const{t:a}=q(),[y,D]=$.useState("activity"),[u,c]=$.useState("pm25"),v=Ct(n,s,e,y,u),E=Nt(u,s,a);return $.useEffect(()=>{o&&o({breakdownData:v,pmType:u,breakdownType:y})},[v,u,y,o]),t.jsxs(Te,{className:"mb-6",children:[t.jsxs(Re,{className:"pb-4 sm:pb-6",children:[t.jsx(Ae,{className:"text-lg mb-3",children:a("analysis.dataAnalysis")}),t.jsx("p",{className:"text-sm text-muted-foreground mb-4 sm:mb-8",children:a("analysis.chartExplanation")}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(bt,{pmType:u,onPMTypeChange:c}),t.jsx(Et,{breakdownType:y,onBreakdownTypeChange:D})]})]}),t.jsxs(Oe,{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-6 lg:hidden",children:[t.jsx("div",{className:"w-full",children:t.jsx("div",{className:"h-64 sm:h-80 w-full",children:t.jsx(Ce,{breakdownData:v,pmType:u})})}),t.jsxs("div",{className:"w-full",children:[t.jsxs("div",{className:"flex flex-col gap-2 mb-3",children:[t.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("analysis.detailedSummary")}),t.jsx("div",{className:"text-xs text-muted-foreground",children:E.label})]}),t.jsx(Se,{breakdownData:v,pmType:u,whoThreshold:E})]})]}),t.jsx("div",{className:"hidden lg:block",children:t.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[t.jsx("div",{className:"h-80",children:t.jsx(Ce,{breakdownData:v,pmType:u})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2",children:[t.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("analysis.detailedSummary")}),t.jsx("div",{className:"text-xs text-muted-foreground",children:E.label})]}),t.jsx(Se,{breakdownData:v,pmType:u,whoThreshold:E})]})]})})]})]})},Ft=(n,s)=>{const{t:e}=q(),[o,a]=$.useState([]),[y,D]=$.useState(""),[u,c]=$.useState(null),[v,E]=$.useState(!1),[h,f]=$.useState(!1),[l,x]=$.useState([]),[M,F]=$.useState([]),{toast:T}=he(),{getEventsByMission:z}=ft(),P=$.useMemo(()=>{let w,j;switch(s){case"day":w=ge(n),j=ye(n);break;case"week":w=pe(n,{weekStartsOn:1}),j=xe(n,{weekStartsOn:1});break;case"month":w=de(n),j=me(n);break;case"year":w=ce(n),j=ue(n);break;default:return o}const g=o.filter(d=>{const k=new Date(d.startTime),N=Ie(k,{start:w,end:j});return U(`Mission "${d.name}": start=${d.startTime}, parsed=${k.toISOString()}, inRange=${N}, duration=${d.durationMinutes}`),N});return U(`Filtered ${g.length} out of ${o.length} missions for period ${s}`),g},[o,n,s]),ve=$.useCallback(async()=>{try{const w=await ht.getAllMissions();a(w)}catch(w){console.error("Error loading missions:",w),T({title:e("analysis.error"),description:e("analysis.errorLoadingMissions"),variant:"destructive"})}},[T,e]),Me=$.useCallback(()=>{try{if(P.length===0){x([]);return}const w=new Map;P.forEach(g=>{const d=g.activityContext||e("analysis.unknownActivity"),k=B(g.activityContext,g.locationContext,void 0),N=w.get(d)||{totalDuration:0,totalPM25:0,cumulativeDose:0,measurements:0,respiratoryRate:k},C=g.actualRecordingMinutes||g.durationMinutes,I=C/60,H=g.avgPm25*I*k;N.totalDuration+=C,N.totalPM25+=g.avgPm25*C,N.cumulativeDose+=H,N.measurements+=g.measurementsCount,N.respiratoryRate=k,w.set(d,N)});const j=Array.from(w.entries()).map(([g,d])=>({activity:g,timeSpent:d.totalDuration,cumulativeDose:d.cumulativeDose,averageExposure:d.totalDuration>0?d.totalPM25/d.totalDuration:0,measurements:d.measurements,respiratoryRate:d.respiratoryRate}));j.sort((g,d)=>d.cumulativeDose-g.cumulativeDose),x(j)}catch(w){console.error("Error loading activity data:",w),x([])}},[P,e]),we=$.useCallback(async()=>{try{if(P.length===0){F([]);return}const w=new Map;for(const g of P)try{const d=await z(g.id);for(const k of d){const N=k.eventType||"unknown",C=new Date(k.timestamp);w.has(N)||w.set(N,{events:[],pmMeasurements:[],surroundingPmMeasurements:[]});const I=w.get(N);I.events.push(k);const H=2*60*1e3,A=5*60*1e3,_=g.measurements.filter(S=>{const G=new Date(S.timestamp);return Math.abs(G.getTime()-C.getTime())<=H}),X=g.measurements.filter(S=>{const G=new Date(S.timestamp),Y=Math.abs(G.getTime()-C.getTime());return Y>H&&Y<=A});_.forEach(S=>{I.pmMeasurements.push({pm1:S.pm1,pm25:S.pm25,pm10:S.pm10,timestamp:new Date(S.timestamp)})}),X.forEach(S=>{I.surroundingPmMeasurements.push({pm1:S.pm1,pm25:S.pm25,pm10:S.pm10,timestamp:new Date(S.timestamp)})})}}catch(d){console.error(`Error loading events for mission ${g.id}:`,d)}const j=Array.from(w.entries()).map(([g,d])=>{const k=d.pmMeasurements.length>0?d.pmMeasurements.reduce((A,_)=>A+_.pm25,0)/d.pmMeasurements.length:0,N=d.pmMeasurements.length>0?d.pmMeasurements.reduce((A,_)=>A+_.pm10,0)/d.pmMeasurements.length:0,C=d.pmMeasurements.length>0?d.pmMeasurements.reduce((A,_)=>A+_.pm1,0)/d.pmMeasurements.length:0,I=d.surroundingPmMeasurements.length>0?d.surroundingPmMeasurements.reduce((A,_)=>A+_.pm25,0)/d.surroundingPmMeasurements.length:0,H=I>0?(k-I)/I*100:0;return{eventType:g,eventCount:d.events.length,avgPM25DuringEvent:k,avgPM10DuringEvent:N,avgPM1DuringEvent:C,avgPM25AroundEvent:I,eventImpact:H}});j.sort((g,d)=>d.eventImpact-g.eventImpact),F(j)}catch(w){console.error("Error loading event analysis:",w),F([])}},[P,z]),ae=$.useCallback(async()=>{E(!0);try{if(U("Total missions available:",o.length),U("Filtered missions for analysis:",P.length),U("Selected period:",s),U("Selected date:",n),o.length>0){U("All mission dates:",o.map(R=>({name:R.name,startTime:R.startTime,dateString:new Date(R.startTime).toLocaleDateString()})));const i=new Date,r=s==="day"?ge(n):s==="week"?pe(n,{weekStartsOn:1}):s==="month"?de(n):ce(n),b=s==="day"?ye(n):s==="week"?xe(n,{weekStartsOn:1}):s==="month"?me(n):ue(n);U("Date range for filtering:",{startDate:r.toISOString(),endDate:b.toISOString(),todayForReference:i.toISOString()})}if(P.length===0){const i=o.length>0;D(i?`${e(`analysis.noDataForPeriod.${s}`)}

${e("analysis.youHaveMissions",{count:o.length})}

${e("analysis.tryTo")}
${e("analysis.changePeriod")}
${e("analysis.selectDifferentDate")}
${e("analysis.goToHistory")}`:`${e("analysis.noDataAvailable")}

${e("analysis.forPersonalizedAnalysis")}
${e("analysis.goToRealTime")}
${e("analysis.connectSensor")}
${e("analysis.startRecording")}
${e("analysis.comeBackHere")}`),c({totalMissions:o.length,totalExposureMinutes:0,averagePM25:0,maxPM25:0,timeAboveWHO:0}),f(!0);return}const w=e(s==="day"?"history.periods.day":s==="week"?"history.periods.week":s==="month"?"history.periods.month":"history.periods.year"),j=P.filter(i=>i.avgPm25!=null&&!isNaN(i.avgPm25)&&i.avgPm1!=null&&!isNaN(i.avgPm1)&&i.avgPm10!=null&&!isNaN(i.avgPm10)),g=P.reduce((i,r)=>i+(r.actualRecordingMinutes||r.durationMinutes||0),0),d=j.reduce((i,r)=>{const b=r.actualRecordingMinutes||r.durationMinutes||0;return i+r.avgPm1*b},0),k=j.reduce((i,r)=>{const b=r.actualRecordingMinutes||r.durationMinutes||0;return i+r.avgPm25*b},0),N=j.reduce((i,r)=>{const b=r.actualRecordingMinutes||r.durationMinutes||0;return i+r.avgPm10*b},0),C=j.reduce((i,r)=>i+(r.actualRecordingMinutes||r.durationMinutes||0),0),I=C>0?d/C:0,H=C>0?k/C:0,A=C>0?N/C:0,_=j.length>0?Math.max(...j.map(i=>i.avgPm1||0)):0,X=j.length>0?Math.max(...j.map(i=>i.maxPm25||0)):0,S=j.length>0?Math.max(...j.map(i=>i.avgPm10||0)):0,G=P.reduce((i,r)=>{if(!r.measurements||r.measurements.length===0)return i;const R=(r.actualRecordingMinutes||r.durationMinutes||0)/r.measurements.length,L=r.measurements.filter(K=>K.pm25>15).length;return i+L*R},0),Y=P.reduce((i,r)=>{if(!r.measurements||r.measurements.length===0)return i;const R=(r.actualRecordingMinutes||r.durationMinutes||0)/r.measurements.length,L=r.measurements.filter(K=>K.pm10>45).length;return i+L*R},0),He=P.reduce((i,r)=>{const R=(r.actualRecordingMinutes||r.durationMinutes)/60,L=B(r.activityContext,r.locationContext,void 0);return i+r.avgPm25*R*L},0),_e=P.reduce((i,r)=>{const R=(r.actualRecordingMinutes||r.durationMinutes)/60,L=B(r.activityContext,r.locationContext,void 0);return i+r.avgPm10*R*L},0),Le=(g/60).toFixed(1),Rt=(P.reduce((i,r)=>i+(r.durationMinutes||0),0)/60).toFixed(1),We=g>0?(G/g*100).toFixed(1):0,Be=g>0?(Y/g*100).toFixed(1):0,$e=P.reduce((i,r)=>i+(r.durationMinutes||0),0),Pe=$e>0?g/$e*100:100,ze=()=>{const i=Math.max(H,A/3);return i<=12?`âœ… ${e("analysis.airQuality.good")}`:i<=35?`âš ï¸ ${e("analysis.airQuality.moderate")}`:i<=55?`ðŸ”¶ ${e("analysis.airQuality.poor")}`:`ðŸ”´ ${e("analysis.airQuality.veryPoor")}`},Ue=i=>{const r={location:new Map,activity:new Map,autocontext:new Map};i.forEach(m=>{m.measurements.forEach(p=>{const O=m.durationMinutes/m.measurements.length,Ge=O/60,Qe=B(p.activityContext,p.locationContext,p.automaticContext),ne=p.pm25*Ge*Qe,je=p.locationContext||"Inconnue",Z=r.location.get(je)||{exposure:0,dose:0,avgPM:0};Z.exposure+=O,Z.dose+=ne,Z.avgPM+=p.pm25*O,r.location.set(je,Z);const De=p.activityContext||"Inconnue",ee=r.activity.get(De)||{exposure:0,dose:0,avgPM:0};if(ee.exposure+=O,ee.dose+=ne,ee.avgPM+=p.pm25*O,r.activity.set(De,ee),p.automaticContext&&p.automaticContext!=="unknown"){const be=p.automaticContext,te=r.autocontext.get(be)||{exposure:0,dose:0,avgPM:0};te.exposure+=O,te.dose+=ne,te.avgPM+=p.pm25*O,r.autocontext.set(be,te)}})});let b="";const R=Array.from(r.location.entries()).map(([m,p])=>({name:m,...p,avgPM:p.exposure>0?p.avgPM/p.exposure:0})).filter(m=>m.exposure>0).sort((m,p)=>p.dose-m.dose);R.length>0&&(b+=`ðŸ  ${e("analysis.report.locationAnalysis")}:
`,R.slice(0,3).forEach((m,p)=>{const O=B(void 0,m.name,void 0);b+=`${p+1}. ${m.name}: ${m.dose.toFixed(1)} ${e("analysis.units.ug")} (${(m.exposure/60).toFixed(1)}${e("analysis.units.hours")}, PM2.5=${m.avgPM.toFixed(1)} ${e("analysis.units.ugm3")}, ${e("analysis.units.rate")}=${O} ${e("analysis.units.m3h")})
`}),b+=`
`);const L=Array.from(r.activity.entries()).map(([m,p])=>({name:m,...p,avgPM:p.exposure>0?p.avgPM/p.exposure:0})).filter(m=>m.exposure>0).sort((m,p)=>p.dose-m.dose);L.length>0&&(b+=`ðŸƒ ${e("analysis.report.activityAnalysis")}:
`,L.slice(0,3).forEach((m,p)=>{const O=B(m.name,void 0,void 0);b+=`${p+1}. ${m.name}: ${m.dose.toFixed(1)} ${e("analysis.units.ug")} (${(m.exposure/60).toFixed(1)}${e("analysis.units.hours")}, PM2.5=${m.avgPM.toFixed(1)} ${e("analysis.units.ugm3")}, ${e("analysis.units.rate")}=${O} ${e("analysis.units.m3h")})
`}),b+=`
`);const K=Array.from(r.autocontext.entries()).map(([m,p])=>({name:m,...p,avgPM:p.exposure>0?p.avgPM/p.exposure:0})).filter(m=>m.exposure>0).sort((m,p)=>p.dose-m.dose);return K.length>0&&(b+=`ðŸ¤– ${e("analysis.report.autoContextAnalysis")}:
`,K.slice(0,3).forEach((m,p)=>{const O=B(void 0,void 0,m.name);b+=`${p+1}. ${m.name}: ${m.dose.toFixed(1)} ${e("analysis.units.ug")} (${(m.exposure/60).toFixed(1)}${e("analysis.units.hours")}, PM2.5=${m.avgPM.toFixed(1)} ${e("analysis.units.ugm3")}, ${e("analysis.units.rate")}=${O} ${e("analysis.units.m3h")})
`})),b||`â€¢ ${e("analysis.report.noContextData")}`},Ve=`ðŸ“Š ${e("analysis.report.title")} - ${w.toUpperCase()}

ðŸ”¢ ${e("analysis.report.dataSummary")}:
â€¢ ${e("analysis.report.missionCount")}: ${P.length}
â€¢ ${e("analysis.report.totalExposureTime")}: ${Math.round(g)} ${e("analysis.minutes")} (${Le} ${e("analysis.report.hours")})${Pe<95?` [${e("analysis.report.recordingCoverage")}: ${Pe.toFixed(1)}%]`:""}

ðŸŒ«ï¸ ${e("analysis.report.particleAverages")}:
â€¢ PM1.0: ${I.toFixed(1)} Î¼g/mÂ³ (max: ${_.toFixed(1)} Î¼g/mÂ³)
â€¢ PM2.5: ${H.toFixed(1)} Î¼g/mÂ³ (max: ${X.toFixed(1)} Î¼g/mÂ³)
â€¢ PM10: ${A.toFixed(1)} Î¼g/mÂ³ (max: ${S.toFixed(1)} Î¼g/mÂ³)

ðŸ’¨ ${e("analysis.report.inhaledDose")}:
â€¢ PM2.5: ${He.toFixed(1)} Î¼g
â€¢ PM10: ${_e.toFixed(1)} Î¼g
â€¢ ${e("analysis.report.doseFormula")}: Dose = âˆ‘(Concentration Ã— ${e("analysis.report.exposureTime")} Ã— ${e("analysis.report.respiratoryRate")})

ðŸ“ ${e("analysis.report.contextualAnalysis")}:
${Ue(P)}

âš ï¸ ${e("analysis.report.whoThresholds")}:
â€¢ PM2.5 > 15 Î¼g/mÂ³: ${G.toFixed(0)} min (${We}% ${e("analysis.report.ofTime")})
â€¢ PM10 > 45 Î¼g/mÂ³: ${Y.toFixed(0)} min (${Be}% ${e("analysis.report.ofTime")})
â€¢ PM1.0: ${e("analysis.report.noWhoThresholdPM1")}

ðŸ† ${e("analysis.report.highestExposureMissions")} (PM2.5):
${P.sort((i,r)=>(r.avgPm25||0)-(i.avgPm25||0)).slice(0,3).map((i,r)=>`${r+1}. ${i.name}: PM2.5=${(i.avgPm25||0).toFixed(1)}, PM10=${(i.avgPm10||0).toFixed(1)} Î¼g/mÂ³`).join(`
`)}

ðŸŽ¯ ${e("analysis.report.eventAnalysis")}:
${M.length>0?M.map(i=>`â€¢ ${i.eventType.toUpperCase()} (${i.eventCount} ${e("analysis.report.events")}):
  - PM2.5 ${e("analysis.report.duringEvent")}: ${i.avgPM25DuringEvent.toFixed(1)} Î¼g/mÂ³
  - PM2.5 ${e("analysis.report.normalConditions")}: ${i.avgPM25AroundEvent.toFixed(1)} Î¼g/mÂ³
  - ${e("analysis.report.impact")}: ${i.eventImpact>0?"+":""}${i.eventImpact.toFixed(1)}% ${i.eventImpact>50?"ðŸ”´":i.eventImpact>20?"ðŸŸ¡":"ðŸŸ¢"}
  - ${e("analysis.report.detail")}: PM1=${i.avgPM1DuringEvent.toFixed(1)}, PM10=${i.avgPM10DuringEvent.toFixed(1)} Î¼g/mÂ³`).join(`

`):`â€¢ ${e("analysis.report.noEventsRecorded")}`}

ðŸ“ˆ ${e("analysis.report.globalEvaluation")}:
${ze()}

ðŸ’¡ ${e("analysis.report.recommendations")}:
${H>15||A>45?e("analysis.report.recommendationsHigh"):e("analysis.report.recommendationsGood")}
${M.some(i=>i.eventImpact>50)?`
â€¢ ${e("analysis.report.eventImpactWarning")}`:""}`;D(Ve),c({totalMissions:P.length,totalExposureMinutes:g,averagePM25:H,maxPM25:X,timeAboveWHO:G}),f(!0)}catch(w){console.error("Error generating analysis:",w),D(`${e("analysis.unableToGenerate")}

${e("analysis.forPersonalizedReport")}
${e("analysis.checkRecordedData")}
${e("analysis.goToRealTimeForMeasures")}
${e("analysis.comeBackInMoments")}

${e("analysis.changePeriodIfPersists")}`),T({title:e("analysis.analysisUnavailable"),description:e("analysis.checkDataAndRetry"),variant:"destructive"})}finally{E(!1)}},[P,n,s,e,T,M]);return $.useEffect(()=>{ve()},[ve]),$.useEffect(()=>{o.length>0&&!v&&(ae(),Me(),we())},[o,n,s,v,ae,Me,we]),{missions:o,statisticalAnalysis:y,dataPoints:u,loading:v,analysisGenerated:h,activityData:l,eventAnalysisData:M,regenerateAnalysis:()=>{f(!1),ae()}}};function gs(){const[n,s]=$.useState(new Date),[e,o]=$.useState("day"),[a,y]=$.useState([]),[D,u]=$.useState("pm25"),[c,v]=$.useState("activity"),{missions:E,statisticalAnalysis:h,loading:f,regenerateAnalysis:l}=Ft(n,e),x=M=>{y(M.breakdownData),u(M.pmType),v(M.breakdownType)};return t.jsxs("div",{className:"min-h-screen bg-background px-2 sm:px-4 py-4 sm:py-6",children:[t.jsx("div",{className:"mb-4 sm:mb-6"}),t.jsx(Ye,{selectedDate:n,onDateChange:s,selectedPeriod:e,onPeriodChange:o,className:"mb-4 sm:mb-6"}),t.jsx(St,{missions:E,selectedPeriod:e,selectedDate:n,onBreakdownDataChange:x}),t.jsx(Dt,{statisticalAnalysis:h,loading:f,onRegenerate:l,selectedPeriod:e,selectedDate:n,breakdownData:a,pmType:D,breakdownType:c})]})}export{gs as default};
