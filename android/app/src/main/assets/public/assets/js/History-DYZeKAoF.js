import{j as e}from"./query-BewfWFH7.js";import{b as me,r as x}from"./vendor-CRCfYjC_.js";import{B as z,M as ue}from"./badge-D3qJDj1M.js";import{C as I,b as O,c as H,d as xe,a as W}from"./card-CRF2Wp6a.js";import{c as D,b as P,B as F,u as ae,e as $,d as T,f as he,T as pe}from"./index-DnKT6hDb.js";import{R as fe,a as B,D as ge}from"./DateFilter-D9eU-HB0.js";import{D as se,d as ye,a as re,b as ne,c as ie}from"./dialog-DfKWiEIF.js";import{M as je}from"./mail-R-xk0620.js";import{a as ve,g as Ne}from"./eventTypes-ynSrOkd7.js";import{E as we}from"./external-link-06QHuptX.js";import{M as Ce}from"./MapboxMapCore-DwX_lmbs.js";import{PMLineGraph as be}from"./PMLineGraph-DB5Ox9c8.js";import{L as G}from"./label-Dli8bNIx.js";import{u as R}from"./i18n-DZz6YkIP.js";import{supabase as _}from"./client-zGYq1VIw.js";import{C as Y,F as Me}from"./file-x-Cfc0Kpmj.js";import{A as Z}from"./activity-B8rwkEHL.js";import{u as De}from"./useEvents-B2RSjdE6.js";import{a as J,b as X,d as ke}from"./timeFormat-CCn9v1Tp.js";import"./pdf-RpjoWNzX.js";import{C as oe}from"./calendar-p0zw62Sr.js";import{D as Se}from"./download-DC3Z7BQM.js";import{T as Ee}from"./trash-2-fnkO6k_f.js";import{toast as U}from"./notifications-6vUXhpBr.js";import{R as K}from"./rotate-ccw-oD7EDUkY.js";import{W as Pe}from"./wifi-off-flOeYF_3.js";import{d as Q,g as ee}from"./useMissionSaver-CXd3xg0u.js";import{s as Ae,e as Te,a as $e,b as _e,c as Fe,d as Le,f as Ie,g as Oe,i as He}from"./date-CHE04W6Q.js";import"./supabase--OITQzG1.js";import"./router-D6wdMmGF.js";import"./theme-D-6-9UvQ.js";import"./ui-core-CibF-ClQ.js";import"./utils-EL5wpLGY.js";import"./ui-forms-BvHfx7SG.js";import"./circle-BxKWKjZR.js";import"./chevron-right-DkkaQXkL.js";import"./popover-C65wazzN.js";import"./fr-CdMURzWB.js";import"./ThresholdContext-1SyiABzf.js";import"./loader-circle-CMvZ_kLu.js";import"./charts-Do_EPC5m.js";import"./supabaseSafeWrapper-C24d6oy5.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=D("Car",[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=D("ChefHat",[["path",{d:"M17 21a1 1 0 0 0 1-1v-5.35c0-.457.316-.844.727-1.041a4 4 0 0 0-2.134-7.589 5 5 0 0 0-9.186 0 4 4 0 0 0-2.134 7.588c.411.198.727.585.727 1.041V20a1 1 0 0 0 1 1Z",key:"1qvrer"}],["path",{d:"M6 17h12",key:"1jwigz"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=D("Cigarette",[["path",{d:"M17 12H3a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h14",key:"1mb5g1"}],["path",{d:"M18 8c0-2.5-2-2.5-2-5",key:"1il607"}],["path",{d:"M21 16a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1",key:"1yl5r7"}],["path",{d:"M22 8c0-2.5-2-2.5-2-5",key:"1gah44"}],["path",{d:"M7 12v4",key:"jqww69"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=D("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=D("CloudRain",[["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"M16 14v6",key:"1j4efv"}],["path",{d:"M8 14v6",key:"17c4r9"}],["path",{d:"M12 16v6",key:"c8a4gj"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=D("Factory",[["path",{d:"M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z",key:"159hny"}],["path",{d:"M17 18h1",key:"uldtlt"}],["path",{d:"M12 18h1",key:"s9uhes"}],["path",{d:"M7 18h1",key:"1neino"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=D("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=D("Hammer",[["path",{d:"m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9",key:"eefl8a"}],["path",{d:"m18 15 4-4",key:"16gjal"}],["path",{d:"m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5",key:"b7pghm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=D("Share",[["path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8",key:"1b2hhj"}],["polyline",{points:"16 6 12 2 8 6",key:"m901s6"}],["line",{x1:"12",x2:"12",y1:"2",y2:"15",key:"1p0rca"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=D("Snowflake",[["line",{x1:"2",x2:"22",y1:"12",y2:"12",key:"1dnqot"}],["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"m20 16-4-4 4-4",key:"rquw4f"}],["path",{d:"m4 8 4 4-4 4",key:"12s3z9"}],["path",{d:"m16 4-4 4-4-4",key:"1tumq1"}],["path",{d:"m8 20 4-4 4 4",key:"9p200w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=D("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=D("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=D("Wind",[["path",{d:"M12.8 19.6A2 2 0 1 0 14 16H2",key:"148xed"}],["path",{d:"M17.5 8a2.5 2.5 0 1 1 2 4H2",key:"1u4tom"}],["path",{d:"M9.8 4.4A2 2 0 1 1 11 8H2",key:"75valh"}]]),Xe=({title:t,description:n,headerActions:o,children:s,className:i,contentClassName:r})=>e.jsxs(I,{className:P("w-full",i),children:[(t||n||o)&&e.jsxs(O,{className:"flex flex-row items-center justify-between space-y-0 pb-4",children:[e.jsxs("div",{className:"space-y-1",children:[t&&e.jsx(H,{className:"text-lg font-semibold",children:t}),n&&e.jsx(xe,{children:n})]}),o&&e.jsx("div",{className:"flex items-center space-x-2",children:o})]}),e.jsx(W,{className:P("pt-0",r),children:s})]}),Ke={contentGrid:"grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"},et={interactiveHover:"transition-all duration-200 hover:-translate-y-0.5"},tt={elevated:"card-elevated",interactive:P(et.interactiveHover,"cursor-pointer")};function at({title:t,stats:n,className:o}){const s=i=>{switch(i){case"good":return"text-air-good";case"moderate":return"text-air-moderate";case"poor":return"text-air-poor";default:return"text-foreground"}};return e.jsx(Xe,{title:t,className:P(tt.elevated,o),children:e.jsx("div",{className:P(Ke.contentGrid,"grid-cols-2"),children:n.map((i,r)=>e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:P("text-2xl font-bold",s(i.color)),children:[i.value,i.unit&&e.jsx("span",{className:"text-sm ml-1",children:i.unit})]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:i.label})]},r))})})}function st({mission:t,onShare:n,children:o}){return e.jsxs(se,{children:[e.jsx(ye,{asChild:!0,children:o}),e.jsxs(re,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:"Partager la mission"})}),e.jsxs("div",{className:"flex flex-col gap-3 pt-4",children:[e.jsxs(F,{variant:"outline",onClick:()=>n(t,"email"),className:"justify-start",children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Partager par email"]}),e.jsxs(F,{variant:"outline",onClick:()=>n(t,"sms"),className:"justify-start",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Partager par SMS"]}),navigator.share&&e.jsxs(F,{variant:"outline",onClick:()=>n(t,"native"),className:"justify-start",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Partager (options du tÃ©lÃ©phone)"]})]})]})]})}function rt({mission:t,selectedContextType:n,onContextTypeChange:o}){const{t:s}=R(),i=me.useMemo(()=>{const r=!!(t.locationContext||t.measurements.some(h=>h.locationContext)),l=!!(t.activityContext||t.measurements.some(h=>h.activityContext)),g=t.measurements.some(h=>h.automaticContext&&h.automaticContext!=="unknown");return{location:r,activity:l,autocontext:g}},[t]);return e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-3 text-center",children:"Mise en Ã©vidence des contextes"}),!i.location&&!i.activity&&!i.autocontext?e.jsx("p",{className:"text-xs text-muted-foreground italic text-center",children:"Aucune donnÃ©e de contexte disponible pour cette mission"}):e.jsxs(fe,{value:n,onValueChange:r=>o(r),className:"flex flex-row justify-center gap-2 sm:gap-6",children:[i.location&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{value:"location",id:"location"}),e.jsx(G,{htmlFor:"location",className:"cursor-pointer text-sm",children:s("analysis.location")})]}),i.activity&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{value:"activity",id:"activity"}),e.jsx(G,{htmlFor:"activity",className:"cursor-pointer text-sm",children:s("analysis.activity")})]}),i.autocontext&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{value:"autocontext",id:"autocontext"}),e.jsx(G,{htmlFor:"autocontext",className:"cursor-pointer text-sm",children:s("analysis.autocontext")})]})]})]})}function nt(t){const[n,o]=x.useState(null),[s,i]=x.useState(!1);x.useEffect(()=>{if(!t){o(null);return}(async()=>{i(!0);try{const{data:g,error:h}=await _.from("weather_data").select("*").eq("id",t).maybeSingle();h?(console.warn("Failed to fetch weather data:",h),o(null)):o(g)}catch(g){console.warn("Error fetching weather data:",g),o(null)}finally{i(!1)}})()},[t]);const r=n?`${Math.round(n.temperature)}Â°C, ${n.weather_description}`:null;return{weatherData:n,weatherSummary:r,loading:s}}const te=t=>{switch(t?.toLowerCase()){case"clear":return e.jsx(Ze,{className:"h-3 w-3 text-yellow-500"});case"clouds":return e.jsx(Y,{className:"h-3 w-3 text-gray-500"});case"rain":case"drizzle":return e.jsx(ze,{className:"h-3 w-3 text-blue-500"});case"snow":return e.jsx(Ye,{className:"h-3 w-3 text-blue-200"});default:return e.jsx(Y,{className:"h-3 w-3 text-gray-500"})}};function le({weatherDataId:t,className:n,compact:o=!1}){const{weatherData:s,weatherSummary:i,loading:r}=nt(t);return t?r?e.jsx("div",{className:`text-xs text-muted-foreground ${n}`,children:"Loading weather..."}):s?o?e.jsxs("div",{className:`flex items-center gap-1 text-xs text-muted-foreground ${n}`,children:[te(s.weather_main),e.jsx("span",{children:i})]}):e.jsxs("div",{className:`flex items-center gap-2 text-xs text-muted-foreground ${n}`,children:[te(s.weather_main),e.jsx("span",{children:i}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[s.humidity,"% humidity"]})]}):e.jsxs("div",{className:`text-xs text-muted-foreground ${n}`,children:["Weather: ",t.slice(0,8),"..."]}):null}function de({airQualityDataId:t,compact:n=!1,className:o}){const[s,i]=x.useState(null),[r,l]=x.useState(!0);if(x.useEffect(()=>{t&&(async()=>{try{l(!0);const{data:c,error:u}=await _.from("air_quality_data").select("id, no2_value, o3_value, station_name, data_source, timestamp").eq("id",t).single();if(u){console.error("Error fetching air quality data:",u);return}i(c)}catch(c){console.error("Error in fetchAirQualityData:",c)}finally{l(!1)}})()},[t]),r)return e.jsxs("div",{className:P("flex items-center gap-2 text-muted-foreground",o),children:[e.jsx(ce,{className:"h-4 w-4 animate-pulse"}),e.jsx("span",{className:"text-sm",children:"Chargement qualitÃ© de l'air..."})]});if(!s)return null;const g=(m,c="Âµg/mÂ³")=>m==null?"N/A":`${Math.round(m)} ${c}`,h=(m,c)=>m?c==="no2"?m<=40?"good":m<=90?"moderate":m<=120?"poor":"very-poor":m<=50?"good":m<=100?"moderate":m<=180?"poor":"very-poor":"unknown",f=m=>{switch(m){case"good":return"text-green-600";case"moderate":return"text-yellow-600";case"poor":return"text-orange-600";case"very-poor":return"text-red-600";default:return"text-muted-foreground"}},w=h(s.no2_value,"no2"),M=h(s.o3_value,"o3");return n?e.jsxs("div",{className:P("flex items-center gap-2 text-sm",o),children:[e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"flex gap-3",children:[s.no2_value!==null&&s.no2_value!==void 0&&e.jsxs("span",{className:f(w),children:["NOâ‚‚: ",g(s.no2_value)]}),s.o3_value!==null&&s.o3_value!==void 0&&e.jsxs("span",{className:f(M),children:["Oâ‚ƒ: ",g(s.o3_value)]})]}),s.station_name&&e.jsx("span",{className:"text-muted-foreground text-xs",children:s.station_name})]}):e.jsxs("div",{className:P("space-y-2",o),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"QualitÃ© de l'air"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",s.data_source,")"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.no2_value!==null&&s.no2_value!==void 0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-muted-foreground",children:"Dioxyde d'azote (NOâ‚‚)"}),e.jsx("div",{className:P("font-medium",f(w)),children:g(s.no2_value)})]}),s.o3_value!==null&&s.o3_value!==void 0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-muted-foreground",children:"Ozone (Oâ‚ƒ)"}),e.jsx("div",{className:P("font-medium",f(M)),children:g(s.o3_value)})]})]}),s.station_name&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Station: ",s.station_name]})]})}function it({mission:t,open:n,onOpenChange:o}){const{t:s}=R();ae();const{getEventsByMission:i}=De(),[r,l]=x.useState([]),g=x.useRef(null),h=x.useRef(null),[f,w]=x.useState(()=>{if(!t)return"location";const a=!!(t.locationContext||t.measurements.some(d=>d.locationContext)),p=!!(t.activityContext||t.measurements.some(d=>d.activityContext)),b=t.measurements.some(d=>d.automaticContext&&d.automaticContext!=="unknown");return a?"location":p?"activity":b?"autocontext":"location"});if(x.useEffect(()=>{if(t){const a=!!(t.locationContext||t.measurements.some(d=>d.locationContext)),p=!!(t.activityContext||t.measurements.some(d=>d.activityContext)),b=t.measurements.some(d=>d.automaticContext&&d.automaticContext!=="unknown");w(a?"location":p?"activity":b?"autocontext":"location")}},[t]),x.useEffect(()=>{t&&n&&(console.log("Loading events for mission:",t.id),i(t.id).then(a=>{console.log("Loaded events:",a),l(a)}))},[t,n,i]),!t)return null;const M=t.measurements.map((a,p)=>(p<3&&console.log(`Measurement ${p} context data:`,{measurementLocationContext:a.locationContext,measurementActivityContext:a.activityContext,measurementAutomaticContext:a.automaticContext,missionLocationContext:t.locationContext,missionActivityContext:t.activityContext}),{pmData:{pm1:a.pm1,pm25:a.pm25,pm10:a.pm10,temp:a.temperature||0,humidity:a.humidity||0,battery:100,charging:!1,timestamp:a.timestamp},location:a.latitude&&a.longitude?{latitude:a.latitude,longitude:a.longitude,accuracy:a.accuracy||0,timestamp:a.timestamp}:void 0,context:{locationContext:a.locationContext||t.locationContext,activityContext:a.activityContext||t.activityContext,automaticContext:a.automaticContext}})),m=t.measurements.filter(a=>a.latitude&&a.longitude&&a.latitude!==0&&a.longitude!==0).map(a=>({longitude:a.longitude,latitude:a.latitude,pm25:a.pm25,timestamp:a.timestamp})),c=t.measurements.map(a=>a.pm1),u=t.measurements.map(a=>a.pm25),j=t.measurements.map(a=>a.pm10),y={pm1:{avg:c.reduce((a,p)=>a+p,0)/c.length,min:Math.min(...c),max:Math.max(...c)},pm25:{avg:u.reduce((a,p)=>a+p,0)/u.length,min:Math.min(...u),max:Math.max(...u)},pm10:{avg:j.reduce((a,p)=>a+p,0)/j.length,min:Math.min(...j),max:Math.max(...j)}},S=a=>{const p=new Map;t.measurements.forEach(N=>{let k;switch(a){case"location":k=N.locationContext||t.locationContext;break;case"activity":k=N.activityContext||t.activityContext;break;case"autocontext":k=N.automaticContext;break}if(k&&k!=="unknown"){p.has(k)||p.set(k,{pm1:[],pm25:[],pm10:[],measurementCount:0});const L=p.get(k);L.pm1.push(N.pm1),L.pm25.push(N.pm25),L.pm10.push(N.pm10),L.measurementCount++}});const b={},d=t.measurements.length,A=d>0?t.durationMinutes/d:0;return p.forEach((N,k)=>{const L=N.measurementCount*A;b[k]={pm1:N.pm1.length>0?N.pm1.reduce((q,V)=>q+V,0)/N.pm1.length:0,pm25:N.pm25.length>0?N.pm25.reduce((q,V)=>q+V,0)/N.pm25.length:0,pm10:N.pm10.length>0?N.pm10.reduce((q,V)=>q+V,0)/N.pm10.length:0,timeSpent:L}}),b},E={location:S("location"),activity:S("activity"),autocontext:S("autocontext")},v=a=>a<=12?"text-air-good":a<=35?"text-air-moderate":a<=55?"text-air-poor":"text-air-very-poor",C=t.measurements.find(a=>a.latitude&&a.longitude&&a.latitude!==0&&a.longitude!==0);return e.jsx(se,{open:n,onOpenChange:o,children:e.jsxs(re,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",ref:h,children:[e.jsx(ne,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ie,{className:"text-xl",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[J(t.startTime)," â€¢"," ",X(t.durationMinutes)]}),!t.synced&&e.jsx(z,{variant:"outline",className:"text-xs",children:s("history.local")})]}),t.locationContext&&t.activityContext&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[t.locationContext," â€¢ ",t.activityContext]})]}),e.jsx("div",{className:"flex flex-wrap items-center gap-4 p-3 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-2xl font-bold ${v(t.avgPm25)}`,children:Math.round(t.avgPm25)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Âµg/mÂ³ PM2.5"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold",children:t.measurementsCount}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s("history.measurements")})]})]})}),e.jsxs("div",{className:"space-y-2",children:[t.weatherDataId&&e.jsx(le,{weatherDataId:t.weatherDataId}),t.airQualityDataId&&e.jsx(de,{airQualityDataId:t.airQualityDataId})]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(I,{children:[e.jsx(O,{children:e.jsx(H,{className:"text-lg",children:s("realTime.map")})}),e.jsx(W,{children:e.jsx("div",{className:"h-80 sm:h-96 w-full",children:m.length>0?e.jsx(Ce,{currentLocation:C?{latitude:C.latitude,longitude:C.longitude,accuracy:C.accuracy||0,timestamp:C.timestamp}:null,trackPoints:m,isRecording:!1,className:"h-full w-full"}):e.jsx("div",{className:"h-full bg-muted rounded-lg flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:s("history.noLocationData")})})})})]}),e.jsxs(I,{children:[e.jsx(O,{children:e.jsxs("div",{children:[e.jsx(H,{className:"text-lg",children:"Ã‰volution des particules fines (Âµg/mÂ³)"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[t.measurementsCount," points de donnÃ©es â€¢ DerniÃ¨re mesure: ",J(t.endTime)]})]})}),e.jsxs(W,{className:"space-y-4",children:[e.jsx(rt,{mission:t,selectedContextType:f,onContextTypeChange:w}),e.jsx("div",{className:"h-[450px] sm:h-[520px] w-full overflow-hidden",ref:g,children:e.jsx(be,{data:M,events:r,className:"h-full w-full",hideTitle:!0,highlightContextType:f,missionContext:{locationContext:t.locationContext,activityContext:t.activityContext}})})]})]}),e.jsxs(I,{children:[e.jsx(O,{children:e.jsx(H,{className:"text-lg",children:s("history.statistics")})}),e.jsxs(W,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground mb-3",children:"Overall Averages"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"PM1.0 (Âµg/mÂ³)"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.average"),":"]}),e.jsx("span",{className:"text-sm font-medium",children:y.pm1.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.minimum"),":"]}),e.jsx("span",{className:"text-sm font-medium",children:y.pm1.min.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.maximum"),":"]}),e.jsx("span",{className:"text-sm font-medium",children:y.pm1.max.toFixed(1)})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"PM2.5 (Âµg/mÂ³)"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.average"),":"]}),e.jsx("span",{className:`text-sm font-medium ${v(y.pm25.avg)}`,children:y.pm25.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.minimum"),":"]}),e.jsx("span",{className:`text-sm font-medium ${v(y.pm25.min)}`,children:y.pm25.min.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.maximum"),":"]}),e.jsx("span",{className:`text-sm font-medium ${v(y.pm25.max)}`,children:y.pm25.max.toFixed(1)})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"PM10 (Âµg/mÂ³)"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.average"),":"]}),e.jsx("span",{className:"text-sm font-medium",children:y.pm10.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.minimum"),":"]}),e.jsx("span",{className:"text-sm font-medium",children:y.pm10.min.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("history.maximum"),":"]}),e.jsx("span",{className:"text-sm font-medium",children:y.pm10.max.toFixed(1)})]})]})]})]})]}),Object.entries(E).map(([a,p])=>Object.keys(p).length===0?null:e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"font-medium text-sm text-muted-foreground mb-3 capitalize",children:["Averages by ",a]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:Object.entries(p).map(([b,d])=>e.jsxs("div",{className:"border rounded-lg p-3 bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h5",{className:"font-medium text-sm capitalize",children:b}),e.jsx("div",{className:"text-xs text-muted-foreground",children:X(d.timeSpent)})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-xs",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-muted-foreground",children:"PM1.0"}),e.jsxs("div",{className:"font-medium",children:[d.pm1.toFixed(1)," Âµg/mÂ³"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-muted-foreground",children:"PM2.5"}),e.jsxs("div",{className:`font-medium ${v(d.pm25)}`,children:[d.pm25.toFixed(1)," Âµg/mÂ³"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-muted-foreground",children:"PM10"}),e.jsxs("div",{className:"font-medium",children:[d.pm10.toFixed(1)," Âµg/mÂ³"]})]})]})]},b))})]},a))]})]}),r.length>0&&e.jsxs(I,{children:[e.jsx(O,{children:e.jsxs(H,{className:"text-lg flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5"}),"Recorded Events (",r.length,")"]})}),e.jsx(W,{children:e.jsx("div",{className:"space-y-3",children:r.map((a,p)=>{const b=d=>{switch(d){case"smoker":return e.jsx(qe,{className:"h-4 w-4 text-red-500"});case"truck":return e.jsx(Je,{className:"h-4 w-4 text-blue-500"});case"traffic":return e.jsx(We,{className:"h-4 w-4 text-yellow-500"});case"construction":return e.jsx(Ge,{className:"h-4 w-4 text-orange-500"});case"fire":return e.jsx(Be,{className:"h-4 w-4 text-red-500"});case"dust":return e.jsx(ce,{className:"h-4 w-4 text-gray-500"});case"industrial":return e.jsx(Qe,{className:"h-4 w-4 text-purple-500"});case"cooking":return e.jsx(Re,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Ve,{className:"h-4 w-4 text-blue-500"})}};return e.jsxs("div",{className:"border rounded-lg p-3 space-y-2 bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b(a.eventType),e.jsx("span",{className:"font-medium",children:Ne(a.eventType)})]}),e.jsx(z,{variant:"outline",className:"text-xs",children:new Date(a.timestamp).toLocaleTimeString()})]}),a.comment&&e.jsx("p",{className:"text-sm text-muted-foreground pl-6",children:a.comment}),a.latitude&&a.longitude&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground pl-6",children:[e.jsx(ue,{className:"h-3 w-3"}),e.jsxs("span",{children:[a.latitude.toFixed(6),", ",a.longitude.toFixed(6)]})]})]},a.id||p)})})})]})]})]})})}function ot({mission:t,onExport:n,onDelete:o,onShare:s}){const{t:i}=R(),[r,l]=x.useState(!1),g=f=>f<=12?"text-air-good":f<=35?"text-air-moderate":f<=55?"text-air-poor":"text-air-very-poor",h=f=>{const w=new Date,M=new Date(w.getFullYear(),w.getMonth(),w.getDate()),m=new Date(M.getTime()-24*60*60*1e3),c=new Date(f.getFullYear(),f.getMonth(),f.getDate());return c.getTime()===M.getTime()?i("history.today"):c.getTime()===m.getTime()?i("history.yesterday"):f.toLocaleDateString(void 0,{day:"numeric",month:"short"})};return e.jsxs(e.Fragment,{children:[e.jsxs(I,{className:"relative cursor-pointer hover:shadow-md transition-shadow",onClick:()=>l(!0),children:[e.jsx(O,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(H,{className:"text-base",children:t.name}),!t.synced&&e.jsx(z,{variant:"outline",className:"text-xs",children:i("history.local")})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h(new Date(t.startTime))," â€¢"," ",ke(t.durationMinutes)]}),t.locationContext&&t.activityContext&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[t.locationContext," â€¢ ",t.activityContext]}),t.weatherDataId&&e.jsx("div",{className:"mt-1",children:e.jsx(le,{weatherDataId:t.weatherDataId,compact:!0})}),t.airQualityDataId&&e.jsx("div",{className:"mt-1",children:e.jsx(de,{airQualityDataId:t.airQualityDataId,compact:!0})})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:`text-xl font-bold ${g(t.avgPm25)}`,children:Math.round(t.avgPm25)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Âµg/mÂ³ (",i("history.avg"),")"]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[t.measurementsCount," ",i("history.measurements")]})]})]})}),e.jsx(W,{className:"pt-0",children:e.jsxs("div",{className:"flex items-center gap-2",onClick:f=>f.stopPropagation(),children:[e.jsx(st,{mission:t,onShare:s,children:e.jsxs(F,{variant:"outline",size:"sm",className:"flex-1",children:[e.jsx(Ue,{className:"h-3 w-3 mr-2"}),i("history.share")]})}),e.jsxs(F,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>n(t),children:[e.jsx(Se,{className:"h-3 w-3 mr-2"}),i("history.export")]}),e.jsx(F,{variant:"outline",size:"sm",onClick:()=>o(t.id),children:e.jsx(Ee,{className:"h-3 w-3"})})]})})]}),e.jsx(it,{mission:t,open:r,onOpenChange:l})]})}async function ct(){try{const{data:t,error:n}=await _.from("missions").select(`
        id,
        name,
        measurements_count,
        measurements!inner(id)
      `).gt("measurements_count",0).is("measurements.id",null);if(n)return $("Error finding orphaned missions:",n),0;if(!t||t.length===0)return T("No orphaned missions found"),0;const o=t.map(i=>i.id),{error:s}=await _.from("missions").delete().in("id",o);return s?($("Error deleting orphaned missions:",s),0):(he(`ðŸ§¹ Cleaned up ${t.length} orphaned missions`),t.length)}catch(t){return $("Error in cleanupOrphanedMissions:",t),0}}function lt({unsyncedCount:t,syncing:n,onSync:o}){const{t:s}=R(),i=async()=>{try{const r=await ct();r>0?(U.success(`Cleaned up ${r} orphaned missions`),o()):U.info("No orphaned missions found")}catch{U.error("Failed to cleanup orphaned missions")}};return t===0?null:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:o,disabled:n||!navigator.onLine,className:"flex items-center gap-2",children:[n?e.jsx(K,{className:"h-4 w-4 animate-spin"}):navigator.onLine?e.jsx(K,{className:"h-4 w-4"}):e.jsx(Pe,{className:"h-4 w-4"}),s("history.sync")," (",t,")"]}),navigator.onLine&&e.jsx(F,{variant:"ghost",size:"sm",onClick:i,disabled:n,className:"flex items-center gap-2",title:"Clean up orphaned missions",children:e.jsx(pe,{className:"h-4 w-4"})})]})}function dt(){const t=x.useCallback(async o=>{const s={},i=o.measurements.find(r=>r.latitude&&r.longitude);if(!i?.latitude||!i?.longitude)return T(),s;try{if(o.weatherDataId)console.log("â„¹ï¸ Mission already has weather data:",o.id);else{console.log("ðŸ”„ Fetching weather for mission:",o.id);const{data:r,error:l}=await _.functions.invoke("fetch-weather",{body:{latitude:i.latitude,longitude:i.longitude,timestamp:o.startTime.toISOString()}});!l&&r?.weatherData?(s.weatherDataId=r.weatherData.id,T("âœ… Weather data fetched for mission:",o.id,"weatherId:",s.weatherDataId)):$("âŒ Failed to fetch weather data:",l)}if(s.weatherDataId){console.log("ðŸ’¾ Updating mission in database:",o.id,"with weather ID:",s.weatherDataId);const{error:r}=await _.from("missions").update({weather_data_id:s.weatherDataId}).eq("id",o.id);r?(console.error("âŒ Database update failed:",r),$("âŒ Failed to update mission with enriched data:",r)):(console.log("âœ… Database update successful for mission:",o.id),T("âœ… Mission updated with enriched data:",o.id))}else console.log("âš ï¸ No weather data to update for mission:",o.id)}catch(r){$("âŒ Error enriching mission:",r)}return s},[]),n=x.useCallback(async()=>{try{const{data:o,error:s}=await _.from("missions").select(`
          id, name, start_time, weather_data_id
        `).is("weather_data_id",null).limit(20);if(s){$("âŒ Error fetching missions to enrich:",s);return}if(!o?.length){T("â„¹ï¸ No missions found that need enrichment");return}const i=[];for(const r of o){const{data:l}=await _.from("measurements").select("latitude, longitude").eq("mission_id",r.id).not("latitude","is",null).not("longitude","is",null).limit(1);l?.length>0&&i.push({...r,measurements:l})}if(i.length===0){T("â„¹ï¸ No missions found with location data that need enrichment");return}T(`ðŸ”„ Enriching ${i.length} missions...`);for(const r of i)if(r.measurements?.[0]){const l={id:r.id,startTime:new Date(r.start_time),weatherDataId:r.weather_data_id,measurements:[{id:"temp",timestamp:new Date(r.start_time),pm1:0,pm25:0,pm10:0,latitude:r.measurements[0].latitude,longitude:r.measurements[0].longitude}]};await t(l),await new Promise(g=>setTimeout(g,1e3))}T("âœ… Mission enrichment completed")}catch(o){$("âŒ Error in batch mission enrichment:",o)}},[t]);return{enrichMissionWithWeatherAndAirQuality:t,enrichAllMissionsWithMissingData:n}}function mt(){const[t,n]=x.useState(!0),[o,s]=x.useState(!1),[i,r]=x.useState([]),{toast:l}=ae(),{enrichAllMissionsWithMissingData:g}=dt(),h=x.useCallback(async()=>{try{n(!0);const u=await Q.getAllMissions();r(u)}catch(u){console.error("Error loading missions:",u),l({title:"Erreur",description:"Impossible de charger les missions",variant:"destructive"})}finally{n(!1)}},[l]),f=x.useCallback(async()=>{if(!navigator.onLine){l({title:"Hors ligne",description:"Connexion internet requise pour synchroniser",variant:"destructive"});return}try{s(!0),await Q.syncPendingMissions(),await h(),l({title:"Synchronisation rÃ©ussie",description:"Toutes les donnÃ©es ont Ã©tÃ© synchronisÃ©es"})}catch(u){console.error("Sync error:",u),l({title:"Erreur de synchronisation",description:"Impossible de synchroniser les donnÃ©es",variant:"destructive"})}finally{s(!1)}},[h,l]),w=x.useCallback(async u=>{try{await Q.deleteMission(u),r(j=>j.filter(y=>y.id!==u)),l({title:"Mission supprimÃ©e",description:"La mission a Ã©tÃ© supprimÃ©e avec succÃ¨s"})}catch(j){console.error("Delete error:",j),l({title:"Erreur",description:"Impossible de supprimer la mission",variant:"destructive"})}},[l]),M=x.useCallback(async u=>{try{await Q.exportMissionToCSV(u),l({title:"Export rÃ©ussi",description:`"${u.name}" exportÃ© en CSV`})}catch(j){console.error("Export error:",j),l({title:"Erreur d'export",description:"Impossible d'exporter la mission",variant:"destructive"})}},[l]),m=x.useCallback(async(u,j)=>{const y=v=>{const C=new Date,a=new Date(C.getFullYear(),C.getMonth(),C.getDate()),p=new Date(a.getTime()-24*60*60*1e3),b=new Date(v.getFullYear(),v.getMonth(),v.getDate());return b.getTime()===a.getTime()?"Aujourd'hui":b.getTime()===p.getTime()?"Hier":v.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})},S=v=>{const C=Math.floor(v/60),a=v%60;return C>0?`${C}h ${a}min`:`${a} min`},E=`Mission PMScan: ${u.name}
Date: ${y(new Date(u.startTime))}
DurÃ©e: ${S(u.durationMinutes)}
PM2.5 moyenne: ${Math.round(u.avgPm25)} Âµg/mÂ³
${u.locationContext?`Lieu: ${u.locationContext}`:""}
${u.activityContext?`ActivitÃ©: ${u.activityContext}`:""}`;try{if(j==="native"&&navigator.share)await navigator.share({title:`Mission PMScan: ${u.name}`,text:E}),l({title:"PartagÃ©",description:"Mission partagÃ©e avec succÃ¨s"});else if(j==="email"){const v=encodeURIComponent(`Mission PMScan: ${u.name}`),C=encodeURIComponent(E);window.open(`mailto:?subject=${v}&body=${C}`)}else if(j==="sms"){const v=encodeURIComponent(E);window.open(`sms:?body=${v}`)}else await navigator.clipboard.writeText(E),l({title:"CopiÃ©",description:"DonnÃ©es copiÃ©es dans le presse-papiers"})}catch(v){console.error("Share error:",v);try{await navigator.clipboard.writeText(E),l({title:"CopiÃ©",description:"DonnÃ©es copiÃ©es dans le presse-papiers"})}catch{l({title:"Erreur de partage",description:"Impossible de partager la mission",variant:"destructive"})}}},[l]),c=x.useCallback(async()=>{if(!navigator.onLine){l({title:"Hors ligne",description:"Connexion internet requise pour enrichir les missions",variant:"destructive"});return}try{await g(),await h()}catch(u){console.error("Enrichment error:",u),l({title:"Erreur d'enrichissement",description:"Impossible d'enrichir les missions",variant:"destructive"})}},[g,h,l]);return{missions:i,loading:t,syncing:o,loadMissions:h,handleSync:f,handleDelete:w,handleExport:M,handleShare:m,handleEnrichMissions:c}}function ut(t){const{t:n}=R(),o=i=>{const r=Math.floor(i/60),l=i%60;return r>0?`${r}h ${l}min`:`${l} min`};return x.useMemo(()=>{if(t.length===0)return[{label:n("history.stats.totalExposure"),value:"0 min",color:"default"},{label:n("history.stats.averagePM25"),value:0,unit:"Âµg/mÂ³",color:"default"},{label:n("history.stats.pm25AboveWHO"),value:"0 min",color:"default"},{label:n("history.stats.pm10AboveWHO"),value:"0 min",color:"default"}];const i=t.reduce((m,c)=>m+(c.actualRecordingMinutes||c.durationMinutes),0),r=t.reduce((m,c)=>{const u=c.actualRecordingMinutes||c.durationMinutes;return m+c.avgPm25*u},0),l=t.reduce((m,c)=>m+(c.actualRecordingMinutes||c.durationMinutes),0),g=l>0?r/l:0,h=t.reduce((m,c)=>{if(!c.measurements||c.measurements.length===0)return c.avgPm25>15?m+(c.actualRecordingMinutes||c.durationMinutes):m;const j=(c.actualRecordingMinutes||c.durationMinutes)/c.measurements.length,y=c.measurements.filter(S=>S.pm25>15).length;return m+y*j},0),f=t.reduce((m,c)=>{if(!c.measurements||c.measurements.length===0)return c.avgPm10>45?m+(c.actualRecordingMinutes||c.durationMinutes):m;const j=(c.actualRecordingMinutes||c.durationMinutes)/c.measurements.length,y=c.measurements.filter(S=>S.pm10>45).length;return m+y*j},0),w=m=>m<=12?"good":m<=35?"moderate":(m<=55,"poor"),M=(m,c)=>{const u=c>0?m/c*100:0;return u<=10?"good":u<=30?"moderate":"poor"};return[{label:n("history.stats.totalExposure"),value:o(Math.round(i)),color:"default"},{label:n("history.stats.averagePM25"),value:Math.round(g),unit:"Âµg/mÂ³",color:w(g)},{label:n("history.stats.pm25AboveWHO"),value:o(Math.round(h)),color:M(h,i)},{label:n("history.stats.pm10AboveWHO"),value:o(Math.round(f)),color:M(f,i)}]},[t,n])}function ta(){const{t}=R(),[n,o]=x.useState(new Date),[s,i]=x.useState("day"),{missions:r,loading:l,syncing:g,loadMissions:h,handleSync:f,handleDelete:w,handleExport:M,handleShare:m,handleEnrichMissions:c}=mt();x.useEffect(()=>{h()},[h]);const[u,j]=x.useState(!1),[y,S]=x.useState(!1);x.useEffect(()=>{if(r.length>0&&navigator.onLine&&!u&&!y){const d=r.filter(A=>A.synced&&!A.weatherDataId);d.length>0&&(console.log(`Found ${d.length} missions that need enrichment`),j(!0),S(!0),c().then(()=>{h()}).finally(()=>{j(!1)}))}},[r,c,h,u,y]);const E=x.useMemo(()=>{let d,A;switch(s){case"day":d=Ie(n),A=Oe(n);break;case"week":d=Fe(n,{weekStartsOn:1}),A=Le(n,{weekStartsOn:1});break;case"month":d=$e(n),A=_e(n);break;case"year":d=Ae(n),A=Te(n);break;default:return r}return r.filter(N=>{const k=new Date(N.startTime);return He(k,{start:d,end:A})})},[r,n,s]),v=ut(E),C=r.filter(d=>!d.synced).length,[a,p]=x.useState(ee());x.useEffect(()=>{const d=setInterval(()=>{p(ee())},1e4);return()=>clearInterval(d)},[]);const b=()=>{switch(s){case"day":return t("history.periods.day");case"week":return t("history.periods.week");case"month":return t("history.periods.month");case"year":return t("history.periods.year");default:return"PÃ©riode"}};return e.jsxs("main",{role:"main",className:"min-h-screen bg-background px-4 py-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground mb-6",children:t("history.title","Mission History")}),e.jsx("div",{className:"flex items-center justify-end mb-6",children:e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(lt,{unsyncedCount:C,syncing:g,onSync:f})})}),a.length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-card rounded-lg border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Me,{className:"h-5 w-5 text-warning"}),e.jsx("h3",{className:"font-medium text-foreground",children:t("sync.pendingFiles","Pending Sync Files")}),e.jsx(z,{variant:"secondary",children:a.length})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:t("sync.pendingFilesDesc","These CSV files are waiting to be synced to the server. They will be automatically retried when connection improves.")}),e.jsxs("div",{className:"grid gap-2 max-h-32 overflow-y-auto",children:[a.slice(0,5).map(d=>e.jsxs("div",{className:"flex items-center justify-between text-sm bg-muted/50 rounded px-3 py-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"font-medium",children:d.filename}),e.jsx("span",{className:"text-muted-foreground ml-2",children:d.timestamp.toLocaleString()})]}),(d.retryCount||0)>0&&e.jsxs(z,{variant:"outline",className:"text-xs",children:[d.retryCount," retries"]})]},d.filename)),a.length>5&&e.jsxs("div",{className:"text-center text-sm text-muted-foreground",children:["+",a.length-5," more files..."]})]})]}),e.jsx(ge,{selectedDate:n,onDateChange:o,selectedPeriod:s,onPeriodChange:i,className:"mb-6"}),e.jsx(at,{title:`${t("history.summary")} - ${b()}`,stats:v,className:"mb-6"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:t("history.recentMissions")}),l?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:t("history.loadingMissions")})]}):E.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(oe,{className:"h-16 w-16 mx-auto text-muted-foreground opacity-50 mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:t("history.noMissionsForPeriod")}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:t("history.selectAnotherDate")})]}):E.map(d=>e.jsx(ot,{mission:d,onExport:M,onDelete:w,onShare:m},d.id))]})]})}export{ta as default};
