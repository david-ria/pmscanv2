import{r as c}from"./vendor-CRCfYjC_.js";import{supabase as n}from"./client-zGYq1VIw.js";import{u as G,a as q}from"./index-DnKT6hDb.js";const L=()=>{const[m,g]=c.useState([]),[w,h]=c.useState(!0),[l,u]=c.useState(null),{toast:o}=G(),{user:p}=q(),f=c.useRef(!1),i=c.useRef(0),e=3,r=c.useCallback(async(t=!1)=>{if(!p?.id){g([]),h(!1),u(null),f.current=!0;return}if(t&&i.current>=e){u("Max retries exceeded"),h(!1);return}try{u(null);const{data:s,error:a}=await n.from("groups").select("*");if(a)throw a;const{data:b,error:E}=await n.from("group_memberships").select("group_id, role, user_id");if(E)throw E;const I=s?.map(F=>{const k=b?.find(S=>S.group_id===F.id&&S.user_id===p.id),M=b?.filter(S=>S.group_id===F.id).length||0;return{...F,role:k?.role,member_count:M}})||[];g(I),f.current=!0,i.current=0}catch(s){t?(i.current++,setTimeout(()=>r(!0),Math.pow(2,i.current)*1e3)):o({title:"Error",description:"Failed to fetch groups",variant:"destructive"}),u(s instanceof Error?s.message:"An unknown error occurred")}finally{h(!1)}},[o,p?.id,e]),v=c.useCallback(async(t,s)=>{try{const{data:a}=await n.auth.getUser();if(!a.user)throw new Error("Not authenticated");const{data:b,error:E}=await n.from("groups").insert({name:t,description:s,created_by:a.user.id}).select().single();if(E)throw E;return o({title:"Success",description:"Group created successfully"}),await r(),b}catch(a){throw o({title:"Error",description:a instanceof Error?a.message:"Failed to create group",variant:"destructive"}),a}},[r,o]),_=c.useCallback(async(t,s)=>{try{const{error:a}=await n.from("groups").update(s).eq("id",t);if(a)throw a;o({title:"Success",description:"Group updated successfully"}),await r()}catch(a){throw o({title:"Error",description:a instanceof Error?a.message:"Failed to update group",variant:"destructive"}),a}},[r,o]),y=c.useCallback(async t=>{try{const{error:s}=await n.from("groups").delete().eq("id",t);if(s)throw s;o({title:"Success",description:"Group deleted successfully"}),await r()}catch(s){throw o({title:"Error",description:s instanceof Error?s.message:"Failed to delete group",variant:"destructive"}),s}},[r,o]),d=c.useCallback(async t=>{try{const{data:s}=await n.auth.getUser();if(!s.user)throw new Error("Not authenticated");const{error:a}=await n.from("group_memberships").delete().eq("group_id",t).eq("user_id",s.user.id);if(a)throw a;o({title:"Success",description:"Left group successfully"}),await r()}catch(s){throw o({title:"Error",description:s instanceof Error?s.message:"Failed to leave group",variant:"destructive"}),s}},[r,o]);return c.useEffect(()=>{p?.id&&!f.current&&r(),p?.id||(f.current=!1,i.current=0)},[p?.id,r]),{groups:m,loading:w,error:l,createGroup:v,updateGroup:_,deleteGroup:y,leaveGroup:d,refetch:r}},P=m=>{const[g,w]=c.useState([]),[h,l]=c.useState(!0),{toast:u}=G(),o=async()=>{try{const{data:i,error:e}=await n.from("group_memberships").select("id, group_id, user_id, role, joined_at").eq("group_id",m);if(e)throw e;if(i&&i.length>0){const r=i.map(d=>d.user_id),{data:v,error:_}=await n.from("profiles").select("id, first_name, last_name, pseudo").in("id",r);if(_)throw _;const y=i.map(d=>{const t=v?.find(s=>s.id===d.user_id);return{id:d.id,group_id:d.group_id,user_id:d.user_id,role:d.role,joined_at:d.joined_at,user_profile:t||null}});w(y)}else w([])}catch(i){console.error("Error fetching group members:",i),u({title:"Error",description:"Failed to fetch group members",variant:"destructive"})}finally{l(!1)}},p=async(i,e)=>{try{const{error:r}=await n.from("group_memberships").update({role:e}).eq("id",i);if(r)throw r;u({title:"Success",description:"Member role updated successfully"}),await o()}catch(r){throw u({title:"Error",description:r instanceof Error?r.message:"Failed to update member role",variant:"destructive"}),r}},f=async i=>{try{const{error:e}=await n.from("group_memberships").delete().eq("id",i);if(e)throw e;u({title:"Success",description:"Member removed successfully"}),await o()}catch(e){throw u({title:"Error",description:e instanceof Error?e.message:"Failed to remove member",variant:"destructive"}),e}};return c.useEffect(()=>{m&&o()},[m]),{members:g,loading:h,updateMemberRole:p,removeMember:f,refetch:o}},R=()=>{const[m,g]=c.useState([]),[w,h]=c.useState(!0),{toast:l}=G(),u=async()=>{try{const{data:i,error:e}=await n.from("group_invitations").select("*").eq("status","pending").gt("expires_at",new Date().toISOString());if(e)throw e;const r=[...new Set(i?.map(t=>t.group_id)||[])],v=[...new Set(i?.map(t=>t.inviter_id)||[])],[_,y]=await Promise.all([r.length>0?n.from("groups").select("id, name, description").in("id",r):Promise.resolve({data:[]}),v.length>0?n.from("profiles").select("id, first_name, last_name, pseudo").in("id",v):Promise.resolve({data:[]})]),d=i?.map(t=>({id:t.id,group_id:t.group_id,inviter_id:t.inviter_id,invitee_email:t.invitee_email,invitee_id:t.invitee_id,status:t.status,token:t.token,expires_at:t.expires_at,created_at:t.created_at,group:_.data?.find(s=>s.id===t.group_id)||null,inviter_profile:y.data?.find(s=>s.id===t.inviter_id)||null}))||[];g(d)}catch{l({title:"Error",description:"Failed to fetch invitations",variant:"destructive"})}finally{h(!1)}},o=async(i,e)=>{try{const{error:r}=await n.functions.invoke("send-group-invitation",{body:{groupId:i,email:e}});if(r)throw r;l({title:"Success",description:"Invitation sent successfully"})}catch(r){throw l({title:"Error",description:r instanceof Error?r.message:"Failed to send invitation",variant:"destructive"}),r}},p=async i=>{try{const{error:e}=await n.functions.invoke("accept-group-invitation",{body:{token:i}});if(e)throw e;l({title:"Success",description:"Invitation accepted successfully"}),await u()}catch(e){throw l({title:"Error",description:e instanceof Error?e.message:"Failed to accept invitation",variant:"destructive"}),e}},f=async i=>{try{const{error:e}=await n.functions.invoke("decline-group-invitation",{body:{token:i}});if(e)throw e;l({title:"Success",description:"Invitation declined"}),await u()}catch(e){throw l({title:"Error",description:e instanceof Error?e.message:"Failed to decline invitation",variant:"destructive"}),e}};return c.useEffect(()=>{u()},[]),{invitations:m,loading:w,sendInvitation:o,acceptInvitation:p,declineInvitation:f,refetch:u}};export{R as a,P as b,L as u};
