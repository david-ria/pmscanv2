import{d as e,o as h,p as k}from"./index-DnKT6hDb.js";import{addTrackDataSources as v,addTrackLayers as b}from"./mapLayers-C3VFlJvJ.js";import{a as y}from"./mapEventHandlers-CHIiS9qu.js";import{M as m}from"./mapStyles-CsZyDteM.js";import"./supabase--OITQzG1.js";import"./vendor-CRCfYjC_.js";import"./query-BewfWFH7.js";import"./router-D6wdMmGF.js";import"./theme-D-6-9UvQ.js";import"./ui-core-CibF-ClQ.js";import"./utils-EL5wpLGY.js";import"./notifications-6vUXhpBr.js";import"./i18n-DZz6YkIP.js";const u="pmscan_map_state",z=t=>{try{const o={center:[t.getCenter().lng,t.getCenter().lat],zoom:t.getZoom(),pitch:t.getPitch()};localStorage.setItem(u,JSON.stringify(o))}catch(o){console.warn("Failed to save map state:",o)}},w=()=>{try{const t=localStorage.getItem(u);if(t){const o=JSON.parse(t);if(o.center&&o.zoom!==void 0&&o.pitch!==void 0)return o}}catch(t){console.warn("Failed to load map state:",t)}return null},x=t=>{const o=()=>z(t);return t.on("moveend",o),t.on("zoomend",o),t.on("pitchend",o),()=>{t.off("moveend",o),t.off("zoomend",o),t.off("pitchend",o)}},H=async(t,o,g,f,d)=>{try{e("ðŸ—ºï¸ Starting map initialization..."),e("ðŸ—ºï¸ Container element:",t),e("ðŸ—ºï¸ Current location:",o),e("ðŸ—ºï¸ Step 1: Loading Mapbox GL and Supabase dynamically...");const[r,S]=await Promise.all([h(),k()]),{supabase:M}=S;e("ðŸ—ºï¸ Step 2: Requesting Mapbox token from edge function...");const{data:i,error:s}=await M.functions.invoke("get-mapbox-token");if(e("ðŸ—ºï¸ Step 3: Edge function response received:",{data:i,error:s}),s)throw console.error("ðŸ—ºï¸ âŒ Edge function error:",s),new Error(`Edge function error: ${s.message||s}`);if(!i?.token)throw console.error("ðŸ—ºï¸ âŒ No token in response:",i),new Error("No Mapbox token received from edge function");e("ðŸ—ºï¸ âœ… Successfully received Mapbox token"),e("ðŸ—ºï¸ Token length:",i.token?.length),e("ðŸ—ºï¸ Step 4: Setting Mapbox access token..."),r.accessToken=i.token,e("ðŸ—ºï¸ Step 4: Determining map initial state...");let c,p,l=0;if(o)c=[o.longitude,o.latitude],p=15,e("ðŸ—ºï¸ Using current location for map center");else{const n=w();n?(c=n.center,p=n.zoom,l=n.pitch,e("ðŸ—ºï¸ Using saved map state:",n)):(c=[2.3522,48.8566],p=10,e("ðŸ—ºï¸ Using default map center (Paris)"))}e("ðŸ—ºï¸ Step 5: Creating Mapbox map instance..."),e("ðŸ—ºï¸ Map style:",m.LIGHT),e("ðŸ—ºï¸ Map center:",c),e("ðŸ—ºï¸ Map zoom:",p),e("ðŸ—ºï¸ Map pitch:",l);const a=new r.Map({container:t,style:m.LIGHT,center:c,zoom:p,pitch:l});return e("ðŸ—ºï¸ âœ… Map instance created successfully"),e("ðŸ—ºï¸ Map object:",a),a.addControl(new r.NavigationControl({visualizePitch:!0}),"top-right"),a.addControl(new r.ScaleControl({maxWidth:80,unit:"metric"})),a.on("load",()=>{v(a),b(a,g),y(a),x(a),e("ðŸ—ºï¸ âœ… Map state persistence setup complete"),f()}),a.on("error",n=>{console.error("Map error:",n),d("Map failed to load")}),a}catch(r){return console.error("Failed to initialize map:",r),d("Failed to initialize map. Please check your connection."),null}};export{H as initializeMap};
