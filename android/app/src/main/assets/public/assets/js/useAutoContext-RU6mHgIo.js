const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web-Q3wcRYyS.js","assets/js/bluetooth-BEoGU70i.js","assets/js/supabase--OITQzG1.js","assets/js/vendor-CRCfYjC_.js","assets/js/tensorflow-BraJP5VG.js"])))=>i.map(i=>d[i]);
import{_ as N}from"./supabase--OITQzG1.js";import{r as c}from"./vendor-CRCfYjC_.js";import{A as S,a as De,c as Ee}from"./UnifiedDataProvider-D_wn4Ile.js";import{supabase as x}from"./client-zGYq1VIw.js";import{d as v,e as b}from"./index-DnKT6hDb.js";import{u as Me}from"./useSubscription-DJEgHQrc.js";import{r as We,C as Te,B as Z}from"./bluetooth-BEoGU70i.js";class xe{config;logCounts=new Map;lastLogTime=new Map;constructor(t={}){this.config={level:"warn",enableInProduction:!1,prefix:"[APP]",enablePerformanceTracking:!0,...t}}shouldLog(t){const e={debug:0,info:1,warn:2,error:3};return this.config.enableInProduction?e[t]>=e[this.config.level]:t==="error"}formatMessage(t,e,...i){const n=new Date().toISOString();return[`${this.config.prefix} [${t.toUpperCase()}] ${n} ${e}`,...i]}rateLimitedLog(t,e,i,n,...g){if(!this.shouldLog(i))return;const h=Date.now(),d=this.lastLogTime.get(t)||0;if(h-d>=e){const m=this.logCounts.get(t)||0;this.logCounts.set(t,m+1),this.lastLogTime.set(t,h);const w=m>0?`${n} (${m} similar messages suppressed)`:n;this.log(i,w,...g),this.logCounts.set(t,0)}else this.logCounts.set(t,(this.logCounts.get(t)||0)+1)}log(t,e,...i){if(!this.shouldLog(t))return;const n=this.formatMessage(t,e,...i);switch(t){case"debug":console.debug(...n);break;case"info":console.info(...n);break;case"warn":console.warn(...n);break;case"error":console.error(...n);break}}debug(t,...e){this.log("debug",t,...e)}info(t,...e){this.log("info",t,...e)}warn(t,...e){this.log("warn",t,...e)}error(t,...e){this.log("error",t,...e)}time(t){this.config.enablePerformanceTracking&&console.time(`${this.config.prefix} ${t}`)}timeEnd(t){this.config.enablePerformanceTracking&&console.timeEnd(`${this.config.prefix} ${t}`)}rateLimitedDebug(t,e,i,...n){this.rateLimitedLog(t,e,"debug",i,...n)}rateLimitedInfo(t,e,i,...n){this.rateLimitedLog(t,e,"info",i,...n)}rateLimitedWarn(t,e,i,...n){this.rateLimitedLog(t,e,"warn",i,...n)}}const pe=new xe({level:"warn",enableInProduction:!1,prefix:"[AirSentinels]",enablePerformanceTracking:!1}),P=(u,t,e,...i)=>pe.rateLimitedDebug(u,t,e,...i),Le=(u,t,e,...i)=>pe.rateLimitedWarn(u,t,e,...i),C={debug:(u,...t)=>{},info:(u,...t)=>{},performance:(u,t)=>{t()}};console.debug("[PERF] ðŸš€ Optimized logger initialized");class H{static instance;cache=new Map;CACHE_DURATION=15*60*1e3;static getInstance(){return H.instance||(H.instance=new H),H.instance}generateCacheKey(t,e,i){const n=i?i.toISOString().split("T")[0]:"current";return`${t.toFixed(4)}_${e.toFixed(4)}_${n}`}isCacheValid(t){return Date.now()<t.expires}async fetchWeatherData(t){const{latitude:e,longitude:i,timestamp:n}=t;if(!e||!i)return v(),null;const g=this.generateCacheKey(e,i,n),h=this.cache.get(g);if(h&&this.isCacheValid(h))return v(),h.data;try{v("ðŸŒ¤ï¸ Fetching weather data for location:",{latitude:e,longitude:i});const{data:d,error:m}=await x.functions.invoke("fetch-weather",{body:{latitude:e,longitude:i,timestamp:n?n.toISOString():new Date().toISOString()}});return m?(b("âŒ Error fetching weather data:",m),null):d?.weatherData?(v("âœ… Weather data fetched successfully:",d.weatherData.id),this.cache.set(g,{data:d.weatherData,expires:Date.now()+this.CACHE_DURATION}),d.weatherData):null}catch(d){return b("âŒ Error in weather data fetch:",d),null}}async getWeatherForLocation(t,e){return this.fetchWeatherData({latitude:t.latitude,longitude:t.longitude,timestamp:e})}async getWeatherForMission(t){try{const e=t.measurements.find(n=>n.latitude&&n.longitude);if(!e?.latitude||!e?.longitude)return v("âŒ Cannot fetch weather for mission: no location data"),null;const i=await this.fetchWeatherData({latitude:e.latitude,longitude:e.longitude,timestamp:t.startTime});return i?(v("âœ… Weather data fetched for mission:",t.id),i.id):null}catch(e){return b("âŒ Error fetching weather for mission:",e),null}}async enrichMissionWithWeather(t){const e={};if(t.weatherDataId)return v("â„¹ï¸ Mission already has weather data:",t.id),e;try{const i=await this.getWeatherForMission(t);if(i){e.weatherDataId=i,v("ðŸ’¾ Updating mission in database with weather ID:",i);const{error:n}=await x.from("missions").update({weather_data_id:i}).eq("id",t.id);n?b("âŒ Failed to update mission with weather data:",n):v("âœ… Mission updated with weather data:",t.id)}}catch(i){b("âŒ Error enriching mission with weather:",i)}return e}async batchEnrichMissions(t=20){try{const{data:e,error:i}=await x.from("missions").select("id, name, start_time, weather_data_id").is("weather_data_id",null).limit(t);if(i){b("âŒ Error fetching missions to enrich:",i);return}if(!e?.length){v("â„¹ï¸ No missions found that need weather enrichment");return}v(`ðŸ”„ Enriching ${e.length} missions with weather data...`);for(const n of e){const{data:g}=await x.from("measurements").select("latitude, longitude, pm1, pm25, pm10, timestamp").eq("mission_id",n.id).not("latitude","is",null).not("longitude","is",null).limit(1);if(g?.length>0){const h={id:n.id,startTime:new Date(n.start_time),weatherDataId:n.weather_data_id,measurements:[{id:"temp",timestamp:new Date(n.start_time),pm1:0,pm25:0,pm10:0,latitude:g[0].latitude,longitude:g[0].longitude}]};await this.enrichMissionWithWeather(h),await new Promise(d=>setTimeout(d,1e3))}}v("âœ… Batch mission weather enrichment completed")}catch(e){b("âŒ Error in batch mission enrichment:",e)}}clearCache(){this.cache.clear(),v()}}const K=H.getInstance();function Pe(){const[u,t]=c.useState(null),[e,i]=c.useState(!1),n=c.useCallback(async(m,w)=>{i(!0);try{const k=await K.getWeatherForLocation(m,w);return t(k),k}finally{i(!1)}},[]),g=c.useCallback(async(m,w,k)=>{try{return(await K.fetchWeatherData({latitude:m,longitude:w,timestamp:k}))?.id||null}catch{return null}},[]),h=c.useCallback(async m=>K.enrichMissionWithWeather(m),[]),d=c.useCallback(async m=>K.batchEnrichMissions(m),[]);return{weatherData:u,isLoading:e,fetchWeatherForLocation:n,getWeatherIdForMeasurement:g,enrichMissionWithWeather:h,batchEnrichMissions:d}}const ye=[{key:"indoor",label:"Indoor"},{key:"outdoor",label:"Outdoor"},{key:"transport",label:"Transport"},{key:"walking",label:"Walking"},{key:"cycling",label:"Cycling"},{key:"undergroundTransport",label:"Underground transport"},{key:"sport",label:"Sport"},{key:"rest",label:"Rest"},{key:"work",label:"Work"}];ye.map(u=>u.key);const Oe=ye.map(u=>u.label),je=[{value:"1s",key:"every1s"},{value:"5s",key:"every5s"},{value:"10s",key:"every10s"},{value:"30s",key:"every30s"},{value:"1m",key:"every1m"},{value:"5m",key:"every5m"},{value:"10m",key:"every10m"}],ie={AUTO_CONTEXT_SETTINGS:"autoContextSettings",ALERT_SETTINGS:"alertSettings",GLOBAL_ALERTS_ENABLED:"globalAlertsEnabled",AIR_QUALITY_THRESHOLDS:"airQualityThresholds",WEATHER_LOGGING:"weatherLoggingEnabled",GEOHASH_SETTINGS:"geohashSettings",MISSIONS:"missions",PENDING_SYNC:"pendingSync",CRASH_RECOVERY:"crashRecoveryData",UNSENT_CSV:"unsentCSVData",MAP_STATE:"mapState",WIFI_TIME_TRACKING:"wifiTimeTracking",ACTIVE_GROUP_ID:"activeGroupId",GROUP_SETTINGS:"groupSettings"};class G{static instance;static getInstance(){return G.instance||(G.instance=new G),G.instance}get(t,e){try{const i=localStorage.getItem(t);if(i===null)return e?.defaultValue??null;if(e?.parser)return e.parser(i);try{return JSON.parse(i)}catch{return i}}catch(i){return b(`Failed to get storage item "${t}":`,i),e?.defaultValue??null}}set(t,e,i){try{const n=i?.serializer?i.serializer(e):JSON.stringify(e);return localStorage.setItem(t,n),!0}catch(n){return b(`Failed to set storage item "${t}":`,n),!1}}remove(t){try{return localStorage.removeItem(t),!0}catch(e){return b(`Failed to remove storage item "${t}":`,e),!1}}clear(){try{return localStorage.clear(),!0}catch(t){return b("Failed to clear localStorage:",t),!1}}exists(t){return localStorage.getItem(t)!==null}getSettings(t,e){const i=this.get(t);return i?{...e,...i}:e}setSettings(t,e){return this.set(t,e)}updateSettings(t,e,i){const g={...this.getSettings(t,i),...e};return this.setSettings(t,g)}getArray(t){return this.get(t)??[]}setArray(t,e){return this.set(t,e)}pushToArray(t,e){const i=this.getArray(t);return i.push(e),this.setArray(t,i)}removeFromArray(t,e){const n=this.getArray(t).filter(g=>!e(g));return this.setArray(t,n)}getBoolean(t,e=!1){const i=this.get(t);return i===null?e:i==="true"}setBoolean(t,e){return this.set(t,e.toString())}toggleBoolean(t,e=!1){const n=!this.getBoolean(t,e);return this.setBoolean(t,n),n}getKeys(){return Object.keys(localStorage)}getSize(){return this.getKeys().length}getUsedSpace(){let t=0;for(const e of this.getKeys()){const i=localStorage.getItem(e);i&&(t+=e.length+i.length)}return t}dump(){const t={};for(const e of this.getKeys())t[e]=this.get(e);return t}logStats(){v("ðŸ“Š Storage Stats:",{keys:this.getSize(),usedSpace:`${(this.getUsedSpace()/1024).toFixed(2)} KB`,availableKeys:Object.keys(ie)})}}const ee=G.getInstance();function ve(u,t){const[e,i]=c.useState(()=>ee.getSettings(u,t)),n=c.useCallback(h=>{const d={...e,...h};i(d),ee.setSettings(u,d)},[u,e]),g=c.useCallback(()=>{i(t),ee.setSettings(u,t)},[u,t]);return{settings:e,updateSettings:n,resetSettings:g}}const Je=()=>ve(ie.GEOHASH_SETTINGS,{enabled:!1,precision:8}),Fe=[{id:"driving-high-speed",name:"High-speed driving",description:"Very high speed movement (>30 km/h) indicates driving",priority:100,conditions:{movement:{speed:{min:30}}},result:"Driving"},{id:"driving-medium-speed",name:"Medium-speed driving",description:"Medium speed movement (>20 km/h) indicates vehicle transport",priority:95,conditions:{movement:{speed:{min:20}}},result:"Driving"},{id:"driving-sticky-unless-walk",name:"Driving sticky unless walking",description:"Stay Driving if previous was Driving and no walking signature",priority:96,conditions:{context:{latestContextStartsWith:"Driving"}},result:"Driving"},{id:"driving-redlight",name:"Driving red light / slow stop",description:"Remain Driving at very low speed if no walking signature",priority:94,conditions:{context:{latestContextStartsWith:"Driving"},location:{gpsQuality:"good"},movement:{speed:{max:5}}},result:"Driving"},{id:"driving-car-bluetooth",name:"Car bluetooth driving",description:"Car bluetooth connected with movement",priority:90,conditions:{connectivity:{carBluetooth:!0},movement:{speed:{min:5}}},result:"Driving"},{id:"outdoor-cycling",name:"Cycling",description:"Medium speed outdoor movement (8-19 km/h) without walking signature",priority:85,conditions:{location:{gpsQuality:"good"},movement:{speed:{min:8,max:19}}},result:"Outdoor cycling"},{id:"outdoor-jogging-accel",name:"Jogging",description:"Jogging speed (7-15 km/h) with walking signature",priority:82,conditions:{location:{gpsQuality:"good"},movement:{speed:{min:7,max:15}}},result:"Outdoor jogging"},{id:"outdoor-walking",name:"Walking",description:"Slow outdoor movement (2-7 km/h) with walking signature",priority:80,conditions:{location:{gpsQuality:"good"},movement:{speed:{min:2,max:7}}},result:"Outdoor walking"},{id:"wifi-work-hours",name:"Indoor work",description:"Connected to WiFi during working hours (weekdays 9-18), stationary",priority:70,conditions:{wifi:{known:!0},time:{hourRange:{start:9,end:18},isWeekend:!1},movement:{speed:{max:2}}},result:"Indoor at work"},{id:"wifi-home-evening",name:"Indoor home (evening)",description:"Connected to WiFi during evening hours (after 18:00), stationary",priority:65,conditions:{wifi:{known:!0},time:{hourRange:{start:18,end:23}},movement:{speed:{max:2}}},result:"Indoor at home"},{id:"wifi-home-morning",name:"Indoor home (morning)",description:"Connected to WiFi during morning hours (before 9:00), stationary",priority:65,conditions:{wifi:{known:!0},time:{hourRange:{start:6,end:9}},movement:{speed:{max:2}}},result:"Indoor at home"},{id:"wifi-home-weekend",name:"Indoor home (weekend)",description:"Connected to WiFi during weekends, stationary",priority:60,conditions:{wifi:{known:!0},time:{isWeekend:!0},movement:{speed:{max:2}}},result:"Indoor at home"},{id:"outdoor-stationary",name:"Outdoor stationary",description:"Good GPS signal, stationary, no WiFi",priority:55,conditions:{location:{gpsQuality:"good"},movement:{speed:{max:2}},wifi:{known:!1}},result:"Outdoor"},{id:"time-work-hours",name:"Work hours",description:"During work hours on weekdays, stationary",priority:45,conditions:{time:{hourRange:{start:9,end:18},isWeekend:!1},movement:{speed:{max:2}}},result:"At work"},{id:"time-evening-home",name:"Evening at home",description:"Evening hours, stationary",priority:40,conditions:{time:{hourRange:{start:18,end:23}},movement:{speed:{max:2}}},result:"At home"},{id:"time-morning-home",name:"Morning at home",description:"Early morning hours, stationary",priority:40,conditions:{time:{hourRange:{start:6,end:9}},movement:{speed:{max:2}}},result:"At home"},{id:"generic-indoor-wifi",name:"Generic indoor (WiFi)",description:"Connected to WiFi, stationary",priority:30,conditions:{wifi:{known:!0},movement:{speed:{max:2}}},result:"Indoor"},{id:"generic-outdoor-moving",name:"Generic outdoor (moving)",description:"Moving with good GPS, no WiFi",priority:25,conditions:{location:{gpsQuality:"good"},movement:{isMoving:!0},wifi:{known:!1}},result:"Outdoor"},{id:"generic-unknown",name:"Unknown context",description:"Cannot determine context",priority:10,conditions:{},result:"Unknown"}];function Re(u,t){const e=[...u].sort((i,n)=>n.priority-i.priority);for(const i of e)if(He(i,t))return i.result;return"Unknown"}function He(u,t){const e=u.conditions;if(e.wifi&&(e.wifi.home!==void 0&&e.wifi.home!==t.wifi.home||e.wifi.work!==void 0&&e.wifi.work!==t.wifi.work||e.wifi.known!==void 0&&e.wifi.known!==t.wifi.known)||e.location&&(e.location.insideHome!==void 0&&e.location.insideHome!==t.location.insideHome||e.location.insideWork!==void 0&&e.location.insideWork!==t.location.insideWork||e.location.gpsQuality!==void 0&&e.location.gpsQuality!==t.location.gpsQuality)||e.movement&&(e.movement.isMoving!==void 0&&e.movement.isMoving!==t.movement.isMoving||e.movement.speed&&(e.movement.speed.min!==void 0&&t.movement.speed<e.movement.speed.min||e.movement.speed.max!==void 0&&t.movement.speed>e.movement.speed.max)))return!1;const i=/with walking signature/i.test(u.description||""),n=/without walking signature/i.test(u.description||""),g=t.movement?.walkingSignature===!0;if(i&&!g||n&&g||u.id==="driving-sticky-unless-walk"&&g)return!1;if(e.time){const{hourRange:h,isWeekend:d}=e.time,m=t.time.currentHour;if(h){const{start:w,end:k}=h;if(w<=k){if(m<w||m>=k)return!1}else if(m<w&&m>=k)return!1}if(d!==void 0&&t.time.isWeekend!==d)return!1}if(e.connectivity&&(e.connectivity.cellularSignal!==void 0&&e.connectivity.cellularSignal!==t.connectivity.cellularSignal||e.connectivity.carBluetooth!==void 0&&e.connectivity.carBluetooth!==t.connectivity.carBluetooth))return!1;if(e.weather){if(e.weather.main!==void 0&&e.weather.main!==t.weather.main)return!1;if(e.weather.temperature){const h=t.weather.temperature;if(e.weather.temperature.min!==void 0&&h<e.weather.temperature.min||e.weather.temperature.max!==void 0&&h>e.weather.temperature.max)return!1}if(e.weather.humidity){const h=t.weather.humidity;if(e.weather.humidity.min!==void 0&&h<e.weather.humidity.min||e.weather.humidity.max!==void 0&&h>e.weather.humidity.max)return!1}}return!(e.context&&(e.context.previousWifi==="home"&&!t.wifi.previousSSID||e.context.previousWifi==="work"&&!t.wifi.previousSSID||e.context.latestContextStartsWith&&!t.context.latestContext.startsWith(e.context.latestContextStartsWith)))}const te=We("Motion",{android:()=>N(()=>import("./web-Q3wcRYyS.js"),__vite__mapDeps([0,1,2,3])).then(u=>new u.MotionWeb),ios:()=>N(()=>import("./web-Q3wcRYyS.js"),__vite__mapDeps([0,1,2,3])).then(u=>new u.MotionWeb),web:()=>N(()=>import("./web-Q3wcRYyS.js"),__vite__mapDeps([0,1,2,3])).then(u=>new u.MotionWeb)});function Ge(){const[u,t]=c.useState({}),[e,i]=c.useState({isLowAccuracy:!1}),[n,g]=c.useState(!1),h=c.useCallback(async()=>{try{if(g(!0),await te.addListener("accel",a=>{const s=a.acceleration.z;t(y=>({...y,acceleration_x:a.acceleration.x,acceleration_y:a.acceleration.y,acceleration_z:s,totalAcceleration_z:s,gravity_z:y.gravity_z?y.gravity_z*.8+s*.2:s}))}),await te.addListener("orientation",a=>{t(s=>({...s,rotationRate_x:a.alpha||0,rotationRate_y:a.beta||0,rotationRate_z:a.gamma||0}))}),"DeviceOrientationEvent"in window){const a=s=>{if(s.webkitCompassHeading!==void 0||s.alpha!==null){const y=s.webkitCompassHeading||s.alpha||0,E=s.beta||0,M=s.gamma||0;t(F=>({...F,magnetometer_x:Math.sin(y*Math.PI/180)*50,magnetometer_y:-Math.cos(y*Math.PI/180)*40+E*.5,magnetometer_z:Math.cos(E*Math.PI/180)*30+M*.3}))}};window.addEventListener("deviceorientationabsolute",a),window.addEventListener("deviceorientation",a)}v("ðŸŽ¯ Capteurs activÃ©s avec donnÃ©es rÃ©elles")}catch(a){b("âŒ Erreur activation capteurs:",a)}},[]),d=c.useCallback(async()=>{try{await te.removeAllListeners(),g(!1),v("ðŸ”‡ Capteurs dÃ©sactivÃ©s")}catch(a){b("âŒ Erreur dÃ©sactivation capteurs:",a)}},[]),m=c.useCallback(a=>{t(s=>({...s,referenceAltitude:a||0,barometer_relativeAltitude:0})),v("ðŸ“ RÃ©fÃ©rence altitude initialisÃ©e:",a||"sans GPS")},[]),w=c.useCallback(()=>{t(a=>{if(!a.acceleration_z||a.barometer_relativeAltitude===void 0)return a;const s=Math.abs(a.acceleration_z)>2?a.acceleration_z>0?.5:-.5:0,y=(a.barometer_relativeAltitude||0)+s;return{...a,barometer_relativeAltitude:Math.max(-20,Math.min(5,y))}})},[]),k=c.useCallback((a,s)=>{a!==void 0&&s&&s<20&&(t(y=>({...y,referenceAltitude:a,barometer_relativeAltitude:0})),v("ðŸ›°ï¸ Altitude GPS mise Ã  jour (surface):",a))},[]),A=c.useCallback(a=>{const s=!a||a>50;i({accuracy:a,isLowAccuracy:s})},[]),O=c.useCallback(a=>{const s=a.barometer_relativeAltitude,y=a.magnetometer_x,E=a.magnetometer_y,M=a.magnetometer_z,F=a.gravity_z,I=a.totalAcceleration_z;return s===void 0||y===void 0||E===void 0||M===void 0||F===void 0||I===void 0?(v(),"unknown"):s>-4&&y>5&&E<-40&&M>30&&I<-1?"escalator":s<-5&&s>-7&&y<0&&E<-30&&M>5&&I<-1?"stairs":s<-6&&y<-10&&E<-30&&M>15&&I>-1&&I<0?"stairs to outside":s<-8&&E<-30&&M<0&&I>-1.5&&I<0?"stand":s<-7&&F>0&&I>0?"stand platform":"unknown"},[]);return c.useEffect(()=>{if(n&&u.acceleration_z!==void 0){const a=setInterval(w,1e3);return()=>clearInterval(a)}},[n,u.acceleration_z,w]),c.useEffect(()=>()=>{d()},[d]),{sensorData:u,gpsAccuracy:e,isListening:n,startSensorListening:h,stopSensorListening:d,updateAltitudeFromGPS:k,updateGPSAccuracy:A,detectUndergroundActivity:O,initializeReference:m,updateRelativeAltitude:w}}class Ne{snapshot={walkingSignature:!1,walkingConfidence:0,lastUpdated:Date.now(),isActive:!1};emaG=0;alpha=.1;lastPeak=0;peakHistory=[];candidate=!1;candidateTrueSince=null;candidateFalseSince=null;highPassHistory=[];lastMotionEvent=0;timeoutId=null;async requestPermission(){if(typeof DeviceMotionEvent.requestPermission=="function")try{if(await DeviceMotionEvent.requestPermission()!=="granted")throw new Error("Permission denied for device motion")}catch(t){throw console.error("Failed to request device motion permission:",t),t}}async start(){await this.requestPermission(),window.addEventListener("devicemotion",this.onMotion,!0),this.snapshot.isActive=!0,this.startTimeoutMonitoring(),C.debug("MotionWalkingSignature started")}stop(){window.removeEventListener("devicemotion",this.onMotion,!0),this.stopTimeoutMonitoring(),this.emaG=0,this.peakHistory=[],this.highPassHistory=[],this.candidate=!1,this.candidateTrueSince=null,this.candidateFalseSince=null,this.snapshot={walkingSignature:!1,walkingConfidence:0,lastUpdated:Date.now(),isActive:!1},C.debug("MotionWalkingSignature stopped")}startTimeoutMonitoring(){this.stopTimeoutMonitoring(),this.timeoutId=window.setInterval(()=>{performance.now()-this.lastMotionEvent>S.ACC_TIMEOUT_MS&&(Le("accelerometer-timeout",3e4,"Accelerometer timeout - forcing walkingSignature to false"),this.snapshot.walkingSignature=!1,this.snapshot.isActive=!1,this.snapshot.lastUpdated=Date.now())},1e3)}stopTimeoutMonitoring(){this.timeoutId!==null&&(clearInterval(this.timeoutId),this.timeoutId=null)}onMotion=t=>{const e=performance.now();this.lastMotionEvent=e,this.snapshot.isActive=!0;const i=t.accelerationIncludingGravity?.x??0,n=t.accelerationIncludingGravity?.y??0,g=t.accelerationIncludingGravity?.z??0,h=Math.sqrt(i*i+n*n+g*g);this.emaG=(1-this.alpha)*this.emaG+this.alpha*h;const d=h-this.emaG;this.highPassHistory.push({value:d,timestamp:e}),this.highPassHistory=this.highPassHistory.filter(m=>e-m.timestamp<=S.ACC_WIN_SEC*1e3),d>S.ACC_PEAK_THR&&e-this.lastPeak>S.ACC_REFRAC_MS&&(this.peakHistory.push(e),this.lastPeak=e,this.peakHistory=this.peakHistory.filter(m=>e-m<=S.ACC_WIN_SEC*1e3)),this.evaluate(e)};evaluate(t){if(this.peakHistory.length<3){this.candidate=!1,this.updateHysteresis(t);return}const e=S.ACC_WIN_SEC,i=this.peakHistory.length/e*60,n=this.peakHistory.slice(1).map((a,s)=>(a-this.peakHistory[s])/1e3),g=n.reduce((a,s)=>a+s,0)/n.length,h=n.reduce((a,s)=>a+(s-g)**2,0)/n.length,d=Math.sqrt(h),m=g>0?d/g:1;let w=0;if(this.highPassHistory.length>0){const a=this.highPassHistory.reduce((s,y)=>s+y.value**2,0);w=Math.sqrt(a/this.highPassHistory.length)}const k=i>=S.ACC_CADENCE_MIN&&i<=S.ACC_CADENCE_MAX,A=m<=S.ACC_CV_MAX,O=w>=S.ACC_RMS_MIN&&w<=S.ACC_RMS_MAX;this.candidate=k&&A&&O,this.peakHistory.length>=3&&P("walking-detection",1e4,"Walking detection:",{cadence:i.toFixed(1),regularity:m.toFixed(3),intensity:w.toFixed(2),candidate:this.candidate}),this.updateHysteresis(t)}updateHysteresis(t){this.candidate?(this.candidateTrueSince||(this.candidateTrueSince=t),this.candidateFalseSince=null,(t-this.candidateTrueSince)/1e3>=S.ACC_HOLD_ENTER&&(this.snapshot.walkingSignature=!0)):(this.candidateFalseSince||(this.candidateFalseSince=t),this.candidateTrueSince=null,(t-this.candidateFalseSince)/1e3>=S.ACC_HOLD_EXIT&&(this.snapshot.walkingSignature=!1));const e=this.peakHistory.length>0?this.peakHistory.length/S.ACC_WIN_SEC*60:0;this.snapshot.walkingConfidence=Math.min(1,Math.max(0,e/S.ACC_CADENCE_MAX)),this.snapshot.lastUpdated=Date.now()}getSnapshot(){return{...this.snapshot}}}const Ue={enabled:!1,mlEnabled:!1,highAccuracy:!1,overrideContext:!1};function Ye(u=!0,t){const{settings:e,updateSettings:i}=ve(ie.AUTO_CONTEXT_SETTINGS,Ue),{features:n}=Me(),[g,h]=c.useState(""),[d,m]=c.useState(""),[w,k]=c.useState(""),[A,O]=c.useState(null),[a]=c.useState(()=>new Ne),[s,y]=c.useState(!1),E=De(u&&e.enabled&&!t,e.highAccuracy??!1),{locationEnabled:M,latestLocation:F,requestLocationPermission:I,speedKmh:L,gpsQuality:V}=E,ne=t||F,{weatherData:U}=Pe(),{sensorData:oe,updateGPSAccuracy:Se,updateAltitudeFromGPS:ke,detectUndergroundActivity:Ce,initializeReference:be}=Ge(),ae=c.useCallback(l=>{const o=l!==void 0?l:!e.enabled;o&&!n.canUseAutoContext||i({enabled:o})},[e.enabled,i,n.canUseAutoContext]);c.useEffect(()=>{(async()=>{try{const{data:{user:o}}=await x.auth.getUser();if(!o)return;const{data:r,error:f}=await x.from("profiles").select("home_wifi_ssid, work_wifi_ssid").eq("id",o.id).single();!f&&r&&i({homeWifiSSID:r.home_wifi_ssid||e.homeWifiSSID,workWifiSSID:r.work_wifi_ssid||e.workWifiSSID})}catch(o){console.error("Failed to load profile SSIDs",o)}})()},[]),c.useEffect(()=>{e.mlEnabled&&!A&&N(()=>import("./tensorflow-BraJP5VG.js"),__vite__mapDeps([4,3])).then(l=>{l.loadLayersModel("/model/model.json").then(O).catch(o=>{console.error("Failed to load ML model",o),O(null)})}).catch(l=>{console.error("Failed to load TensorFlow",l)})},[e.mlEnabled,A]);const q=c.useCallback(()=>{e.enabled&&!s&&(C.debug("Starting motion walking signature service"),a.start().catch(l=>{console.error("Failed to start motion walking signature:",l)}),y(!0))},[e.enabled,s,a]),$=c.useCallback(()=>{s&&(C.debug("Stopping motion walking signature service"),a.stop(),y(!1))},[s,a]);c.useEffect(()=>(!e.enabled&&s&&$(),()=>{s&&(a.stop(),y(!1))}),[e.enabled,s,$,a]);const R=c.useCallback(()=>{if(!navigator.onLine)return console.log("WiFi detection - offline, no connection"),"";const l=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(l){const o=l.type,r=l.effectiveType;if(P("autocontext-network",3e4,"Network connection details:",{type:o,effectiveType:r,downlink:l.downlink,rtt:l.rtt}),o==="wifi"||o==="ethernet")return P("autocontext-wifi",3e4,"WiFi connection detected"),"WiFi-Connection";if(o==="cellular")return P("autocontext-cellular",3e4,"Cellular connection detected"),"";if(r&&["4g","3g"].includes(r))return P("autocontext-highspeed",3e4,"High-speed connection, type unclear"),""}return P("autocontext-fallback",3e4,"Network API not available, not assuming WiFi"),""},[]),re=c.useCallback(async()=>{try{if(!Te.isNativePlatform())return C.debug("Web platform - using speed-based car detection"),!1;if(await Z.initialize(),!await Z.isEnabled())return C.debug("Bluetooth not enabled"),!1;const r=(await Z.getConnectedDevices([])).filter(D=>{const p=D.name?.toLowerCase()||"";return p.includes("car")||p.includes("auto")||p.includes("vehicle")||p.includes("honda")||p.includes("toyota")||p.includes("ford")||p.includes("bmw")||p.includes("audi")||p.includes("mercedes")||p.includes("volkswagen")||p.includes("nissan")||p.includes("mazda")||p.includes("hyundai")||p.includes("kia")||p.includes("lexus")||p.includes("acura")||p.includes("infiniti")}),f=r.length>0;return f&&C.debug("Car device connected",r[0].name),f}catch(l){return C.debug("Error checking car connection",l),!1}},[]),se=c.useCallback(()=>navigator.onLine&&!R(),[R]),Q=c.useCallback((l,o,r,f,D)=>{const T=(r-l)*Math.PI/180,z=(f-o)*Math.PI/180,B=Math.sin(T/2)*Math.sin(T/2)+Math.cos(l*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(z/2)*Math.sin(z/2);return 6371e3*(2*Math.atan2(Math.sqrt(B),Math.sqrt(1-B)))<=D},[]),ce=c.useCallback(async l=>{const o=await N(()=>import("./tensorflow-BraJP5VG.js"),__vite__mapDeps([4,3])),{location:r,speed:f=0,isMoving:D=!1}=l,p=d===e.homeWifiSSID?1:d===e.workWifiSSID?2:0,T=[r?.accuracy??0,f,D?1:0,p];return o.tensor2d([T])},[d,e.homeWifiSSID,e.workWifiSSID]),le=c.useCallback(l=>{if(!l)return{};const o=new Date().getHours(),r="wifiTimeTracking",f=JSON.parse(localStorage.getItem(r)||"{}");return f[l]||(f[l]={morning:0,workday:0,evening:0,weekend:0}),[0,6].includes(new Date().getDay())?f[l].weekend++:(o>=6&&o<10&&f[l].morning++,o>=9&&o<18&&f[l].workday++,(o>=18||o<6)&&f[l].evening++),localStorage.setItem(r,JSON.stringify(f)),f},[]),X=c.useCallback(async(l,o)=>{try{const{data:{user:r}}=await x.auth.getUser();if(!r)return;const{error:f}=await x.from("profiles").update({[l]:o}).eq("id",r.id);f&&console.error("Failed to persist SSID",f)}catch(r){console.error("Failed to persist SSID",r)}},[]),ue=c.useCallback(l=>{for(const[o,r]of Object.entries(l)){if(r.morning+r.workday+r.evening+r.weekend<10)continue;const D=r.morning>=3&&r.evening>=3||r.weekend>=5&&r.weekend>r.workday,p=r.workday>=8&&r.workday>(r.morning+r.evening)*1.5&&r.weekend<r.workday*.3;D&&o!==e.homeWifiSSID&&(C.debug(`Auto-detected HOME WiFi: ${o}`,{morning:r.morning,evening:r.evening,weekend:r.weekend}),i({homeWifiSSID:o}),X("home_wifi_ssid",o)),p&&o!==e.workWifiSSID&&o!==e.homeWifiSSID&&(C.debug(`Auto-detected WORK WiFi: ${o}`,{workday:r.workday,morning:r.morning,evening:r.evening}),i({workWifiSSID:o}),X("work_wifi_ssid",o))}},[e.homeWifiSSID,e.workWifiSSID,i,X]),de=c.useCallback(async l=>{if(!e.enabled)return"";const{location:o,speed:r=0}=l,f=new Date().getHours(),D=new Date().getDay(),p=D===0||D===6,T=R(),z=!!T;q(),P("autocontext-input-data",1e4,"AUTO-CONTEXT INPUT:",{location:o?`${o.latitude}, ${o.longitude}`:"none",speed:L,isMoving:L>2,hasWifi:!!T,currentHour:f,isWeekend:p,gpsQuality:V}),Se(o?.accuracy);const B=o?.accuracy&&o.accuracy<20,he=!o?.accuracy||o.accuracy>100;if(B&&o?.altitude!==void 0&&(ke(o.altitude,o.accuracy),be(o.altitude)),he&&e.enabled){const _=Ce(oe);if(_!=="unknown")switch(C.debug(`Underground transport detected: ${_}`,{gpsAccuracy:o?.accuracy||"none",relativeAltitude:oe.barometer_relativeAltitude}),_){case"escalator":case"stairs":case"stairs to outside":return"Underground Transport";case"stand":case"stand platform":return"Underground Station";default:return"Underground"}}const me=await re(),_e=se();let fe=!1,we=!1;o&&e.homeArea&&(fe=Q(o.latitude,o.longitude,e.homeArea.latitude,e.homeArea.longitude,e.homeArea.radius)),o&&e.workArea&&(we=Q(o.latitude,o.longitude,e.workArea.latitude,e.workArea.longitude,e.workArea.radius));const j={wifi:{home:!1,work:!1,known:z,currentSSID:T,previousSSID:d},location:{insideHome:fe,insideWork:we,gpsQuality:V},movement:{speed:L,isMoving:L>2,walkingSignature:a.getSnapshot().walkingSignature,dataQuality:Ee(V,a.getSnapshot().isActive)},time:{currentHour:f,isWeekend:p},connectivity:{cellularSignal:_e,carBluetooth:me},weather:{main:U?.weather_main||"Clear",temperature:U?.temperature||20,humidity:U?.humidity||50},context:{latestContext:w}},J=e.customRules&&e.customRules.length>0?e.customRules:Fe;let W=Re(J,j);if(console.log(`ðŸ“‹ AutoContext rule result: "${W}"`,{evaluationData:j,rulesCount:J.length,firstFewRules:J.slice(0,3).map(_=>({id:_.id,priority:_.priority,result:_.result}))}),e.mlEnabled&&A)try{const Y=(await N(()=>import("./tensorflow-BraJP5VG.js"),__vite__mapDeps([4,3]))).tidy(()=>{const Ae=ce({...l,isMoving:L>2}),Ie=A.predict(Ae).argMax(-1).dataSync()[0];return Oe[Ie]});Y&&(W=Y)}catch(_){console.error("ML prediction failed",_)}if(L>50){const _=W;W="Driving",_!==W&&C.debug(`Override context to ${W} due to very high speed: ${L} km/h`)}return C.info(`Final AutoContext result: "${W}"`),W},[e,d,w,U,R,se,Q,re,A,ce]);c.useEffect(()=>{if(!e.enabled||!u&&!t)return;const l=()=>{const r=R();if(r!==d){h(d),m(r);const f=le(r);ue(f)}};l();const o=setInterval(l,1e4);return()=>clearInterval(o)},[e.enabled,u,t,R,d,le,ue]);const ge=c.useCallback(l=>{l!==w&&k(l)},[w]);return c.useMemo(()=>({settings:e,updateSettings:i,toggleEnabled:ae,determineContext:de,updateLatestContext:ge,latestContext:w,isEnabled:e.enabled&&n.canUseAutoContext,mlEnabled:e.mlEnabled,highAccuracy:e.highAccuracy,latestLocation:ne,locationEnabled:t?!0:M,requestLocationPermission:I,startMotionServiceIfNeeded:q,stopMotionService:$}),[e,i,ae,de,ge,w,ne,M,I,q,$])}export{ie as S,Ye as a,Je as b,C as d,je as f,P as r,ve as u};
